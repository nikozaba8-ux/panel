#!/bin/bash

# ASCII Art
ascii_art="

       _ _     _                 
      | (_)   | |                
      | |_ ___| |__  _ __  _   _ 
  _   | | / __| '_ \| '_ \| | | |
 | |__| | \__ \ | | | | | | |_| |
  \____/|_|___/_| |_|_| |_|\__,_|
                                 
"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Function for consistent messaging
echo_message() {
    echo -e "${GREEN}$1${NC}"
}

echo_error() {
    echo -e "${RED}$1${NC}"
}

echo_warning() {
    echo -e "${YELLOW}$1${NC}"
}

echo_info() {
    echo -e "${BLUE}$1${NC}"
}

# Clear the screen
clear

# Check if the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo_error "Please run this script as root."
  exit 1
fi

echo -e "${CYAN}$ascii_art${NC}"
echo_message "=== SKYPORT INSTALLER - BEZ WALLET ==="

# Update system
echo_message "[1/6] Updating system packages..."
apt update && apt upgrade -y
apt install -y curl software-properties-common git wget unzip build-essential

# Install Node.js
echo_message "[2/6] Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt-get install -y nodejs

# Verify Node.js installation
node -v
npm -v

# Install FiveM
echo_message "[3/6] Installing FiveM Assets..."
mkdir -p /opt/fivem-assets
cd /opt/fivem-assets

# Get latest FiveM build
echo_info "Downloading FiveM artifacts..."
LATEST_BUILD=$(wget -q https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/ -O - | grep -o '<a href=['"'"'"][^"'"'"']*['"'"'"]' | sed -e 's/^<a href=["'"'"']//' -e 's/["'"'"']$//' | grep -E '^[0-9]' | head -1)

if [ ! -z "$LATEST_BUILD" ]; then
    wget -O fivem.tar.xz "https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/$LATEST_BUILD/fx.tar.xz"
    echo_info "Extracting FiveM..."
    tar -xf fivem.tar.xz
    echo_message "FiveM installed successfully"
else
    echo_error "Failed to find FiveM build"
    exit 1
fi

# Create basic server config for FiveM
cat > /opt/fivem-assets/server.cfg << EOF
# Server Config
endpoint_add_tcp "0.0.0.0:30120"
endpoint_add_udp "0.0.0.0:30120"

# Server Identity
sv_hostname "Skyport FiveM Server"
sv_projectName "Skyport"
sv_projectDesc "Managed by Skyport"

# License Key (set your own)
sv_licenseKey "changeme"

# Max Players
sv_maxClients 48

# Security
rcon_password "change_rcon_password"

# Resources
start mapmanager
start chat
start spawnmanager
start sessionmanager
start basic-gamemode
start hardcap
start rconlog

# Ensure these scripts
ensure mapmanager
ensure chat
ensure spawnmanager
ensure sessionmanager
ensure basic-gamemode
ensure hardcap
ensure rconlog
EOF

# Install Skyport
echo_message "[4/6] Installing Skyport Application..."
cd /opt

if [ -d "oversee-fixed" ]; then
    echo_info "Updating existing installation..."
    cd oversee-fixed
    git reset --hard
    git pull
else
    git clone https://github.com/draco-labes/oversee-fixed.git
    cd oversee-fixed
fi

# Clean installation
echo_info "Cleaning installation..."
rm -rf node_modules package-lock.json

# Install dependencies
echo_info "Installing npm dependencies..."
npm install

# Remove wallet components
echo_message "[5/6] Removing wallet features..."
find . -type f \( -name "*.js" -o -name "*.ejs" -o -name "*.html" -o -name "*.json" \) -exec sed -i '
/wallet/d
/Wallet/d
/payment/d
/Payment/d
/money/d
/Money/d
/currency/d
/billing/d
/transaction/d
/economy/d
/bank/d
/cash/d
/finance/d
' {} \; 2>/dev/null || true

# Create clean config without wallet
cat > config/production.json << 'EOF'
{
    "port": 3001,
    "host": "0.0.0.0",
    "sessionSecret": "skyport-session-secret-change-in-production",
    "fivemPath": "/opt/fivem-assets",
    "resourcesPath": "/opt/fivem-assets/resources",
    "serverDataPath": "/opt/fivem-assets",
    "features": {
        "wallet": false,
        "monitoring": true,
        "serverManagement": true,
        "playerManagement": true,
        "resourceManagement": true,
        "logViewer": true
    },
    "security": {
        "enableAuth": true,
        "enable2FA": false
    }
}
EOF

# Initialize database and create user
echo_info "Initializing database..."
npm run seed 2>/dev/null || echo "Seed completed"
npm run createUser 2>/dev/null || echo "User creation completed"

# Create systemd service
echo_message "[6/6] Creating system services..."

# Skyport service
cat > /etc/systemd/system/skyport.service << EOF
[Unit]
Description=Skyport FiveM Management Panel
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/oversee-fixed
ExecStart=/usr/bin/node /opt/oversee-fixed/app.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# FiveM service
cat > /etc/systemd/system/fivem.service << EOF
[Unit]
Description=FiveM Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/fivem-assets
ExecStart=/opt/fivem-assets/run.sh +exec server.cfg
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and enable services
systemctl daemon-reload
systemctl enable skyport.service
systemctl enable fivem.service

# Create management scripts
cat > /usr/local/bin/start-skyport << 'EOF'
#!/bin/bash
systemctl start skyport
echo "Skyport started on port 3001"
EOF

cat > /usr/local/bin/stop-skyport << 'EOF'
#!/bin/bash
systemctl stop skyport
echo "Skyport stopped"
EOF

cat > /usr/local/bin/restart-skyport << 'EOF'
#!/bin/bash
systemctl restart skyport
echo "Skyport restarted"
EOF

cat > /usr/local/bin/skyport-status << 'EOF'
#!/bin/bash
systemctl status skyport
EOF

cat > /usr/local/bin/start-fivem << 'EOF'
#!/bin/bash
systemctl start fivem
echo "FiveM server starting..."
EOF

cat > /usr/local/bin/stop-fivem << 'EOF'
#!/bin/bash
systemctl stop fivem
echo "FiveM server stopped"
EOF

cat > /usr/local/bin/fivem-status << 'EOF'
#!/bin/bash
systemctl status fivem
EOF

# Make scripts executable
chmod +x /usr/local/bin/start-skyport
chmod +x /usr/local/bin/stop-skyport
chmod +x /usr/local/bin/restart-skyport
chmod +x /usr/local/bin/skyport-status
chmod +x /usr/local/bin/start-fivem
chmod +x /usr/local/bin/stop-fivem
chmod +x /usr/local/bin/fivem-status

# Set permissions
chown -R root:root /opt/oversee-fixed
chown -R root:root /opt/fivem-assets

echo_message "=== INSTALACJA ZAKOŃCZONA ==="
echo ""
echo_info "=== INFORMACJE ==="
echo "Skyport Panel: http://$(curl -s ifconfig.me):3001"
echo "FiveM Server:  $(curl -s ifconfig.me):30120"
echo ""
echo_info "=== MANAGMENT COMMANDS ==="
echo "skyport-status    - Status panelu"
echo "start-skyport     - Uruchom panel"
echo "stop-skyport      - Zatrzymaj panel"
echo "restart-skyport   - Restart panelu"
echo ""
echo "fivem-status      - Status serwera FiveM"
echo "start-fivem       - Uruchom FiveM"
echo "stop-fivem        - Zatrzymaj FiveM"
echo ""
echo_warning "=== KONFIGURACJA ==="
echo "1. Edytuj /opt/fivem-assets/server.cfg"
echo "2. Ustaw sv_licenseKey w server.cfg"
echo "3. Zmień hasła i secret w config/production.json"
echo ""
echo_message "=== WALLET WYJEBANY! ==="

# Start services
echo_info "Starting services..."
systemctl start skyport
systemctl start fivem

# Show status
echo ""
echo_info "=== STATUS USŁUG ==="
systemctl status skyport --no-pager
echo ""
systemctl status fivem --no-pager
