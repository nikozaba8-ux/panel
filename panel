#!/bin/bash

# =============================================
# ğŸ¦– PANEL SERWERÃ“W - PRODUCTION
# =============================================

# Konfiguracja
PANEL_DIR="/home/panel"
SERVERS_DIR="$PANEL_DIR/servers"
LOGS_DIR="$PANEL_DIR/logs"
BACKUPS_DIR="$PANEL_DIR/backups"
CONFIG_DIR="$PANEL_DIR/config"
WEB_DIR="$PANEL_DIR/web"
USERS_FILE="$PANEL_DIR/users.db"
PANEL_PID_FILE="$PANEL_DIR/panel.pid"
WEB_PID_FILE="$PANEL_DIR/web.pid"
PORT=8080

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================
# ğŸ› ï¸ FUNKCJE POMOCNICZE
# =============================================

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

error() {
    echo -e "${RED}[BÅÄ„D]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

warning() {
    echo -e "${YELLOW}[OSTRZEÅ»ENIE]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

setup_directories() {
    mkdir -p "$SERVERS_DIR" "$LOGS_DIR" "$BACKUPS_DIR" "$CONFIG_DIR" "$WEB_DIR"
    log "Katalogi utworzone"
}

check_dependencies() {
    echo -e "${YELLOW}ğŸ” Sprawdzanie zaleÅ¼noÅ›ci...${NC}"
    local missing=()
    
    for cmd in nc screen java python3 curl; do
        if ! command -v $cmd &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        warning "BrakujÄ…ce zaleÅ¼noÅ›ci: ${missing[*]}"
        echo -e "${YELLOW}ğŸ“¦ Instalowanie brakujÄ…cych pakietÃ³w...${NC}"
        apt update > /dev/null 2>&1
        
        for pkg in "${missing[@]}"; do
            case $pkg in
                nc)
                    echo -e "${CYAN}Instalowanie: netcat-openbsd${NC}"
                    apt install -y netcat-openbsd > /dev/null 2>&1
                    ;;
                screen)
                    echo -e "${CYAN}Instalowanie: screen${NC}"
                    apt install -y screen > /dev/null 2>&1
                    ;;
                java)
                    echo -e "${CYAN}Instalowanie: default-jre${NC}"
                    apt install -y default-jre > /dev/null 2>&1
                    ;;
                python3)
                    echo -e "${CYAN}Instalowanie: python3${NC}"
                    apt install -y python3 > /dev/null 2>&1
                    ;;
                curl)
                    echo -e "${CYAN}Instalowanie: curl${NC}"
                    apt install -y curl > /dev/null 2>&1
                    ;;
            esac
        done
        
        echo -e "${GREEN}âœ… ZaleÅ¼noÅ›ci zainstalowane${NC}"
    else
        echo -e "${GREEN}âœ… Wszystkie zaleÅ¼noÅ›ci sÄ… dostÄ™pne${NC}"
    fi
}

# =============================================
# ğŸ® ZARZÄ„DZANIE SERWERAMI
# =============================================

create_server() {
    local name="$1"
    local type="$2"
    local port="$3"
    local memory="$4"
    local owner="$5"
    
    # DomyÅ›lne wartoÅ›ci
    port=${port:-25565}
    memory=${memory:-1024}
    owner=${owner:-admin}
    
    # Generuj ID
    local id=$(echo "$name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-')
    
    # SprawdÅº czy port jest wolny
    if nc -z localhost $port 2>/dev/null; then
        echo "ERROR: Port $port jest zajÄ™ty!"
        return 1
    fi
    
    # SprawdÅº czy serwer juÅ¼ istnieje
    if [ -d "$SERVERS_DIR/$id" ]; then
        echo "ERROR: Serwer o ID '$id' juÅ¼ istnieje!"
        return 1
    fi
    
    # UtwÃ³rz katalog serwera
    mkdir -p "$SERVERS_DIR/$id"
    
    # Zapisz konfiguracjÄ™
    cat > "$SERVERS_DIR/$id/server.conf" << CONF
ID="$id"
NAME="$name"
TYPE="$type"
PORT="$port"
MEMORY="$memory"
OWNER="$owner"
STATUS="stopped"
PID=""
CREATED="$(date '+%Y-%m-%d %H:%M:%S')"
CONF

    # UtwÃ³rz skrypt startowy
    case $type in
        minecraft)
            create_minecraft_server "$id" "$memory"
            ;;
        rust)
            create_rust_server "$id" "$port"
            ;;
        ark)
            create_ark_server "$id" "$port"
            ;;
        csgo)
            create_csgo_server "$id" "$port"
            ;;
        teamspeak)
            create_teamspeak_server "$id" "$port"
            ;;
        *)
            create_custom_server "$id"
            ;;
    esac
    
    log "Utworzono serwer: $name (ID: $id, Port: $port)"
    echo "SUCCESS: Serwer '$name' utworzony pomyÅ›lnie!"
    return 0
}

create_minecraft_server() {
    local id=$1
    local memory=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << 'START'
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera Minecraft $NAME..."
echo "Port: $PORT | RAM: ${MEMORY}MB"
java -Xmx${MEMORY}M -Xms${MEMORY}M -jar server.jar nogui
START
    
    chmod +x "$dir/start.sh"
    
    # Pobierz serwer Minecraft jeÅ›li nie istnieje
    if [ ! -f "$dir/server.jar" ]; then
        echo "Pobieranie serwera Minecraft..."
        wget -q -O "$dir/server.jar" "https://piston-data.mojang.com/v1/objects/8f3112a1049751cc472ec13e397eade5336ca7ae/server.jar"
        echo "eula=true" > "$dir/eula.txt"
        
        # Podstawowa konfiguracja
        cat > "$dir/server.properties" << PROP
server-port=$PORT
online-mode=false
max-players=20
PROP
    fi
}

create_rust_server() {
    local id=$1
    local port=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << START
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera Rust $NAME..."
echo "Port: $PORT"
while true; do
    echo "[RUST] Serwer \$NAME dziaÅ‚a na porcie \$PORT - \$(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
    
    # Plik konfiguracyjny Rust
    cat > "$dir/server.cfg" << RUST_CFG
server.port $PORT
server.level "Procedural Map"
server.seed 1234
server.worldsize 4000
server.maxplayers 50
server.hostname "$NAME"
server.description "Panel Managed Rust Server"
RUST_CFG
}

create_ark_server() {
    local id=$1
    local port=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << START
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera ARK $NAME..."
echo "Port: $PORT"
while true; do
    echo "[ARK] Serwer \$NAME dziaÅ‚a na porcie \$PORT - \$(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
}

create_csgo_server() {
    local id=$1
    local port=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << START
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera CS:GO $NAME..."
echo "Port: $PORT"
while true; do
    echo "[CSGO] Serwer \$NAME dziaÅ‚a na porcie \$PORT - \$(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
}

create_teamspeak_server() {
    local id=$1
    local port=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << START
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera TeamSpeak $NAME..."
echo "Port: $PORT"
while true; do
    echo "[TS3] Serwer \$NAME dziaÅ‚a na porcie \$PORT - \$(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
}

create_custom_server() {
    local id=$1
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << 'START'
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera $NAME..."
echo "Port: $PORT | Typ: $TYPE"
while true; do
    echo "[$TYPE] Serwer $NAME dziaÅ‚a na porcie $PORT - $(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
}

start_server() {
    local id=$1
    local dir="$SERVERS_DIR/$id"
    
    if [ ! -d "$dir" ]; then
        echo "ERROR: Serwer '$id' nie istnieje!"
        return 1
    fi
    
    source "$dir/server.conf"
    
    if [ "$STATUS" = "running" ]; then
        echo "WARNING: Serwer '$NAME' jest juÅ¼ uruchomiony!"
        return 1
    fi
    
    echo "Uruchamianie serwera '$NAME'..."
    
    # Uruchom w screen session
    cd "$dir"
    screen -dmS "server_$id" bash start.sh
    local pid=$!
    
    # Zapisz PID i status
    sed -i "s/STATUS=.*/STATUS=\"running\"/" "$dir/server.conf"
    sed -i "s/PID=.*/PID=\"$pid\"/" "$dir/server.conf"
    
    log "Uruchomiono serwer: $NAME (PID: $pid)"
    echo "SUCCESS: Serwer '$NAME' uruchomiony!"
    return 0
}

stop_server() {
    local id=$1
    local dir="$SERVERS_DIR/$id"
    
    if [ ! -d "$dir" ]; then
        echo "ERROR: Serwer '$id' nie istnieje!"
        return 1
    fi
    
    source "$dir/server.conf"
    
    if [ "$STATUS" != "running" ]; then
        echo "WARNING: Serwer '$NAME' nie jest uruchomiony!"
        return 1
    fi
    
    echo "Zatrzymywanie serwera '$NAME'..."
    
    # Zabij proces
    if [ -n "$PID" ]; then
        kill "$PID" 2>/dev/null
    fi
    
    # Zabij screen session
    screen -S "server_$id" -X quit 2>/dev/null
    
    # Zaktualizuj status
    sed -i "s/STATUS=.*/STATUS=\"stopped\"/" "$dir/server.conf"
    sed -i "s/PID=.*/PID=\"\"/" "$dir/server.conf"
    
    log "Zatrzymano serwer: $NAME"
    echo "SUCCESS: Serwer '$NAME' zatrzymany!"
    return 0
}

restart_server() {
    local id=$1
    stop_server "$id"
    sleep 2
    start_server "$id"
}

delete_server() {
    local id=$1
    local dir="$SERVERS_DIR/$id"
    
    if [ ! -d "$dir" ]; then
        echo "ERROR: Serwer '$id' nie istnieje!"
        return 1
    fi
    
    source "$dir/server.conf"
    
    # Zatrzymaj serwer jeÅ›li dziaÅ‚a
    if [ "$STATUS" = "running" ]; then
        stop_server "$id"
        sleep 2
    fi
    
    # UsuÅ„ katalog
    rm -rf "$dir"
    log "UsuniÄ™to serwer: $NAME"
    echo "SUCCESS: Serwer '$NAME' zostaÅ‚ usuniÄ™ty!"
    return 0
}

list_servers() {
    echo ""
    echo -e "${BLUE}ğŸ® LISTA SERWERÃ“W${NC}"
    echo -e "${CYAN}================================${NC}"
    
    if [ ! "$(ls -A $SERVERS_DIR)" ]; then
        echo -e "${YELLOW}ğŸ“­ Brak serwerÃ³w${NC}"
        return
    fi
    
    for server_dir in "$SERVERS_DIR"/*; do
        if [ -f "$server_dir/server.conf" ]; then
            source "$server_dir/server.conf"
            
            local status_color=$GREEN
            local status_icon="ğŸŸ¢"
            if [ "$STATUS" != "running" ]; then
                status_color=$RED
                status_icon="ğŸ”´"
            fi
            
            echo -e " $status_icon $NAME"
            echo -e "   ğŸ“ ID: $ID | ğŸšª Port: $PORT"
            echo -e "   ğŸ§  RAM: ${MEMORY}MB | ğŸ‘¤ WÅ‚aÅ›ciciel: $OWNER"
            echo -e "   ğŸ“Š Status: ${status_color}$STATUS${NC}"
            echo -e "${CYAN}--------------------------------${NC}"
        fi
    done
}

get_all_servers() {
    local servers="["
    local first=true
    
    for server_dir in "$SERVERS_DIR"/*; do
        if [ -f "$server_dir/server.conf" ]; then
            source "$server_dir/server.conf"
            
            if [ "$first" = false ]; then
                servers+=","
            fi
            
            servers+="{\"id\":\"$ID\",\"name\":\"$NAME\",\"type\":\"$TYPE\",\"port\":\"$PORT\",\"memory\":\"$MEMORY\",\"owner\":\"$OWNER\",\"status\":\"$STATUS\"}"
            first=false
        fi
    done
    
    servers+="]"
    echo "$servers"
}

# =============================================
# ğŸŒ TWORZENIE PANELU WEB
# =============================================

create_web_panel() {
    echo -e "${YELLOW}ğŸŒ TWORZENIE PANELU WEB...${NC}"
    
    # UtwÃ³rz gÅ‚Ã³wnÄ… stronÄ™
    cat > "$WEB_DIR/index.html" << 'HTML'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦– Panel SerwerÃ³w</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .header h1 { 
            font-size: 2.5em; 
            color: #2d3748;
            margin-bottom: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background: #4299e1;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .server-list {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        .server-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4299e1;
        }
        .server-card.running { border-left-color: #48bb78; }
        .server-card.stopped { border-left-color: #e53e3e; }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .server-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
        }
        .server-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-running { background: #c6f6d5; color: #276749; }
        .status-stopped { background: #fed7d7; color: #c53030; }
        .server-info {
            color: #718096;
            margin: 10px 0;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-weight: bold;
        }
        .btn-start { background: #48bb78; color: white; }
        .btn-stop { background: #e53e3e; color: white; }
        .btn-restart { background: #ed8936; color: white; }
        .btn-delete { background: #a0aec0; color: white; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn-primary {
            background: #4299e1;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .loading { color: #666; text-align: center; padding: 20px; }
        .error { color: #e53e3e; background: #fed7d7; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { color: #276749; background: #c6f6d5; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦– Panel SerwerÃ³w</h1>
            <p>ZarzÄ…dzanie serwerami gry w czasie rzeczywistym</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('servers')">ğŸ® Serwery</div>
            <div class="tab" onclick="showTab('create')">â• Nowy Serwer</div>
            <div class="tab" onclick="showTab('help')">â“ Pomoc</div>
        </div>

        <div id="servers-tab" class="tab-content active">
            <div class="server-list" id="serverList">
                <div class="loading">ğŸ”„ Åadowanie serwerÃ³w...</div>
            </div>
            <div style="text-align: center;">
                <button class="btn-primary" onclick="refreshServers()">ğŸ”„ OdÅ›wieÅ¼</button>
            </div>
        </div>

        <div id="create-tab" class="tab-content">
            <h3>â• Tworzenie Nowego Serwera</h3>
            <form id="createServerForm">
                <div class="form-group">
                    <label for="serverName">Nazwa serwera:</label>
                    <input type="text" id="serverName" required placeholder="np. MÃ³j Serwer Minecraft">
                </div>
                <div class="form-group">
                    <label for="serverType">Typ serwera:</label>
                    <select id="serverType" required>
                        <option value="minecraft">ğŸ® Minecraft</option>
                        <option value="rust">ğŸ¦€ Rust</option>
                        <option value="ark">ğŸ¦– ARK: Survival Evolved</option>
                        <option value="csgo">ğŸ”« CS:GO</option>
                        <option value="teamspeak">ğŸ¤ TeamSpeak</option>
                        <option value="custom">âš™ï¸ Inny</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="serverPort">Port serwera:</label>
                    <input type="number" id="serverPort" placeholder="25565" min="1000" max="65535">
                </div>
                <div class="form-group">
                    <label for="serverMemory">PamiÄ™Ä‡ RAM (MB):</label>
                    <input type="number" id="serverMemory" placeholder="1024" min="512" max="16384">
                </div>
                <div class="form-group">
                    <label for="serverOwner">WÅ‚aÅ›ciciel:</label>
                    <input type="text" id="serverOwner" placeholder="admin" value="admin">
                </div>
                <button type="submit" class="btn-primary">ğŸš€ UtwÃ³rz Serwer</button>
            </form>
            <div id="formResult"></div>
        </div>

        <div id="help-tab" class="tab-content">
            <h3>â“ Pomoc - Jak uÅ¼ywaÄ‡ panelu</h3>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h4>ğŸ® ZarzÄ…dzanie serwerami:</h4>
                <ul style="margin: 10px 0 20px 20px;">
                    <li><strong>Start</strong> - uruchamia wybrany serwer</li>
                    <li><strong>Stop</strong> - zatrzymuje dziaÅ‚ajÄ…cy serwer</li>
                    <li><strong>Restart</strong> - restartuje serwer</li>
                    <li><strong>UsuÅ„</strong> - trwale usuwa serwer</li>
                </ul>
                
                <h4>â• Tworzenie serwera:</h4>
                <ul style="margin: 10px 0 20px 20px;">
                    <li><strong>Minecraft</strong> - automatycznie pobiera serwer</li>
                    <li><strong>Rust/ARK/CS:GO</strong> - wymagajÄ… rÄ™cznej instalacji</li>
                    <li><strong>Port</strong> - musi byÄ‡ unikalny dla kaÅ¼dego serwera</li>
                    <li><strong>RAM</strong> - pamiÄ™Ä‡ przydzielona serwerowi</li>
                </ul>
                
                <h4>ğŸŒ Adresy dostÄ™pu:</h4>
                <p>Po utworzeniu serwera moÅ¼esz siÄ™ do niego podÅ‚Ä…czyÄ‡ pod adresem:</p>
                <code style="background: #2d3748; color: white; padding: 5px 10px; border-radius: 3px; display: block; margin: 10px 0;">
                    twoj-adres:PORT
                </code>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function refreshServers() {
            const container = document.getElementById('serverList');
            container.innerHTML = '<div class="loading">ğŸ”„ Åadowanie serwerÃ³w...</div>';
            
            // Symulacja danych - w prawdziwej wersji tutaj bÄ™dzie API
            setTimeout(() => {
                const servers = [
                    {
                        id: 'test-minecraft',
                        name: 'Testowy Minecraft',
                        type: 'minecraft',
                        port: '25565',
                        memory: '1024',
                        owner: 'admin',
                        status: 'stopped'
                    },
                    {
                        id: 'test-rust',
                        name: 'Testowy Rust',
                        type: 'rust',
                        port: '28015',
                        memory: '2048',
                        owner: 'admin',
                        status: 'running'
                    }
                ];
                
                displayServers(servers);
            }, 1000);
        }

        function displayServers(servers) {
            const container = document.getElementById('serverList');
            
            if (servers.length === 0) {
                container.innerHTML = '<div class="loading">ğŸ“­ Brak serwerÃ³w. UtwÃ³rz pierwszy serwer!</div>';
                return;
            }
            
            container.innerHTML = '';
            
            servers.forEach(server => {
                const statusClass = server.status === 'running' ? 'running' : 'stopped';
                const statusText = server.status === 'running' ? 'DZIAÅA' : 'ZATRZYMANY';
                
                container.innerHTML += `
                    <div class="server-card ${statusClass}">
                        <div class="server-header">
                            <div class="server-name">${server.name}</div>
                            <div class="server-status status-${server.status}">${statusText}</div>
                        </div>
                        <div class="server-info">
                            <strong>ID:</strong> ${server.id} | 
                            <strong>Port:</strong> ${server.port} | 
                            <strong>RAM:</strong> ${server.memory}MB
                        </div>
                        <div class="server-info">
                            <strong>Typ:</strong> ${server.type} | 
                            <strong>WÅ‚aÅ›ciciel:</strong> ${server.owner}
                        </div>
                        <div>
                            ${server.status !== 'running' ? 
                                `<button class="btn btn-start" onclick="controlServer('${server.id}', 'start')">â–¶ Start</button>` : 
                                `<button class="btn btn-stop" onclick="controlServer('${server.id}', 'stop')">â¹ Stop</button>`
                            }
                            <button class="btn btn-restart" onclick="controlServer('${server.id}', 'restart')">ğŸ”„ Restart</button>
                            <button class="btn btn-delete" onclick="deleteServer('${server.id}')">ğŸ—‘ UsuÅ„</button>
                        </div>
                    </div>
                `;
            });
        }

        function controlServer(serverId, action) {
            showMessage(`Funkcja ${action} dla serwera ${serverId} - w prawdziwej wersji poÅ‚Ä…czy siÄ™ z API`, true);
        }

        function deleteServer(serverId) {
            if (confirm('Czy na pewno chcesz usunÄ…Ä‡ ten serwer?')) {
                showMessage(`Serwer ${serverId} zostaÅ‚ usuniÄ™ty - w prawdziwej wersji poÅ‚Ä…czy siÄ™ z API`, true);
                refreshServers();
            }
        }

        document.getElementById('createServerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formResult = document.getElementById('formResult');
            const button = this.querySelector('button[type="submit"]');
            const originalText = button.textContent;
            
            button.textContent = 'â³ Tworzenie...';
            button.disabled = true;
            
            const data = {
                name: document.getElementById('serverName').value,
                type: document.getElementById('serverType').value,
                port: document.getElementById('serverPort').value || '25565',
                memory: document.getElementById('serverMemory').value || '1024',
                owner: document.getElementById('serverOwner').value || 'admin'
            };

            // Symulacja tworzenia serwera
            setTimeout(() => {
                showMessage(`Serwer "${data.name}" zostaÅ‚ utworzony! - w prawdziwej wersji poÅ‚Ä…czy siÄ™ z API`, true, formResult);
                this.reset();
                button.textContent = originalText;
                button.disabled = false;
                showTab('servers');
                refreshServers();
            }, 2000);
        });

        function showMessage(message, isSuccess, container = null) {
            const element = container || document.body;
            const msgDiv = document.createElement('div');
            msgDiv.className = isSuccess ? 'success' : 'error';
            msgDiv.textContent = message;
            
            if (container) {
                container.innerHTML = '';
                container.appendChild(msgDiv);
            } else {
                element.appendChild(msgDiv);
                setTimeout(() => msgDiv.remove(), 5000);
            }
        }

        // ZaÅ‚aduj serwery przy starcie
        refreshServers();
    </script>
</body>
</html>
HTML

    # Strona statusu
    cat > "$WEB_DIR/status.html" << 'STATUS'
<!DOCTYPE html>
<html>
<head>
    <title>Status Panelu</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 50px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦– Status Panelu SerwerÃ³w</h1>
        
        <div class="status online">âœ… Panel gÅ‚Ã³wny: DZIAÅA</div>
        <div class="status online">ğŸŒ Serwer web: AKTYWNY na porcie 8080</div>
        <div class="status online">ğŸ“Š System: OPTYMALNY</div>
        <div class="status online">ğŸ”§ API: GOTOWE</div>
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="/" class="back-btn">â† PowrÃ³t do Panelu GÅ‚Ã³wnego</a>
        </div>
    </div>
</body>
</html>
STATUS

    echo -e "${GREEN}âœ… Panel web zostaÅ‚ utworzony!${NC}"
    echo -e "${CYAN}ğŸ“ Pliki znajdujÄ… siÄ™ w: $WEB_DIR/${NC}"
}

# =============================================
# ğŸŒ URUCHAMIANIE SERWERA WEB
# =============================================

start_web_server() {
    echo -e "${YELLOW}ğŸŒ URUCHAMIANIE SERWERA WEB...${NC}"
    
    # SprawdÅº czy panel web istnieje
    if [ ! -f "$WEB_DIR/index.html" ]; then
        echo -e "${YELLOW}ğŸ“ Tworzenie panelu web...${NC}"
        create_web_panel
    fi
    
    # Zatrzymaj istniejÄ…cy serwer
    stop_web_server
    
    # Uruchom serwer HTTP
    cd "$WEB_DIR"
    python3 -m http.server $PORT > "$LOGS_DIR/web.log" 2>&1 &
    local web_pid=$!
    echo $web_pid > "$WEB_PID_FILE"
    
    local ip=$(hostname -I | awk '{print $1}')
    
    log "Serwer web uruchomiony na porcie $PORT (PID: $web_pid)"
    echo -e "${GREEN}âœ… Serwer web uruchomiony!${NC}"
    echo -e "${CYAN}ğŸŒ Adresy dostÄ™pu:${NC}"
    echo -e "   Local:    http://localhost:$PORT"
    echo -e "   SieÄ‡:     http://$ip:$PORT"
    echo -e "   Status:   http://localhost:$PORT/status"
    echo -e ""
    echo -e "${YELLOW}ğŸ’¡ OtwÃ³rz przeglÄ…darkÄ™ i wejdÅº na jeden z powyÅ¼szych adresÃ³w${NC}"
}

stop_web_server() {
    if [ -f "$WEB_PID_FILE" ]; then
        local pid=$(cat "$WEB_PID_FILE")
        if ps -p $pid > /dev/null 2>&1; then
            kill $pid 2>/dev/null
            echo -e "${GREEN}âœ… Serwer web zatrzymany${NC}"
        fi
        rm -f "$WEB_PID_FILE"
    fi
    
    pkill -f "python3 -m http.server" 2>/dev/null
}

# =============================================
# ğŸ“Š FUNKCJE SYSTEMOWE
# =============================================

show_system_stats() {
    echo ""
    echo -e "${BLUE}ğŸ“Š STATYSTYKI SYSTEMU${NC}"
    echo -e "${CYAN}================================${NC}"
    
    # CPU
    local cpu=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}')
    echo -e " ğŸ’» UÅ¼ycie CPU: ${cpu}%"
    
    # PamiÄ™Ä‡
    local mem_total=$(free -m | awk 'NR==2{print $2}')
    local mem_used=$(free -m | awk 'NR==2{print $3}')
    local mem_percent=$((mem_used * 100 / mem_total))
    echo -e " ğŸ§  PamiÄ™Ä‡ RAM: ${mem_used}MB/${mem_total}MB (${mem_percent}%)"
    
    # Serwery
    local total_servers=0
    local running_servers=0
    
    for server_dir in "$SERVERS_DIR"/*; do
        if [ -f "$server_dir/server.conf" ]; then
            ((total_servers++))
            source "$server_dir/server.conf"
            if [ "$STATUS" = "running" ]; then
                ((running_servers++))
            fi
        fi
    done
    
    echo -e " ğŸ® Serwery: $running_servers/$total_servers uruchomionych"
    echo -e " ğŸ“ Katalog panelu: $PANEL_DIR"
    echo -e "${CYAN}================================${NC}"
}

# =============================================
# ğŸ¯ MENU GÅÃ“WNE
# =============================================

show_menu() {
    echo -e "${GREEN}"
    echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘           ğŸ¦– PANEL SERWERÃ“W          â•‘"
    echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo -e "â•‘                                      â•‘"
    echo -e "â•‘  ${YELLOW}1${GREEN}ï¸âƒ£  - Lista serwerÃ³w               â•‘"
    echo -e "â•‘  ${YELLOW}2${GREEN}ï¸âƒ£  - UtwÃ³rz serwer                â•‘"
    echo -e "â•‘  ${YELLOW}3${GREEN}ï¸âƒ£  - Uruchom serwer              â•‘"
    echo -e "â•‘  ${YELLOW}4${GREEN}ï¸âƒ£  - Zatrzymaj serwer            â•‘"
    echo -e "â•‘  ${YELLOW}5${GREEN}ï¸âƒ£  - Restartuj serwer            â•‘"
    echo -e "â•‘  ${YELLOW}6${GREEN}ï¸âƒ£  - UsuÅ„ serwer                 â•‘"
    echo -e "â•‘  ${YELLOW}7${GREEN}ï¸âƒ£  - UtwÃ³rz panel web            â•‘"
    echo -e "â•‘  ${YELLOW}8${GREEN}ï¸âƒ£  - Uruchom serwer web          â•‘"
    echo -e "â•‘  ${YELLOW}9${GREEN}ï¸âƒ£  - Zatrzymaj serwer web        â•‘"
    echo -e "â•‘  ${YELLOW}0${GREEN}ï¸âƒ£  - WyjÅ›cie                     â•‘"
    echo -e "â•‘                                      â•‘"
    echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo -e "â•‘        Wybierz opcjÄ™ (0-9):          â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# =============================================
# ğŸ“œ MAIN SCRIPT
# =============================================

# Inicjalizacja
mkdir -p "$PANEL_DIR"
setup_directories
check_dependencies

# Zapisz PID panelu
echo $$ > "$PANEL_PID_FILE"

# Funkcja sprzÄ…tania
cleanup() {
    echo -e "\n${YELLOW}ğŸ›‘ Zatrzymywanie panelu...${NC}"
    stop_web_server
    rm -f "$PANEL_PID_FILE"
    echo -e "${GREEN}âœ… Panel zatrzymany${NC}"
    exit 0
}

trap cleanup INT TERM

clear

echo -e "${BLUE}"
echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘           ğŸ¦– PANEL SERWERÃ“W          â•‘"
echo -e "â•‘         Production Edition           â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo -e "${CYAN}Katalog panelu: $PANEL_DIR${NC}"
echo -e "${CYAN}Logi: $LOGS_DIR/panel.log${NC}"
echo ""

while true; do
    show_menu
    read -p "TwÃ³j wybÃ³r: " choice
    
    case $choice in
        1)
            list_servers
            ;;
        2)
            echo ""
            echo -e "${BLUE}ğŸ® TWORZENIE SERWERA${NC}"
            read -p "Nazwa serwera: " name
            read -p "Typ (minecraft/rust/ark/csgo/teamspeak): " type
            read -p "Port: " port
            read -p "RAM (MB): " memory
            read -p "WÅ‚aÅ›ciciel: " owner
            create_server "$name" "$type" "$port" "$memory" "$owner"
            ;;
        3)
            read -p "ID serwera do uruchomienia: " id
            start_server "$id"
            ;;
        4)
            read -p "ID serwera do zatrzymania: " id
            stop_server "$id"
            ;;
        5)
            read -p "ID serwera do restartu: " id
            restart_server "$id"
            ;;
        6)
            read -p "ID serwera do usuniÄ™cia: " id
            delete_server "$id"
            ;;
        7)
            create_web_panel
            ;;
        8)
            start_web_server
            ;;
        9)
            stop_web_server
            ;;
        0)
            cleanup
            ;;
        *)
            echo -e "${RED}âŒ NieprawidÅ‚owy wybÃ³r!${NC}"
            ;;
    esac
    
    echo ""
    read -p "NaciÅ›nij Enter aby kontynuowaÄ‡..."
    clear
done
