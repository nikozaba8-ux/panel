#!/bin/bash

echo "=== PODSTAWOWA DIAGNOSTYKA SYSTEMU ==="
echo "Czas: $(date)"
echo "======================================="

# Kolory dla czytelnoÅ›ci
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Funkcja do sprawdzania statusu
check_status() {
    echo -e "${BLUE}ğŸ” $1...${NC}"
    if $2; then
        echo -e "${GREEN}âœ… $1: OK${NC}"
        return 0
    else
        echo -e "${RED}âŒ $1: FAILED${NC}"
        return 1
    fi
}

echo ""
echo -e "${YELLOW}1. INFORMACJE O SYSTEMIE${NC}"
echo "======================================="

# Podstawowe informacje o systemie
check_status "System operacyjny" "uname -s"
check_status "Wersja kernela" "uname -r"
check_status "Architektura" "uname -m"

echo ""
echo -e "${YELLOW}2. UÅ»YTKOWNIK I UPRAWNIENIA${NC}"
echo "======================================="

# Informacje o uÅ¼ytkowniku
echo -e "${BLUE}ğŸ” Aktualny uÅ¼ytkownik...${NC}"
whoami
id

echo ""
echo -e "${BLUE}ğŸ” Uprawnienia do /home...${NC}"
ls -ld /home/
if [ -d "/home/purplehost" ]; then
    ls -ld /home/purplehost
else
    echo -e "${RED}âŒ Katalog /home/purplehost nie istnieje${NC}"
fi

echo ""
echo -e "${YELLOW}3. DYSK I PAMIÄ˜Ä†${NC}"
echo "======================================="

# Sprawdzenie miejsca na dysku
echo -e "${BLUE}ğŸ” Miejsce na dysku...${NC}"
df -h /home | grep -v Filesystem

echo ""
echo -e "${BLUE}ğŸ” Wolna pamiÄ™Ä‡...${NC}"
free -h

echo ""
echo -e "${YELLOW}4. ZALEÅ»NOÅšCI SYSTEMOWE${NC}"
echo "======================================="

# Sprawdzenie Pythona
check_status "Python 3" "python3 --version >/dev/null 2>&1"
if command -v python3 >/dev/null 2>&1; then
    echo -e "   Wersja: $(python3 --version 2>&1)"
fi

# Sprawdzenie pip
check_status "Pip 3" "pip3 --version >/dev/null 2>&1"

# Sprawdzenie Javy (jeÅ›li potrzebna)
check_status "Java" "java -version >/dev/null 2>&1"

# Sprawdzenie wget/curl
check_status "wget" "wget --version >/dev/null 2>&1"
check_status "curl" "curl --version >/dev/null 2>&1"

echo ""
echo -e "${YELLOW}5. SIEC I PORTY${NC}"
echo "======================================="

# Sprawdzenie portÃ³w
echo -e "${BLUE}ğŸ” Sprawdzanie portu 8080...${NC}"
if netstat -tulpn 2>/dev/null | grep :8080 >/dev/null; then
    echo -e "${RED}âŒ Port 8080 jest zajÄ™ty${NC}"
    netstat -tulpn | grep :8080
else
    echo -e "${GREEN}âœ… Port 8080 jest wolny${NC}"
fi

# Sprawdzenie adresÃ³w IP
echo ""
echo -e "${BLUE}ğŸ” Adresy IP...${NC}"
ip addr show | grep inet | grep -v 127.0.0.1 | head -5

echo ""
echo -e "${YELLOW}6. PROCESY${NC}"
echo "======================================="

# Sprawdzenie procesÃ³w Python
echo -e "${BLUE}ğŸ” Aktywne procesy Python...${NC}"
ps aux | grep python | grep -v grep | head -10

echo ""
echo -e "${YELLOW}7. STRUKTURA PURPLEHOST${NC}"
echo "======================================="

# Sprawdzenie struktury katalogÃ³w PurpleHost
if [ -d "/home/purplehost" ]; then
    echo -e "${GREEN}âœ… Katalog PurpleHost istnieje${NC}"
    echo ""
    echo -e "${BLUE}ğŸ” Struktura katalogÃ³w:${NC}"
    find /home/purplehost -type d 2>/dev/null | head -20
    
    echo ""
    echo -e "${BLUE}ğŸ” ZawartoÅ›Ä‡ katalogu web:${NC}"
    if [ -d "/home/purplehost/web" ]; then
        ls -la /home/purplehost/web/ | head -10
    else
        echo -e "${RED}âŒ Katalog web nie istnieje${NC}"
    fi
    
    echo ""
    echo -e "${BLUE}ğŸ” Logi:${NC}"
    if [ -f "/home/purplehost/logs/web_server.log" ]; then
        echo -e "Ostatnie 10 linii logÃ³w:"
        tail -10 /home/purplehost/logs/web_server.log
    else
        echo -e "${RED}âŒ Plik logÃ³w nie istnieje${NC}"
    fi
else
    echo -e "${RED}âŒ Katalog PurpleHost nie istnieje${NC}"
fi

echo ""
echo -e "${YELLOW}8. TEST SERWERA HTTP${NC}"
echo "======================================="

# Test prostego serwera HTTP
echo -e "${BLUE}ğŸ” Test serwera HTTP...${NC}"
python3 -c "
import http.server
import socketserver
import threading
import time
import sys

def test_http_server():
    try:
        # UÅ¼yj portu 8083 dla testu
        port = 8083
        with socketserver.TCPServer(('', port), http.server.SimpleHTTPRequestHandler) as httpd:
            print('   âœ… Serwer HTTP moÅ¼e zostaÄ‡ uruchomiony')
            # Uruchom w tle na 2 sekundy
            server_thread = threading.Thread(target=httpd.serve_forever)
            server_thread.daemon = True
            server_thread.start()
            time.sleep(1)
            return True
    except OSError as e:
        if 'Address already in use' in str(e):
            print('   âš ï¸  Port testowy zajÄ™ty, ale serwer dziaÅ‚a')
            return True
        else:
            print(f'   âŒ BÅ‚Ä…d serwera: {e}')
            return False
    except Exception as e:
        print(f'   âŒ Nieoczekiwany bÅ‚Ä…d: {e}')
        return False

if test_http_server():
    print('   ğŸŸ¢ Test serwera HTTP: PASSED')
else:
    print('   ğŸ”´ Test serwera HTTP: FAILED')
"

echo ""
echo "======================================="
echo -e "${YELLOW}DIAGNOSTYKA ZAKOÅƒCZONA${NC}"
echo "======================================="

# Podsumowanie
echo ""
echo -e "${BLUE}ğŸ“‹ PODSUMOWANIE:${NC}"
echo "NastÄ™pne kroki:"
echo "1. SprawdÅº czy wszystkie zaleÅ¼noÅ›ci sÄ… zainstalowane"
echo "2. Upewnij siÄ™ Å¼e port 8080 jest wolny" 
echo "3. SprawdÅº uprawnienia do katalogu /home/purplehost"
echo "4. JeÅ›li katalog nie istnieje, utwÃ³rz go rÄ™cznie"
