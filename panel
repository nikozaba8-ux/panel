#!/bin/bash

# ASCII Art
ascii_art="

       _ _     _                 
      | (_)   | |                
      | |_ ___| |__  _ __  _   _ 
  _   | | / __| '_ \| '_ \| | | |
 | |__| | \__ \ | | | | | | |_| |
  \____/|_|___/_| |_|_| |_|\__,_|
                                 
"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Function for consistent messaging
echo_message() {
    echo -e "${GREEN}$1${NC}"
}

echo_error() {
    echo -e "${RED}$1${NC}"
}

echo_warning() {
    echo -e "${YELLOW}$1${NC}"
}

echo_info() {
    echo -e "${BLUE}$1${NC}"
}

# Clear the screen
clear

# Check if the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo_error "Please run this script as root."
  exit 1
fi

echo -e "${CYAN}$ascii_art${NC}"
echo_message "=== SKYPORT INSTALLER - BEZ WALLET ==="

# Update system
echo_message "[1/7] Updating system packages..."
apt update && apt upgrade -y
apt install -y curl software-properties-common git wget unzip build-essential

# Install Node.js
echo_message "[2/7] Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt-get install -y nodejs

# Verify Node.js installation
echo_info "Node.js version: $(node -v)"
echo_info "NPM version: $(npm -v)"

# Install FiveM - NAPRAWIONA METODA
echo_message "[3/7] Installing FiveM Assets..."
mkdir -p /opt/fivem-assets
cd /opt/fivem-assets

# PROSTA I DZIA≈ÅAJƒÑCA METODA POBRANIA FIVEM
echo_info "Downloading FiveM using reliable method..."

# Pobierz stronƒô i przetw√≥rz jƒÖ poprawnie
echo_info "Fetching latest FiveM build information..."
FIVEM_HTML=$(curl -s https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/)

# Kilka r√≥≈ºnych metod parsowania - jedna na pewno zadzia≈Ça
LATEST_BUILD=$(echo "$FIVEM_HTML" | grep -oP 'href="\K[0-9]+-[a-f0-9]+(?=/)' | head -1)

if [ -z "$LATEST_BUILD" ]; then
    LATEST_BUILD=$(echo "$FIVEM_HTML" | grep -oE '>[0-9]+-[a-f0-9]+/<' | sed 's/[><]//g' | head -1)
fi

if [ -z "$LATEST_BUILD" ]; then
    LATEST_BUILD=$(echo "$FIVEM_HTML" | grep -oE '[0-9]{4}-[a-f0-9]{40}' | head -1)
fi

# Je≈õli nadal nie znaleziono, u≈ºyj rƒôcznego linka
if [ -z "$LATEST_BUILD" ]; then
    echo_warning "Auto-detection failed, using manual download..."
    # U≈ºyj ostatniego znanego stabilnego builda
    FIVEM_URL="https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/7586-4e9d6f5bbb6b8fd6f8ed5eeb1ae53b6d9f2420a9/fx.tar.xz"
else
    FIVEM_URL="https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/${LATEST_BUILD}/fx.tar.xz"
fi

echo_info "Downloading FiveM from: $FIVEM_URL"

# Pobierz FiveM
if wget --timeout=60 --tries=3 -O fivem.tar.xz "$FIVEM_URL"; then
    echo_info "‚úì FiveM downloaded successfully"
    
    # Sprawd≈∫ czy plik nie jest pusty
    if [ ! -s fivem.tar.xz ]; then
        echo_error "Downloaded file is empty!"
        exit 1
    fi
    
    echo_info "Extracting FiveM..."
    if tar -xf fivem.tar.xz; then
        echo_message "‚úì FiveM extracted successfully"
        
        # Sprawd≈∫ czy run.sh istnieje
        if [ -f "run.sh" ]; then
            chmod +x run.sh
            echo_message "‚úì FiveM installation completed"
        else
            echo_error "run.sh not found after extraction!"
            exit 1
        fi
    else
        echo_error "Failed to extract FiveM archive"
        exit 1
    fi
else
    echo_error "‚ùå FAILED TO DOWNLOAD FIVEM AUTOMATICALLY"
    echo_warning "Manual download required:"
    echo_warning "1. Visit: https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/"
    echo_warning "2. Click on the latest build number"
    echo_warning "3. Download 'fx.tar.xz'"
    echo_warning "4. Place it in /opt/fivem-assets/"
    echo_warning "5. Run: tar -xf fx.tar.xz && chmod +x run.sh"
    
    # Kontynuuj instalacjƒô Skyport nawet bez FiveM
    echo_info "Continuing with Skyport installation..."
fi

# Create resources directory
mkdir -p /opt/fivem-assets/resources

# Create basic server config for FiveM
cat > /opt/fivem-assets/server.cfg << 'EOF'
# Server Config
endpoint_add_tcp "0.0.0.0:30120"
endpoint_add_udp "0.0.0.0:30120"

# Server Identity
sv_hostname "Skyport FiveM Server"
sv_projectName "Skyport"
sv_projectDesc "Managed by Skyport"

# License Key (set your own)
sv_licenseKey "changeme"

# Max Players
sv_maxClients 48

# Security
rcon_password "change_rcon_password"

# Resources
start mapmanager
start chat
start spawnmanager
start sessionmanager
start basic-gamemode
start hardcap
start rconlog

# Ensure these scripts
ensure mapmanager
ensure chat
ensure spawnmanager
ensure sessionmanager
ensure basic-gamemode
ensure hardcap
ensure rconlog
EOF

# Install Skyport
echo_message "[4/7] Installing Skyport Application..."
cd /opt

if [ -d "oversee-fixed" ]; then
    echo_info "Updating existing installation..."
    cd oversee-fixed
    git reset --hard
    git pull
else
    git clone https://github.com/draco-labes/oversee-fixed.git
    cd oversee-fixed
fi

# Clean installation
echo_info "Cleaning installation..."
rm -rf node_modules package-lock.json

# Install dependencies
echo_info "Installing npm dependencies..."
npm install

# Remove wallet components
echo_message "[5/7] Removing wallet features..."
find . -type f \( -name "*.js" -o -name "*.ejs" -o -name "*.html" -o -name "*.json" \) -exec sed -i '
/wallet/d
/Wallet/d
/payment/d
/Payment/d
/money/d
/Money/d
/currency/d
/billing/d
/transaction/d
/economy/d
/bank/d
/cash/d
/finance/d
' {} \; 2>/dev/null || true

# Create clean config without wallet
cat > config/production.json << 'EOF'
{
    "port": 3001,
    "host": "0.0.0.0",
    "sessionSecret": "skyport-session-secret-change-in-production",
    "fivemPath": "/opt/fivem-assets",
    "resourcesPath": "/opt/fivem-assets/resources",
    "serverDataPath": "/opt/fivem-assets",
    "features": {
        "wallet": false,
        "monitoring": true,
        "serverManagement": true,
        "playerManagement": true,
        "resourceManagement": true,
        "logViewer": true
    },
    "security": {
        "enableAuth": true,
        "enable2FA": false
    }
}
EOF

# Initialize database and create user
echo_info "Initializing database..."
npm run seed 2>/dev/null || echo "Seed completed"
npm run createUser 2>/dev/null || echo "User creation completed"

# Create systemd service
echo_message "[6/7] Creating system services..."

# Skyport service
cat > /etc/systemd/system/skyport.service << EOF
[Unit]
Description=Skyport FiveM Management Panel
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/oversee-fixed
ExecStart=/usr/bin/node /opt/oversee-fixed/app.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF

# FiveM service (tylko je≈õli FiveM zosta≈Ço zainstalowane)
if [ -f "/opt/fivem-assets/run.sh" ]; then
    cat > /etc/systemd/system/fivem.service << EOF
[Unit]
Description=FiveM Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/fivem-assets
ExecStart=/opt/fivem-assets/run.sh +exec server.cfg
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
fi

# Reload systemd
systemctl daemon-reload
systemctl enable skyport.service

if [ -f "/etc/systemd/system/fivem.service" ]; then
    systemctl enable fivem.service
fi

echo_message "[7/7] Creating management scripts..."

# Create management scripts
cat > /usr/local/bin/start-skyport << 'EOF'
#!/bin/bash
systemctl start skyport
echo "Skyport started on port 3001"
EOF

cat > /usr/local/bin/stop-skyport << 'EOF'
#!/bin/bash
systemctl stop skyport
echo "Skyport stopped"
EOF

cat > /usr/local/bin/restart-skyport << 'EOF'
#!/bin/bash
systemctl restart skyport
echo "Skyport restarted"
EOF

cat > /usr/local/bin/skyport-status << 'EOF'
#!/bin/bash
systemctl status skyport
EOF

# Skrypt do rƒôcznego pobierania FiveM kt√≥ry KURWA DZIA≈ÅA
cat > /usr/local/bin/download-fivem << 'EOF'
#!/bin/bash
echo "================================================"
echo "        MANUAL FIVEM DOWNLOAD - DZIA≈ÅA!        "
echo "================================================"

cd /opt/fivem-assets

# Czyszczenie starych plik√≥w
rm -f fivem.tar.xz
rm -f fx.tar.xz

# Pobranie strony i wy≈õwietlenie dostƒôpnych build√≥w
echo "Available FiveM builds:"
curl -s https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/ | grep -oP 'href="\K[0-9]+-[a-f0-9]+(?=/)' | head -10

# Pobierz najnowszy build
LATEST=$(curl -s https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/ | grep -oP 'href="\K[0-9]+-[a-f0-9]+(?=/)' | head -1)

if [ -z "$LATEST" ]; then
    echo "ERROR: Could not find build list"
    echo "Please download manually from:"
    echo "https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/"
    exit 1
fi

echo "Downloading build: $LATEST"
URL="https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/${LATEST}/fx.tar.xz"
echo "URL: $URL"

# Pobierz z progresem
wget --progress=bar:force -O fivem.tar.xz "$URL"

if [ $? -eq 0 ] && [ -f "fivem.tar.xz" ]; then
    echo "Extracting..."
    tar -xf fivem.tar.xz
    chmod +x run.sh
    echo "‚úÖ FIVEM INSTALLED SUCCESSFULLY!"
    echo "You can now start FiveM with: start-fivem"
else
    echo "‚ùå DOWNLOAD FAILED!"
    echo "Manual steps:"
    echo "1. Go to: https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/"
    echo "2. Click on the latest build number"
    echo "3. Download 'fx.tar.xz'"
    echo "4. Place it in /opt/fivem-assets/"
    echo "5. Run: cd /opt/fivem-assets && tar -xf fx.tar.xz && chmod +x run.sh"
fi
EOF

# Pozosta≈Çe skrypty tylko je≈õli FiveM jest zainstalowane
if [ -f "/opt/fivem-assets/run.sh" ]; then
    cat > /usr/local/bin/start-fivem << 'EOF'
#!/bin/bash
systemctl start fivem
echo "FiveM server starting..."
EOF

    cat > /usr/local/bin/stop-fivem << 'EOF'
#!/bin/bash
systemctl stop fivem
echo "FiveM server stopped"
EOF

    cat > /usr/local/bin/fivem-status << 'EOF'
#!/bin/bash
systemctl status fivem
EOF

    # POPRAWIONY skrypt zarzƒÖdzania zasobami
    cat > /usr/local/bin/manage-resources << 'EOF'
#!/bin/bash
RESOURCES_DIR="/opt/fivem-assets/resources"

case "$1" in
    "list")
        echo "=== Available FiveM Resources ==="
        ls -la "$RESOURCES_DIR" 2>/dev/null || echo "No resources directory"
        ;;
    "add")
        if [ -z "$2" ]; then
            echo "Usage: manage-resources add <git-repository-url> [resource-name]"
            exit 1
        fi
        cd "$RESOURCES_DIR"
        git clone "$2" "$3" 2>/dev/null || git clone "$2"
        echo "Resource added"
        ;;
    "remove")
        if [ -z "$2" ]; then
            echo "Usage: manage-resources remove <resource-name>"
            exit 1
        fi
        rm -rf "$RESOURCES_DIR/$2"
        echo "Resource removed"
        ;;
    *)
        echo "Usage: manage-resources {list|add|remove}"
        exit 1
        ;;
esac
EOF
fi

# Make all scripts executable
chmod +x /usr/local/bin/start-skyport
chmod +x /usr/local/bin/stop-skyport
chmod +x /usr/local/bin/restart-skyport
chmod +x /usr/local/bin/skyport-status
chmod +x /usr/local/bin/download-fivem

if [ -f "/usr/local/bin/start-fivem" ]; then
    chmod +x /usr/local/bin/start-fivem
    chmod +x /usr/local/bin/stop-fivem
    chmod +x /usr/local/bin/fivem-status
    chmod +x /usr/local/bin/manage-resources
fi

# Set permissions
chown -R root:root /opt/oversee-fixed
chown -R root:root /opt/fivem-assets

echo_message "=== INSTALACJA ZAKO≈ÉCZONA ==="
echo ""
echo_info "=== INFORMACJE ==="
echo "Skyport Panel: http://$(curl -s ifconfig.me):3001"

if [ -f "/opt/fivem-assets/run.sh" ]; then
    echo "FiveM Server:  $(curl -s ifconfig.me):30120"
else
    echo "FiveM:         NOT INSTALLED (run 'download-fivem')"
fi

echo ""
echo_info "=== MANAGEMENT COMMANDS ==="
echo "skyport-status    - Status panelu"
echo "start-skyport     - Uruchom panel"
echo "stop-skyport      - Zatrzymaj panel"
echo "restart-skyport   - Restart panelu"
echo ""

if [ -f "/opt/fivem-assets/run.sh" ]; then
    echo "fivem-status      - Status FiveM"
    echo "start-fivem       - Uruchom FiveM"
    echo "stop-fivem        - Zatrzymaj FiveM"
    echo "manage-resources  - ZarzƒÖdzanie zasobami"
else
    echo "download-fivem    - üí• POBERZ FIVEM (rƒôcznie) üí•"
fi

echo ""
echo_warning "=== JE≈öLI FIVEM SIƒò NIE POBRA≈ÅO ==="
echo "Uruchom: download-fivem"
echo "Lub pobierz rƒôcznie z:"
echo "https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/"
echo ""
echo_message "=== WALLET WYJEBANY! ==="

# Start Skyport
echo_info "Starting Skyport..."
systemctl start skyport

# Show status
echo ""
echo_info "=== STATUS ==="
skyport-status
