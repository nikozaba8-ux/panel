#!/bin/bash

# GO Game - Auto Public Dashboard
# Autor: Kacpros
# Wersja: 11.0 - Single Port 8080

# Kolory
BLUE='\033[0;34m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

print_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
print_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
print_warning() { echo -e "${ORANGE}[WARNING]${NC} $1"; }
print_error() { echo -e "${RED}[ERROR]${NC} $1"; }
print_debug() { echo -e "${CYAN}[DEBUG]${NC} $1"; }
print_header() { echo -e "${PURPLE}[HEADER]${NC} $1"; }

# Logowanie
setup_logging() {
    LOG_FILE="go-game-install-$(date +%Y%m%d-%H%M%S).log"
    exec > >(tee -a "$LOG_FILE") 2>&1
    print_info "Logowanie uruchomione: $LOG_FILE"
}

# Sprawd≈∫ zale≈ºno≈õci
check_dependencies() {
    print_info "Sprawdzanie zale≈ºno≈õci systemowych..."
    
    local missing_deps=()
    
    # Sprawd≈∫ curl
    if ! command -v curl &> /dev/null; then
        print_warning "Curl nie znaleziony, instalujƒô..."
        if command -v apt-get &> /dev/null; then
            apt-get update && apt-get install -y curl
        elif command -v yum &> /dev/null; then
            yum install -y curl
        else
            missing_deps+=("curl")
        fi
    fi
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        print_error "BrakujƒÖce zale≈ºno≈õci: ${missing_deps[*]}"
        return 1
    fi
    
    print_success "Wszystkie zale≈ºno≈õci sƒÖ dostƒôpne"
    return 0
}

# Sprawd≈∫ dostƒôpno≈õƒá portu
check_port_availability() {
    local port=$1
    
    print_info "Sprawdzanie dostƒôpno≈õci portu $port..."
    
    if (command -v netstat >/dev/null && netstat -tuln | grep -q ":${port} ") || 
       (command -v ss >/dev/null && ss -tuln | grep -q ":${port} ") || 
       (command -v lsof >/dev/null && lsof -i :${port} >/dev/null 2>&1); then
        print_error "Port $port jest ju≈º zajƒôty!"
        return 1
    else
        print_success "Port $port jest dostƒôpny"
        return 0
    fi
}

# Backup istniejƒÖcej instalacji
backup_existing() {
    local backup_dir="backups"
    
    if [ -d "go-game-single" ]; then
        print_info "Znaleziono istniejƒÖcƒÖ instalacjƒô, tworzenie backupu..."
        
        mkdir -p "$backup_dir"
        local backup_name="go-game-backup-$(date +%Y%m%d-%H%M%S)"
        local backup_path="$backup_dir/$backup_name"
        
        if cp -r go-game-single "$backup_path"; then
            print_success "Backup utworzony: $backup_path"
            rm -rf go-game-single
            print_info "Stara instalacja usuniƒôta"
        else
            print_error "Nie uda≈Ço siƒô utworzyƒá backupu!"
            return 1
        fi
    fi
    
    return 0
}

# Pobierz PUBLICZNY adres IP
get_public_ip() {
    print_info "Pobieranie publicznego adresu IP..."
    
    local services=(
        "https://ifconfig.me/ip"
        "https://api.ipify.org"
        "https://checkip.amazonaws.com"
        "https://icanhazip.com"
        "https://ipecho.net/plain"
    )
    
    local ip=""
    
    for service in "${services[@]}"; do
        print_debug "Pr√≥ba pobrania z: $service"
        ip=$(curl -s --max-time 5 "$service" 2>/dev/null | tr -d '[:space:]')
        
        if [[ -n "$ip" && "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ && "$ip" != "127.0.0.1" ]]; then
            print_success "Publiczny IP uzyskany z $service: $ip"
            break
        fi
        ip=""
    done
    
    if [ -z "$ip" ]; then
        print_warning "Nie uda≈Ço siƒô pobraƒá publicznego IP, u≈ºywam lokalnego..."
        ip=$(hostname -I 2>/dev/null | awk '{print $1}')
        [ -z "$ip" ] && ip=$(ip route get 1 2>/dev/null | awk '{print $7; exit}')
        [ -z "$ip" ] && ip="localhost"
        print_warning "U≈ºywam lokalnego adresu: $ip"
    fi
    
    echo "$ip"
}

# Otw√≥rz port w firewall
open_port() {
    local port=$1
    
    print_info "Konfiguracja firewalla dla portu $port..."
    
    if command -v ufw >/dev/null 2>&1; then
        if ! ufw status | grep -q "$port/tcp"; then
            print_info "Otwieram port $port w UFW..."
            ufw allow "$port/tcp" >/dev/null 2>&1 && print_success "Port $port otwarty w UFW"
        else
            print_debug "Port $port ju≈º otwarty w UFW"
        fi
        echo "y" | ufw --force enable >/dev/null 2>&1
        
    elif command -v firewall-cmd >/dev/null 2>&1; then
        if ! firewall-cmd --list-ports | grep -q "$port/tcp"; then
            print_info "Otwieram port $port w firewalld..."
            firewall-cmd --permanent --add-port="$port/tcp" >/dev/null 2>&1 && print_success "Port $port otwarty w firewalld"
        else
            print_debug "Port $port ju≈º otwarty w firewalld"
        fi
        firewall-cmd --reload >/dev/null 2>&1
        
    elif command -v iptables >/dev/null 2>&1; then
        print_info "Otwieram port $port w iptables..."
        iptables -A INPUT -p tcp --dport "$port" -j ACCEPT >/dev/null 2>&1 && print_success "Port $port otwarty w iptables"
        
        if command -v iptables-save >/dev/null 2>&1 && [ -d "/etc/iptables" ]; then
            iptables-save > /etc/iptables/rules.v4
        fi
    else
        print_warning "Nie znaleziono narzƒôdzia firewall"
    fi
}

# Sprawd≈∫ wymagania systemowe
check_system_requirements() {
    print_info "Sprawdzanie wymaga≈Ñ systemowych..."
    
    local errors=0
    
    local free_memory=$(free -m 2>/dev/null | awk '/Mem:/ {print $2}')
    if [ -n "$free_memory" ] && [ "$free_memory" -lt 512 ]; then
        print_warning "Ma≈Ço pamiƒôci RAM: ${free_memory}MB (wymagane min. 512MB)"
        ((errors++))
    else
        print_success "Pamiƒôƒá RAM: ${free_memory}MB"
    fi
    
    local free_disk=$(df -m . | awk 'NR==2 {print $4}')
    if [ -n "$free_disk" ] && [ "$free_disk" -lt 256 ]; then
        print_warning "Ma≈Ço miejsca na dysku: ${free_disk}MB (wymagane min. 256MB)"
        ((errors++))
    else
        print_success "Miejsce na dysku: ${free_disk}MB"
    fi
    
    if [ $errors -gt 0 ]; then
        print_warning "Wykryto problemy z wymaganiami systemowymi"
        return 1
    fi
    
    print_success "Wymagania systemowe spe≈Çnione"
    return 0
}

# Instalacja Docker
install_docker() {
    print_info "Sprawdzanie instalacji Docker..."
    
    if command -v docker &> /dev/null; then
        print_success "Docker jest ju≈º zainstalowany"
        return 0
    fi
    
    print_info "Instalacja Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
    
    systemctl start docker
    systemctl enable docker
    
    if docker info >/dev/null 2>&1; then
        print_success "Docker zainstalowany i uruchomiony"
        return 0
    else
        print_error "Docker nie uruchomi≈Ç siƒô poprawnie"
        return 1
    fi
}

# G≈Ç√≥wna funkcja instalacji
install_go_game() {
    clear
    echo -e "${PURPLE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë           GO GAME - SINGLE PORT 8080        ‚ïë"
    echo "‚ïë           Auto Public IP + One Port         ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    
    # Ustawienie portu
    local MAIN_PORT=8080
    
    print_header "Rozpoczynanie instalacji GO Game Single Port..."
    
    # 1. Konfiguracja logowania
    setup_logging
    
    # 2. Sprawd≈∫ zale≈ºno≈õci
    if ! check_dependencies; then
        print_error "BrakujƒÖce zale≈ºno≈õci, instalacja przerwana"
        exit 1
    fi
    
    # 3. Sprawd≈∫ wymagania systemowe
    check_system_requirements
    
    # 4. Sprawd≈∫ port
    if ! check_port_availability $MAIN_PORT; then
        print_error "Port $MAIN_PORT jest zajƒôty, instalacja przerwana"
        exit 1
    fi
    
    # 5. Backup istniejƒÖcej instalacji
    if ! backup_existing; then
        print_error "Problem z backupem, instalacja przerwana"
        exit 1
    fi
    
    # 6. Pobierz PUBLICZNY adres IP
    print_info "Wykrywanie adresu IP..."
    SERVER_IP=$(get_public_ip)
    
    print_success "Adres serwera: $SERVER_IP"
    print_success "G≈Ç√≥wny port: $MAIN_PORT"
    
    # 7. Otw√≥rz port w firewall
    open_port $MAIN_PORT
    
    # 8. Instalacja Docker
    if ! install_docker; then
        print_error "Instalacja Docker nie powiod≈Ça siƒô"
        exit 1
    fi
    
    # 9. Tworzenie struktury projektu
    print_info "Tworzenie struktury projektu..."
    mkdir -p go-game-single/{app,logs,backups}
    
    # 10. docker-compose.yml
    print_info "Konfiguracja Docker Compose..."
    cat > go-game-single/docker-compose.yml << EOF
version: '3.8'
services:
  go-game:
    image: node:18-alpine
    working_dir: /app
    volumes:
      - ./app:/app
      - ./logs:/app/logs
    ports:
      - "0.0.0.0:8080:8080"
    command: sh -c "npm install && node server.js"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
EOF

    # 11. Aplikacja g≈Ç√≥wna
    print_info "Tworzenie aplikacji g≈Ç√≥wnej..."
    
    cat > go-game-single/app/package.json << 'EOF'
{
  "name": "go-game-single",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "start": "node server.js",
    "dev": "node server.js"
  },
  "dependencies": {
    "express": "^4.18.0",
    "cors": "^2.8.5"
  }
}
EOF

    cat > go-game-single/app/server.js << EOF
const express = require('express');
const cors = require('cors');
const app = express();
const PORT = 8080;

app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ 
    status: 'healthy',
    service: 'go-game-single-port',
    port: PORT,
    public_url: 'http://$SERVER_IP:$MAIN_PORT',
    server_ip: '$SERVER_IP',
    timestamp: new Date().toISOString(),
    version: '1.0'
  });
});

// Main page
app.get('/', (req, res) => {
  res.send(`
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GO Game - Single Port Platform</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body { 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(15, 52, 96, 0.9);
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 2rem;
            border: 2px solid #e94560;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .logo {
            font-size: 3rem;
            font-weight: bold;
            color: #e94560;
            margin-bottom: 1rem;
        }
        
        .single-port-badge {
            background: #805ad5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            display: inline-block;
            margin: 0.5rem 0;
        }
        
        .url-display {
            background: rgba(0,0,0,0.3);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            border: 2px solid #48bb78;
            font-size: 1.2rem;
            text-align: center;
            word-break: break-all;
        }
        
        .btn {
            background: #e94560;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            margin: 0.5rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: #d63a54;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(229, 69, 96, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .info-panel {
            background: rgba(15, 52, 96, 0.8);
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
            border-left: 5px solid #e94560;
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .game-card {
            background: rgba(45, 55, 72, 0.9);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid #4a5568;
            transition: all 0.3s ease;
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            border-color: #e94560;
            box-shadow: 0 10px 25px rgba(229, 69, 96, 0.2);
        }
        
        .game-title {
            color: #e94560;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        
        .game-price {
            font-size: 1.5rem;
            color: #48bb78;
            font-weight: bold;
            margin: 1rem 0;
        }
        
        .access-info {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
            border: 2px solid #e94560;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 1.5rem;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .url-display {
                font-size: 1rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">üéÆ GO GAME SINGLE PORT</div>
            <div class="single-port-badge">üîí JEDEN PORT: 8080</div>
            <p>Platforma dostƒôpna z ca≈Çego ≈õwiata przez jeden port</p>
        </div>

        <!-- Public URL -->
        <div class="info-panel">
            <h2>üåç Publiczny Adres Platformy</h2>
            <div class="url-display">
                http://$SERVER_IP:$MAIN_PORT
            </div>
            <p style="text-align: center; margin-top: 1rem;">
                <strong>Wszystko przez jeden port 8080!</strong>
            </p>
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-success" onclick="copyUrl()">üìã Kopiuj Adres</button>
                <button class="btn" onclick="testAccess()">üöÄ Testuj Dostƒôp</button>
                <button class="btn" onclick="openInNewTab()">üîó Otw√≥rz Teraz</button>
            </div>
        </div>

        <!-- Access Information -->
        <div class="access-info">
            <h2>üì° Informacje o Dostƒôpie</h2>
            <div class="status-item">
                <span>Publiczny adres:</span>
                <strong>http://$SERVER_IP:$MAIN_PORT</strong>
            </div>
            <div class="status-item">
                <span>Port:</span>
                <strong>$MAIN_PORT (jeden dla wszystkiego)</strong>
            </div>
            <div class="status-item">
                <span>Status portu:</span>
                <strong style="color: #48bb78;">üü¢ OTWARTY</strong>
            </div>
            <div class="status-item">
                <span>Dostƒôp z:</span>
                <strong>üåç Ca≈Çy ≈õwiat</strong>
            </div>
            <div class="status-item">
                <span>Architektura:</span>
                <strong>Single Port Application</strong>
            </div>
            <div class="status-item">
                <span>Admin panel:</span>
                <strong>kacpros</strong>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="info-panel">
            <h2>üëë Panel Administratora</h2>
            <div style="background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                <strong>U≈ºytkownik:</strong> kacpros<br>
                <strong>Rola:</strong> W≈Ça≈õciciel<br>
                <strong>Publiczny URL:</strong> http://$SERVER_IP:$MAIN_PORT<br>
                <strong>Port:</strong> $MAIN_PORT<br>
                <strong>Data uruchomienia:</strong> <span id="start-time"></span>
            </div>
            <button class="btn" onclick="showAdminPanel()">Otw√≥rz Panel Admina</button>
        </div>

        <!-- Games -->
        <h2>üéÆ Dostƒôpne Gry</h2>
        <div class="games-grid">
            <div class="game-card">
                <div class="game-title">Cyber Revolution 2077</div>
                <p>Immersywna gra RPG w cyberpunkowym ≈õwiecie przysz≈Ço≈õci.</p>
                <div class="game-price">59.99 PLN</div>
                <button class="btn" onclick="addToCart('Cyber Revolution 2077')">Dodaj do Koszyka</button>
            </div>
            
            <div class="game-card">
                <div class="game-title">Forest Adventures</div>
                <p>Przygodowa gra eksploracyjna w magicznym lesie.</p>
                <div class="game-price">39.99 PLN</div>
                <button class="btn" onclick="addToCart('Forest Adventures')">Dodaj do Koszyka</button>
            </div>
            
            <div class="game-card">
                <div class="game-title">Space Command</div>
                <p>Kosmiczna gra strategiczna z epickimi bitwami.</p>
                <div class="game-price">49.99 PLN</div>
                <button class="btn" onclick="addToCart('Space Command')">Dodaj do Koszyka</button>
            </div>
        </div>

        <!-- API Info -->
        <div class="info-panel">
            <h2>üîß API Endpoints</h2>
            <div style="background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                <strong>Health Check:</strong> http://$SERVER_IP:$MAIN_PORT/health<br>
                <strong>Games API:</strong> http://$SERVER_IP:$MAIN_PORT/api/games<br>
                <strong>User Info:</strong> http://$SERVER_IP:$MAIN_PORT/api/user/kacpros<br>
                <strong>Admin Stats:</strong> http://$SERVER_IP:$MAIN_PORT/api/admin/stats
            </div>
        </div>

        <!-- Quick Access -->
        <div style="text-align: center; margin: 3rem 0;">
            <h2>‚ö° Szybki Dostƒôp</h2>
            <button class="btn btn-success" style="padding: 1.2rem 2.5rem; font-size: 1.2rem;" onclick="openInNewTab()">
                üåê Otw√≥rz Platformƒô
            </button>
            <p style="margin-top: 1rem; color: #cbd5e0;">
                Adres: http://$SERVER_IP:$MAIN_PORT
            </p>
        </div>
    </div>

    <script>
        // Ustaw czas startu
        document.getElementById('start-time').textContent = new Date().toLocaleString();
        
        function copyUrl() {
            const url = 'http://$SERVER_IP:$MAIN_PORT';
            navigator.clipboard.writeText(url).then(() => {
                alert('‚úÖ Adres skopiowany do schowka!\\n' + url);
            });
        }
        
        function openInNewTab() {
            const url = 'http://$SERVER_IP:$MAIN_PORT';
            window.open(url, '_blank');
        }
        
        function testAccess() {
            const url = 'http://$SERVER_IP:$MAIN_PORT/health';
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    alert('‚úÖ Test dostƒôpu udany!\\nPlatforma jest publicznie dostƒôpna.\\n\\nPubliczny URL:\\nhttp://$SERVER_IP:$MAIN_PORT\\nPort: $MAIN_PORT');
                })
                .catch(error => {
                    alert('‚ö†Ô∏è Problem z dostƒôpem publicznym.\\nSprawd≈∫ konfiguracjƒô sieci.\\nB≈ÇƒÖd: ' + error.message);
                });
        }
        
        function showAdminPanel() {
            const adminInfo = 
                'üëë Publiczny Panel Administratora\\n\\n' +
                'U≈ºytkownik: kacpros\\n' +
                'Rola: W≈Ça≈õciciel\\n' +
                'Publiczny URL: http://$SERVER_IP:$MAIN_PORT\\n' +
                'Port: $MAIN_PORT (single port)\\n\\n' +
                'Platforma jest publicznie dostƒôpna! üåç';
                
            alert(adminInfo);
        }
        
        function addToCart(gameName) {
            alert('üõí Dodano do koszyka: ' + gameName + '\\n\\nPlatforma publicznie dostƒôpna!\\nPort: $MAIN_PORT');
        }
        
        // Logowanie informacji
        console.log('üéÆ GO Game Single Port Platform');
        console.log('üåç Public URL: http://$SERVER_IP:$MAIN_PORT');
        console.log('üîß Port: $MAIN_PORT');
        console.log('üëë Admin: kacpros');
        console.log('üöÄ Platforma publicznie dostƒôpna przez jeden port!');
        
        // Automatyczny test dostƒôpu przy starcie
        setTimeout(testAccess, 1000);
        
        // Poka≈º powitanie
        setTimeout(() => {
            alert('üåç GO GAME SINGLE PORT PLATFORM\\n\\n' +
                  'Platforma jest teraz publicznie dostƒôpna!\\n' +
                  'Adres: http://$SERVER_IP:$MAIN_PORT\\n' +
                  'Port: $MAIN_PORT\\n\\n' +
                  'Wszystko dzia≈Ça przez jeden port!');
        }, 500);
    </script>
</body>
</html>
  `);
});

// API Routes
app.get('/api/games', (req, res) => {
  res.json([
    {
      id: 1,
      title: "Cyber Revolution 2077",
      price: 59.99,
      description: "Immersywna gra RPG w cyberpunkowym ≈õwiecie przysz≈Ço≈õci",
      image: "/images/cyber-revolution.jpg",
      rating: 4.8,
      public: true
    },
    {
      id: 2, 
      title: "Forest Adventures",
      price: 39.99,
      description: "Przygodowa gra eksploracyjna w magicznym lesie",
      image: "/images/forest-adventures.jpg",
      rating: 4.5,
      public: true
    },
    {
      id: 3,
      title: "Space Command", 
      price: 49.99,
      description: "Kosmiczna gra strategiczna z epickimi bitwami",
      image: "/images/space-command.jpg",
      rating: 4.7,
      public: true
    }
  ]);
});

app.get('/api/user/:discordId', (req, res) => {
  const { discordId } = req.params;
  
  if (discordId === 'kacpros') {
    res.json({
      username: 'kacpros',
      role: 'owner',
      permissions: ['all'],
      public_access: true,
      server_info: {
        public_ip: '$SERVER_IP',
        port: $MAIN_PORT,
        status: 'public'
      }
    });
  } else {
    res.json({
      username: discordId,
      role: 'user', 
      permissions: ['basic'],
      public_access: true,
      joinDate: new Date().toISOString().split('T')[0]
    });
  }
});

app.get('/api/admin/stats', (req, res) => {
  res.json({
    platform: 'GO Game Single Port Platform',
    version: '1.0',
    status: 'public',
    public_url: 'http://$SERVER_IP:$MAIN_PORT',
    server: {
      ip: '$SERVER_IP',
      port: $MAIN_PORT,
      access: 'public'
    },
    admin: 'kacpros',
    uptime: process.uptime(),
    timestamp: new Date().toISOString()
  });
});

app.listen(PORT, '0.0.0.0', () => {
  console.log('=========================================');
  console.log('üéÆ GO GAME SINGLE PORT PLATFORM');
  console.log('=========================================');
  console.log('üåç Public URL: http://$SERVER_IP:$MAIN_PORT');
  console.log('üîß Port:       $MAIN_PORT');
  console.log('üëë Admin:      kacpros');
  console.log('üöÄ Status:     Publicznie dostƒôpna!');
  console.log('=========================================');
});
EOF

    # 12. Skrypty zarzƒÖdzania
    print_info "Tworzenie skrypt√≥w zarzƒÖdzania..."
    
    cat > go-game-single/start.sh << EOF
#!/bin/bash

echo "üöÄ Uruchamianie GO Game Single Port Platform..."
echo ""

# Sprawd≈∫ czy Docker dzia≈Ça
if ! docker info > /dev/null 2>&1; then
    echo "‚ùå Docker nie jest uruchomiony!"
    echo "   Uruchom: sudo systemctl start docker"
    exit 1
fi

cd go-game-single

echo "üì¶ Uruchamianie kontenera Docker..."
docker-compose up -d

echo ""
echo "‚è≥ Oczekiwanie na uruchomienie us≈Çugi..."
sleep 10

# Sprawd≈∫ status
echo ""
echo "üìä Status us≈Çugi:"
docker-compose ps

# Test publicznego dostƒôpu
echo ""
echo "üîç Testowanie publicznego dostƒôpu..."

if curl -s --max-time 10 "http://localhost:$MAIN_PORT/health" > /dev/null; then
    echo "‚úÖ Aplikacja dzia≈Ça poprawnie"
else
    echo "‚ö†Ô∏è Aplikacja mo≈ºe mieƒá problemy"
fi

echo ""
echo "==========================================="
echo "üéÆ GO GAME SINGLE PORT - URUCHOMIONA!"
echo "==========================================="
echo "üåç Publiczny URL: http://$SERVER_IP:$MAIN_PORT"
echo "üîß Port:          $MAIN_PORT"
echo "üëë Admin:         kacpros"
echo "==========================================="
echo ""
echo "üí° Platforma jest PUBLICZNIE DOSTƒòPNA!"
echo "   Mo≈ºesz udostƒôpniƒá ten adres:"
echo "   http://$SERVER_IP:$MAIN_PORT"
echo ""
echo "üîß ZarzƒÖdzanie:"
echo "   ‚Ä¢ Sprawd≈∫ status: ./status.sh"
echo "   ‚Ä¢ Zobacz logi: ./logs.sh" 
echo "   ‚Ä¢ Zatrzymaj: ./stop.sh"
echo ""
EOF

    cat > go-game-single/stop.sh << 'EOF'
#!/bin/bash
echo "üõë Zatrzymywanie GO Game Single Port Platform..."
cd go-game-single
docker-compose down
echo "‚úÖ Platforma zatrzymana!"
EOF

    cat > go-game-single/restart.sh << 'EOF'
#!/bin/bash
echo "üîÅ Restartowanie GO Game Single Port Platform..."
cd go-game-single
docker-compose restart
echo "‚úÖ Platforma zrestartowana!"
EOF

    cat > go-game-single/logs.sh << 'EOF'
#!/bin/bash
echo "üìã Logi GO Game Single Port Platform:"
cd go-game-single
docker-compose logs -f
EOF

    cat > go-game-single/status.sh << EOF
#!/bin/bash
echo "üìä Status GO Game Single Port Platform:"
cd go-game-single
docker-compose ps

echo ""
echo "üåç Publiczny Adres Dostƒôpu:"
echo "   http://$SERVER_IP:$MAIN_PORT"
echo ""
echo "üëë Administrator: kacpros"
echo "üè† Serwer: $SERVER_IP"
echo "üîß Port: $MAIN_PORT"
echo ""
echo "üí° Platforma jest PUBLICZNIE DOSTƒòPNA!"
echo "   Udostƒôpnij: http://$SERVER_IP:$MAIN_PORT"
EOF

    # Nadawanie uprawnie≈Ñ
    chmod +x go-game-single/*.sh

    print_success "‚úÖ GO Game Single Port Platform gotowa!"
    echo ""
    echo "üìÅ Projekt: ./go-game-single/"
    echo ""
    echo "üöÄ Uruchomienie:"
    echo "   ./go-game-single/start.sh"
    echo ""
    echo "üåç PUBLICZNY ADRES:"
    echo "   http://$SERVER_IP:$MAIN_PORT"
    echo ""
    echo "üîß Jeden port: $MAIN_PORT"
    echo ""
    print_success "üí° Platforma bƒôdzie PUBLICZNIE DOSTƒòPNA przez jeden port!"
    echo ""
    print_info "Nastƒôpny krok: Uruchom './go-game-single/start.sh'"
    
    # Zapisz informacje o instalacji
    cat > go-game-single/INSTALL_INFO.txt << EOF
GO GAME SINGLE PORT PLATFORM - INFORMACJE O INSTALACJI

Data instalacji: $(date)
Publiczny adres: http://$SERVER_IP:$MAIN_PORT
Port: $MAIN_PORT

Administrator: kacpros
Architektura: Single Port

SKRYPTY ZARZƒÑDZANIA:
  ./start.sh    - Uruchom platformƒô
  ./stop.sh     - Zatrzymaj platformƒô  
  ./restart.sh  - Restartuj platformƒô
  ./status.sh   - Status us≈Çugi
  ./logs.sh     - Logi na ≈ºywo

LOG INSTALACJI: $LOG_FILE

UWAGA: Platforma jest publicznie dostƒôpna pod adresem:
       http://$SERVER_IP:$MAIN_PORT
EOF

    print_success "üìÑ Informacje o instalacji zapisane w: go-game-single/INSTALL_INFO.txt"
}

# Funkcja czyszczenia
cleanup() {
    print_error "Instalacja przerwana!"
    exit 1
}

trap cleanup SIGINT SIGTERM

# Uruchom instalacjƒô
install_go_game
