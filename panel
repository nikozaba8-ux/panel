#!/bin/bash

# =============================================
# üü£ PURPLEHOST - PRAWDZIWE SERWERY MINECRAFT
# =============================================

# Automatyczne wykrywanie ≈õcie≈ºki
PANEL_DIR="/home/purplehost"
mkdir -p "$PANEL_DIR"

# Konfiguracja
WEB_DIR="$PANEL_DIR/web"
SERVER_DIR="$PANEL_DIR/serwery"
DB_DIR="$PANEL_DIR/bazy"
BACKUP_DIR="$PANEL_DIR/backupy"
LOG_DIR="$PANEL_DIR/logs"
PORT=8080

# Kolory
PURPLE='\033[0;35m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================
# üõ†Ô∏è FUNKCJE
# =============================================

log() {
    echo -e "${PURPLE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
    mkdir -p "$LOG_DIR"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_DIR/panel.log"
}

create_structure() {
    echo -e "${PURPLE}üìÅ Tworzenie struktury...${NC}"
    mkdir -p "$PANEL_DIR" "$WEB_DIR" "$SERVER_DIR" "$DB_DIR" "$BACKUP_DIR" "$LOG_DIR"
    mkdir -p "$SERVER_DIR/minecraft" "$SERVER_DIR/backups"
    
    cat > "$DB_DIR/serwery.json" << 'EOF'
[]
EOF
    echo -e "${GREEN}‚úÖ Struktura utworzona${NC}"
}

check_dependencies() {
    echo -e "${PURPLE}üîç Sprawdzanie zale≈ºno≈õci...${NC}"
    
    if ! command -v python3 &> /dev/null; then
        echo "Instalowanie Python 3..."
        apt update && apt install -y python3 python3-pip
    fi
    
    if ! command -v java &> /dev/null; then
        echo "Instalowanie Java..."
        apt install -y openjdk-17-jre-headless
    fi
    
    if ! command -v wget &> /dev/null; then
        apt install -y wget
    fi
    
    echo -e "${GREEN}‚úÖ Zale≈ºno≈õci sprawdzone${NC}"
}

# =============================================
# üêç BACKEND - PRAWDZIWE SERWERY
# =============================================

create_backend() {
    echo -e "${PURPLE}üîß Tworzenie backend API...${NC}"
    
    cat > "$WEB_DIR/api.py" << 'PYTHON'
#!/usr/bin/env python3
import json
import os
import subprocess
import shutil
import threading
import time
import select
from datetime import datetime
import urllib.request
import base64

# Linki do oficjalnych serwer√≥w Minecraft
MINECRAFT_VERSIONS = {
    "1.20.1": "https://piston-data.mojang.com/v1/objects/84194a2f286ef7c14ed7ce0090dba59902951553/server.jar",
    "1.19.4": "https://piston-data.mojang.com/v1/objects/8b9111e882ad64c66cd1639b3e04d6c7cbb6b13a/server.jar", 
    "1.18.2": "https://piston-data.mojang.com/v1/objects/c8f83c5655308435b3dcf03c06d9fe8740a77469/server.jar"
}

class RealMinecraftServer:
    def __init__(self, server_id, name, version, ram, port, path):
        self.server_id = server_id
        self.name = name
        self.version = version
        self.ram = ram
        self.port = port
        self.path = path
        self.process = None
        self.status = "stopped"
        self.console_buffer = []
        self.console_callbacks = []
        self.players = []
        self.start_time = None
        
    def download_server_jar(self):
        """Pobiera prawdziwy server.jar z Mojang"""
        jar_path = os.path.join(self.path, "server.jar")
        if os.path.exists(jar_path):
            return True
            
        if self.version not in MINECRAFT_VERSIONS:
            self.add_console("‚ùå Nieobs≈Çugiwana wersja Minecraft")
            return False
            
        try:
            self.add_console(f"üì• Pobieranie Minecraft {self.version}...")
            url = MINECRAFT_VERSIONS[self.version]
            urllib.request.urlretrieve(url, jar_path)
            
            if os.path.exists(jar_path):
                self.add_console("‚úÖ Pobrano server.jar")
                return True
            else:
                self.add_console("‚ùå B≈ÇƒÖd pobierania server.jar")
                return False
                
        except Exception as e:
            self.add_console(f"‚ùå B≈ÇƒÖd pobierania: {e}")
            return False
    
    def setup_server_files(self):
        """Konfiguruje pliki serwera"""
        try:
            # server.properties
            with open(os.path.join(self.path, "server.properties"), "w") as f:
                f.write(f"""# Minecraft Server
max-players=20
online-mode=false
server-port={self.port}
motd={self.name} - PurpleHost
level-type=default
spawn-protection=0
view-distance=10
""")
            
            # eula.txt
            with open(os.path.join(self.path, "eula.txt"), "w") as f:
                f.write("eula=true\\n")
            
            # start.sh
            start_script = os.path.join(self.path, "start.sh")
            with open(start_script, "w") as f:
                f.write(f"""#!/bin/bash
cd "{self.path}"
echo "Starting Minecraft Server {self.name}"
echo "Port: {self.port}"
echo "RAM: {self.ram}"
java -Xmx{self.ram} -Xms1G -jar server.jar nogui
""")
            os.chmod(start_script, 0o755)
            
            # ops.json
            with open(os.path.join(self.path, "ops.json"), "w") as f:
                f.write("[]\\n")
                
            return True
            
        except Exception as e:
            self.add_console(f"‚ùå B≈ÇƒÖd konfiguracji: {e}")
            return False
    
    def start(self):
        """Uruchamia PRAWDZIWY serwer Minecraft"""
        if self.status != "stopped":
            return False
            
        # Pobierz server.jar je≈õli nie istnieje
        if not self.download_server_jar():
            return False
            
        # Skonfiguruj pliki
        if not self.setup_server_files():
            return False
            
        try:
            self.add_console("üöÄ Uruchamianie serwera Minecraft...")
            
            # Uruchom proces Java
            cmd = f"cd {self.path} && java -Xmx{self.ram} -Xms1G -jar server.jar nogui"
            self.process = subprocess.Popen(
                cmd,
                shell=True,
                stdin=subprocess.PIPE,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                universal_newlines=True,
                bufsize=1
            )
            
            self.status = "starting"
            self.start_time = datetime.now()
            
            # WƒÖtek do odczytu konsoli
            threading.Thread(target=self._read_console, daemon=True).start()
            
            return True
            
        except Exception as e:
            self.add_console(f"‚ùå B≈ÇƒÖd uruchamiania: {e}")
            return False
    
    def stop(self):
        """Zatrzymuje serwer"""
        if self.status != "running" or not self.process:
            return False
            
        try:
            self.add_console("üõë Zatrzymywanie serwera...")
            self.send_command("stop")
            
            # Czekaj max 10 sekund
            for i in range(10):
                if self.process.poll() is not None:
                    break
                time.sleep(1)
            
            # Force kill je≈õli wciƒÖ≈º dzia≈Ça
            if self.process.poll() is None:
                self.process.terminate()
                time.sleep(2)
                if self.process.poll() is None:
                    self.process.kill()
            
            self.status = "stopped"
            self.players = []
            self.add_console("‚úÖ Serwer zatrzymany")
            return True
            
        except Exception as e:
            self.add_console(f"‚ùå B≈ÇƒÖd zatrzymywania: {e}")
            return False
    
    def send_command(self, command):
        """Wysy≈Ça komendƒô do konsoli serwera"""
        if self.process and self.process.poll() is None:
            try:
                self.process.stdin.write(command + "\\n")
                self.process.stdin.flush()
                self.add_console(f"> {command}")
                return True
            except:
                return False
        return False
    
    def _read_console(self):
        """Czyta output z konsoli serwera"""
        while self.process and self.process.poll() is None:
            try:
                line = self.process.stdout.readline()
                if line:
                    line = line.strip()
                    if line:
                        self._process_console_output(line)
            except:
                break
        
        # Serwer siƒô zamknƒÖ≈Ç
        if self.status == "running":
            self.status = "stopped"
            self.add_console("üí• Serwer zosta≈Ç zamkniƒôty")
    
    def _process_console_output(self, line):
        """Przetwarza output z konsoli"""
        self.add_console(line)
        
        # Wykrywanie gotowo≈õci serwera
        if "Done" in line and "For help, type \"help\"" in line:
            self.status = "running"
            self.add_console("‚úÖ Serwer Minecraft gotowy!")
            self.add_console(f"üåê Adres: localhost:{self.port}")
            
        # Wykrywanie graczy
        elif "joined the game" in line:
            player = line.split("]")[1].split(" joined the game")[0].strip()
            if player not in self.players:
                self.players.append(player)
                self.add_console(f"üë§ {player} do≈ÇƒÖczy≈Ç do gry")
                
        elif "left the game" in line:
            player = line.split("]")[1].split(" left the game")[0].strip()
            if player in self.players:
                self.players.remove(player)
                self.add_console(f"üë§ {player} opu≈õci≈Ç grƒô")
    
    def add_console(self, message):
        """Dodaje wiadomo≈õƒá do konsoli"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        full_message = f"[{timestamp}] {message}"
        self.console_buffer.append(full_message)
        
        # Ogranicz do 200 linii
        if len(self.console_buffer) > 200:
            self.console_buffer = self.console_buffer[-200:]
        
        # Wywo≈Çaj callbacki
        for callback in self.console_callbacks:
            callback(full_message)
    
    def get_console(self, lines=50):
        """Pobiera ostatnie linie konsoli"""
        return "\\n".join(self.console_buffer[-lines:])
    
    def get_players(self):
        """Zwraca listƒô graczy"""
        return self.players
    
    def get_uptime(self):
        """Zwraca czas dzia≈Çania"""
        if self.start_time and self.status == "running":
            uptime = datetime.now() - self.start_time
            hours = int(uptime.total_seconds() // 3600)
            minutes = int((uptime.total_seconds() % 3600) // 60)
            return f"{hours}h {minutes}m"
        return "0s"

class ServerManager:
    def __init__(self):
        self.servers_data = []
        self.real_servers = {}  # Prawdziwe instancje serwer√≥w
        self.load_servers()
    
    def load_servers(self):
        try:
            with open("/home/purplehost/bazy/serwery.json", "r") as f:
                self.servers_data = json.load(f)
        except:
            self.servers_data = []
    
    def save_servers(self):
        with open("/home/purplehost/bazy/serwery.json", "w") as f:
            json.dump(self.servers_data, f, indent=2)
    
    def get_next_port(self):
        base_port = 25565
        used_ports = [s.get('port', 0) for s in self.servers_data]
        while base_port in used_ports:
            base_port += 1
        return base_port
    
    def create_server(self, name, version, ram="2G"):
        server_id = len(self.servers_data) + 1
        port = self.get_next_port()
        
        # Utw√≥rz folder serwera
        folder_name = name.replace(" ", "_").lower()
        server_path = f"/home/purplehost/serwery/minecraft/{folder_name}"
        os.makedirs(server_path, exist_ok=True)
        
        server_data = {
            "id": server_id,
            "name": name,
            "version": version,
            "ram": ram,
            "port": port,
            "status": "stopped",
            "players": "0/20",
            "created": datetime.now().isoformat(),
            "uptime": "0s",
            "path": server_path,
            "folder": folder_name
        }
        
        # Utw√≥rz prawdziwƒÖ instancjƒô serwera
        real_server = RealMinecraftServer(server_id, name, version, ram, port, server_path)
        self.real_servers[server_id] = real_server
        
        self.servers_data.append(server_data)
        self.save_servers()
        
        return server_data
    
    def start_server(self, server_id):
        if server_id in self.real_servers:
            server = self.real_servers[server_id]
            if server.start():
                self._update_server_data(server_id)
                return True
        return False
    
    def stop_server(self, server_id):
        if server_id in self.real_servers:
            server = self.real_servers[server_id]
            if server.stop():
                self._update_server_data(server_id)
                return True
        return False
    
    def send_command(self, server_id, command):
        if server_id in self.real_servers:
            return self.real_servers[server_id].send_command(command)
        return False
    
    def get_console(self, server_id, lines=50):
        if server_id in self.real_servers:
            return self.real_servers[server_id].get_console(lines)
        return "Serwer nieaktywny"
    
    def get_server_files(self, server_id, path=""):
        server = self.get_server(server_id)
        if not server:
            return []
        
        base_path = server["path"]
        if path:
            target_path = os.path.join(base_path, path)
        else:
            target_path = base_path
        
        if not os.path.exists(target_path):
            return []
        
        files = []
        for item in os.listdir(target_path):
            item_path = os.path.join(target_path, item)
            rel_path = os.path.join(path, item) if path else item
            
            files.append({
                "name": item,
                "path": rel_path,
                "is_directory": os.path.isdir(item_path),
                "size": os.path.getsize(item_path) if os.path.isfile(item_path) else 0,
                "modified": os.path.getmtime(item_path)
            })
        
        return sorted(files, key=lambda x: (not x["is_directory"], x["name"]))
    
    def get_file_content(self, server_id, file_path):
        server = self.get_server(server_id)
        if not server:
            return None
        
        full_path = os.path.join(server["path"], file_path)
        if not os.path.exists(full_path) or not os.path.isfile(full_path):
            return None
        
        try:
            with open(full_path, 'r', encoding='utf-8', errors='ignore') as f:
                return f.read()
        except:
            return None
    
    def save_file_content(self, server_id, file_path, content):
        server = self.get_server(server_id)
        if not server:
            return False
        
        full_path = os.path.join(server["path"], file_path)
        try:
            os.makedirs(os.path.dirname(full_path), exist_ok=True)
            with open(full_path, 'w', encoding='utf-8') as f:
                f.write(content)
            return True
        except:
            return False

    def upload_file(self, server_id, file_path, file_content):
        """Wgrywa plik do serwera"""
        server = self.get_server(server_id)
        if not server:
            return False
        
        full_path = os.path.join(server["path"], file_path)
        try:
            os.makedirs(os.path.dirname(full_path), exist_ok=True)
            
            # Dekoduj base64 je≈õli to plik binarny
            if file_content.startswith('data:'):
                # Pomijamy nag≈Ç√≥wek data:application/octet-stream;base64,
                file_content = file_content.split(',')[1]
                file_data = base64.b64decode(file_content)
                with open(full_path, 'wb') as f:
                    f.write(file_data)
            else:
                with open(full_path, 'w', encoding='utf-8') as f:
                    f.write(file_content)
            
            return True
        except Exception as e:
            print(f"B≈ÇƒÖd wgrywania pliku: {e}")
            return False
    
    def _update_server_data(self, server_id):
        """Aktualizuje dane serwera na podstawie prawdziwej instancji"""
        if server_id in self.real_servers:
            real_server = self.real_servers[server_id]
            
            for server_data in self.servers_data:
                if server_data["id"] == server_id:
                    server_data["status"] = real_server.status
                    server_data["players"] = f"{len(real_server.players)}/20"
                    server_data["uptime"] = real_server.get_uptime()
                    break
            
            self.save_servers()
    
    def get_server(self, server_id):
        for server in self.servers_data:
            if server["id"] == server_id:
                return server
        return None
    
    def get_all_servers(self):
        # Aktualizuj wszystkie serwery
        for server_id in self.real_servers:
            self._update_server_data(server_id)
        
        return self.servers_data

# Globalna instancja
server_manager = ServerManager()
PYTHON
    echo -e "${GREEN}‚úÖ Backend utworzony${NC}"
}

# =============================================
# üåê PANEL WEB Z KONSOLƒÑ, PLIKAMI I WGRYWANIEM
# =============================================

create_web_panel() {
    echo -e "${PURPLE}üåê Tworzenie panelu web...${NC}"
    
    cat > "$WEB_DIR/index.html" << 'HTML'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ PurpleHost - Prawdziwe Serwery Minecraft</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --secondary: #06D6A0;
            --accent: #FF6B6B;
            --dark: #1E1B2E;
            --darker: #151321;
            --light: #F8FAFC;
            --gray: #64748B;
        }
        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        .logo {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--secondary), #05C189);
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--accent), #FF5252);
        }
        .btn-warning {
            background: linear-gradient(135deg, #FFA726, #FB8C00);
        }
        .servers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .server-card {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1.5rem;
            transition: transform 0.3s;
        }
        .server-card:hover {
            transform: translateY(-5px);
        }
        .server-status {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-online {
            background: rgba(6, 214, 160, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(6, 214, 160, 0.3);
        }
        .status-offline {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        .modal-content {
            background: var(--dark);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
        }
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body {
            padding: 2rem;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }
        .console-container {
            background: #000;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .console-output {
            color: #00ff00;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        .console-input {
            display: flex;
            gap: 0.5rem;
        }
        .console-input input {
            flex: 1;
            padding: 0.75rem;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
            font-family: 'Courier New', monospace;
        }
        .file-manager {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
        }
        .file-item:hover {
            background: rgba(255,255,255,0.1);
        }
        .file-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }
        .upload-area.dragover {
            border-color: var(--secondary);
            background: rgba(6, 214, 160, 0.1);
        }
        .server-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        @media (max-width: 1024px) {
            .server-management {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-rocket"></i>
                PurpleHost
            </div>
            <h1>üí• Prawdziwe Serwery Minecraft</h1>
            <p>Tw√≥rz, zarzƒÖdzaj i graj na prawdziwych serwerach!</p>
        </div>

        <div style="text-align: center; margin-bottom: 2rem;">
            <button class="btn" onclick="showCreateServer()">
                <i class="fas fa-plus"></i> Utw√≥rz Nowy Serwer
            </button>
        </div>

        <div class="servers-grid" id="serversContainer">
            <!-- Serwery bƒôdƒÖ ≈Çadowane tutaj -->
        </div>
    </div>

    <!-- Modal tworzenia serwera -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üéÆ Utw√≥rz Nowy Serwer Minecraft</h3>
                <span onclick="closeModal('createModal')" style="cursor:pointer;font-size:1.5rem;">&times;</span>
            </div>
            <div class="modal-body">
                <div style="max-width: 500px; margin: 0 auto;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem;">Nazwa serwera:</label>
                        <input type="text" id="serverName" placeholder="np. M√≥j Serwer" style="width:100%; padding:0.75rem; border-radius:6px; border:1px solid #333; background:#1a1a1a; color:white;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem;">Wersja Minecraft:</label>
                        <select id="serverVersion" style="width:100%; padding:0.75rem; border-radius:6px; border:1px solid #333; background:#1a1a1a; color:white;">
                            <option value="1.20.1">1.20.1 (Latest)</option>
                            <option value="1.19.4">1.19.4</option>
                            <option value="1.18.2">1.18.2</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem;">RAM:</label>
                        <select id="serverRAM" style="width:100%; padding:0.75rem; border-radius:6px; border:1px solid #333; background:#1a1a1a; color:white;">
                            <option value="2G">2 GB</option>
                            <option value="4G">4 GB</option>
                            <option value="8G">8 GB</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:1rem; justify-content:flex-end;">
                        <button class="btn" onclick="closeModal('createModal')">Anuluj</button>
                        <button class="btn btn-success" onclick="createServer()">Utw√≥rz Serwer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal zarzƒÖdzania serwerem -->
    <div id="manageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manageTitle">üéÆ ZarzƒÖdzanie Serwerem</h3>
                <span onclick="closeModal('manageModal')" style="cursor:pointer;font-size:1.5rem;">&times;</span>
            </div>
            <div class="modal-body">
                <div class="server-management">
                    <!-- Konsola -->
                    <div>
                        <h4 style="margin-bottom:1rem;">üñ•Ô∏è Konsola Serwera</h4>
                        <div class="console-container">
                            <div class="console-output" id="consoleOutput">≈Åadowanie konsoli...</div>
                        </div>
                        <div class="console-input">
                            <input type="text" id="consoleInput" placeholder="Wpisz komendƒô (help, say, gamemode...)">
                            <button class="btn" onclick="sendCommand()">Wy≈õlij</button>
                        </div>
                    </div>

                    <!-- Pliki -->
                    <div>
                        <h4 style="margin-bottom:1rem;">üìÅ Pliki Serwera</h4>
                        
                        <div class="file-actions">
                            <button class="btn btn-warning" onclick="showUploadModal()">
                                <i class="fas fa-upload"></i> Wgraj Pliki
                            </button>
                            <button class="btn" onclick="loadFiles()">
                                <i class="fas fa-sync"></i> Od≈õwie≈º
                            </button>
                        </div>

                        <div class="file-manager" id="fileManager">
                            ≈Åadowanie plik√≥w...
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem; text-align: center;">
                    <button class="btn btn-success" id="startBtn" onclick="startServer()">üöÄ Start Serwer</button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopServer()" style="display:none;">üõë Stop Serwer</button>
                    <button class="btn" onclick="refreshManager()">üîÑ Od≈õwie≈º</button>
                </div>

                <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4>üåê Jak siƒô pod≈ÇƒÖczyƒá:</h4>
                    <p>1. Uruchom serwer (poczekaj a≈º bƒôdzie "Done" w konsoli)</p>
                    <p>2. W Minecraft: Multiplayer ‚Üí Direct Connect</p>
                    <p>3. Adres: <strong id="serverAddress">localhost:PORT</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal wgrywania plik√≥w -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì§ Wgrywanie Plik√≥w</h3>
                <span onclick="closeModal('uploadModal')" style="cursor:pointer;font-size:1.5rem;">&times;</span>
            </div>
            <div class="modal-body">
                <div style="max-width: 600px; margin: 0 auto;">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                        <h4>Kliknij lub przeciƒÖgnij pliki tutaj</h4>
                        <p>Mo≈ºesz wgraƒá pliki .jar, .zip, ≈õwiaty, pluginy i inne</p>
                    </div>
                    
                    <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(this.files)">
                    
                    <div id="uploadProgress" style="margin-top: 1rem;"></div>
                    
                    <div style="margin-top: 2rem;">
                        <h4>üí° Przyk≈Çadowe pliki do wgrania:</h4>
                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <li>Pluginy Bukkit/Spigot (.jar)</li>
                            <li>≈öwiaty Minecraft (folder world/)</li>
                            <li>Konfiguracje plugin√≥w</li>
                            <li>W≈Çasne skrypty startowe</li>
                        </ul>
                    </div>
                    
                    <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top: 2rem;">
                        <button class="btn" onclick="closeModal('uploadModal')">Zamknij</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentServerId = null;
        let consoleInterval = null;
        let currentPath = '';

        // API functions
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch('/api' + endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                return await response.json();
            } catch (error) {
                alert('B≈ÇƒÖd po≈ÇƒÖczenia z serwerem');
                console.error(error);
            }
        }

        // Server management
        async function loadServers() {
            const servers = await apiRequest('/servers');
            if (!servers) return;

            const container = document.getElementById('serversContainer');
            
            if (servers.length === 0) {
                container.innerHTML = '<div class="server-card"><h3>Brak serwer√≥w</h3><p>Utw√≥rz pierwszy serwer Minecraft</p></div>';
                return;
            }

            container.innerHTML = servers.map(server => `
                <div class="server-card">
                    <h3>${server.name}</h3>
                    <p>Minecraft ${server.version} ‚Ä¢ ${server.ram} RAM</p>
                    <p>Port: ${server.port} ‚Ä¢ Gracze: ${server.players}</p>
                    <p>Czas dzia≈Çania: ${server.uptime}</p>
                    <span class="server-status ${server.status === 'online' ? 'status-online' : 'status-offline'}">
                        ${server.status === 'online' ? 'ONLINE' : 'OFFLINE'}
                    </span>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${server.status === 'online' ? 
                            '<button class="btn btn-danger" onclick="stopServerFromList(' + server.id + ')">üõë Stop</button>' : 
                            '<button class="btn btn-success" onclick="startServerFromList(' + server.id + ')">üöÄ Start</button>'
                        }
                        <button class="btn" onclick="manageServer(${server.id})">‚öôÔ∏è ZarzƒÖdzaj</button>
                    </div>
                </div>
            `).join('');
        }

        async function createServer() {
            const name = document.getElementById('serverName').value;
            const version = document.getElementById('serverVersion').value;
            const ram = document.getElementById('serverRAM').value;

            if (!name) {
                alert('Podaj nazwƒô serwera');
                return;
            }

            const server = await apiRequest('/servers', {
                method: 'POST',
                body: JSON.stringify({ name, version, ram })
            });

            if (server) {
                alert('üéâ Serwer utworzony! Teraz mo≈ºesz go uruchomiƒá.');
                closeModal('createModal');
                loadServers();
            }
        }

        function showCreateServer() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'manageModal') {
                clearInterval(consoleInterval);
                currentServerId = null;
            }
        }

        function startServerFromList(serverId) {
            apiRequest('/servers/' + serverId + '/start');
            setTimeout(loadServers, 2000);
        }

        function stopServerFromList(serverId) {
            apiRequest('/servers/' + serverId + '/stop');
            setTimeout(loadServers, 2000);
        }

        async function manageServer(serverId) {
            currentServerId = serverId;
            const server = (await apiRequest('/servers')).find(s => s.id === serverId);
            
            if (!server) return;

            document.getElementById('manageTitle').textContent = `üéÆ ZarzƒÖdzanie: ${server.name}`;
            document.getElementById('serverAddress').textContent = `localhost:${server.port}`;
            
            // Ustaw przyciski
            document.getElementById('startBtn').style.display = server.status === 'online' ? 'none' : 'inline-flex';
            document.getElementById('stopBtn').style.display = server.status === 'online' ? 'inline-flex' : 'none';

            // Za≈Çaduj konsolƒô i pliki
            updateConsole();
            loadFiles();

            // Auto-od≈õwie≈ºanie konsoli
            clearInterval(consoleInterval);
            consoleInterval = setInterval(updateConsole, 2000);

            document.getElementById('manageModal').style.display = 'block';
        }

        async function updateConsole() {
            if (!currentServerId) return;
            const output = await apiRequest('/servers/' + currentServerId + '/console');
            document.getElementById('consoleOutput').textContent = output || 'Brak danych';
            document.getElementById('consoleOutput').scrollTop = document.getElementById('consoleOutput').scrollHeight;
        }

        async function sendCommand() {
            if (!currentServerId) return;
            const input = document.getElementById('consoleInput');
            const command = input.value.trim();
            
            if (command) {
                await apiRequest('/servers/' + currentServerId + '/command', {
                    method: 'POST',
                    body: JSON.stringify({ command })
                });
                input.value = '';
                setTimeout(updateConsole, 500);
            }
        }

        async function loadFiles(path = '') {
            if (!currentServerId) return;
            currentPath = path;
            const files = await apiRequest('/servers/' + currentServerId + '/files?path=' + encodeURIComponent(path));
            
            const fileManager = document.getElementById('fileManager');
            if (!files || files.length === 0) {
                fileManager.innerHTML = 'Brak plik√≥w';
                return;
            }

            let breadcrumbs = '';
            if (path) {
                const parts = path.split('/').filter(p => p);
                let current = '';
                breadcrumbs = `<div style="margin-bottom: 1rem;">
                    <span class="file-item" onclick="loadFiles('')"><i class="fas fa-home"></i> G≈Ç√≥wny</span>`;
                
                parts.forEach((part, index) => {
                    current += (current ? '/' : '') + part;
                    const isLast = index === parts.length - 1;
                    breadcrumbs += ` / <span class="file-item" onclick="loadFiles('${current}')" style="${isLast ? 'font-weight: bold;' : ''}">${part}</span>`;
                });
                breadcrumbs += '</div>';
            }

            fileManager.innerHTML = breadcrumbs + files.map(file => `
                <div class="file-item" onclick="${file.is_directory ? `loadFiles('${file.path}')` : `viewFile('${file.path}')`}">
                    <i class="fas fa-${file.is_directory ? 'folder' : 'file'}"></i>
                    <span>${file.name}</span>
                    ${!file.is_directory ? `<small>(${formatFileSize(file.size)})</small>` : ''}
                </div>
            `).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function viewFile(filePath) {
            alert('PodglƒÖd pliku: ' + filePath + '\n(Edytor plik√≥w wkr√≥tce!)');
        }

        async function startServer() {
            if (!currentServerId) return;
            await apiRequest('/servers/' + currentServerId + '/start');
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-flex';
            setTimeout(() => {
                updateConsole();
                loadServers();
            }, 2000);
        }

        async function stopServer() {
            if (!currentServerId) return;
            await apiRequest('/servers/' + currentServerId + '/stop');
            document.getElementById('startBtn').style.display = 'inline-flex';
            document.getElementById('stopBtn').style.display = 'none';
            setTimeout(() => {
                updateConsole();
                loadServers();
            }, 2000);
        }

        function refreshManager() {
            updateConsole();
            loadFiles();
            loadServers();
        }

        // Upload functions
        function showUploadModal() {
            document.getElementById('uploadModal').style.display = 'block';
        }

        function handleFileSelect(files) {
            const progress = document.getElementById('uploadProgress');
            progress.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                uploadFile(file, index, files.length);
            });
        }

        async function uploadFile(file, index, total) {
            const progress = document.getElementById('uploadProgress');
            const progressItem = document.createElement('div');
            progressItem.innerHTML = `<div style="margin-bottom: 0.5rem;">
                <strong>${file.name}</strong> (${formatFileSize(file.size)})
                <div id="progress-${index}" style="background: #333; border-radius: 4px; margin-top: 0.25rem;">
                    <div style="background: var(--secondary); height: 4px; width: 0%; border-radius: 4px; transition: width 0.3s;"></div>
                </div>
            </div>`;
            progress.appendChild(progressItem);
            
            try {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    // Dla plik√≥w binarnych u≈ºywamy base64
                    const isBinary = file.type && !file.type.startsWith('text/');
                    let fileContent;
                    
                    if (isBinary) {
                        fileContent = 'data:application/octet-stream;base64,' + btoa(
                            new Uint8Array(e.target.result).reduce((data, byte) => data + String.fromCharCode(byte), '')
                        );
                    } else {
                        fileContent = e.target.result;
                    }
                    
                    // ≈öcie≈ºka docelowa
                    const targetPath = currentPath ? currentPath + '/' + file.name : file.name;
                    
                    const result = await apiRequest('/servers/' + currentServerId + '/upload', {
                        method: 'POST',
                        body: JSON.stringify({
                            file_path: targetPath,
                            file_content: fileContent
                        })
                    });
                    
                    if (result && result.success) {
                        document.querySelector(`#progress-${index} > div`).style.width = '100%';
                        progressItem.innerHTML += '<span style="color: var(--secondary);"> ‚úÖ Wgrano pomy≈õlnie</span>';
                        
                        // Od≈õwie≈º listƒô plik√≥w po ostatnim pliku
                        if (index === total - 1) {
                            setTimeout(() => {
                                loadFiles(currentPath);
                                closeModal('uploadModal');
                            }, 1000);
                        }
                    } else {
                        progressItem.innerHTML += '<span style="color: var(--accent);"> ‚ùå B≈ÇƒÖd wgrywania</span>';
                    }
                };
                
                if (file.type && !file.type.startsWith('text/')) {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
                
            } catch (error) {
                console.error('B≈ÇƒÖd wgrywania:', error);
                progressItem.innerHTML += '<span style="color: var(--accent);"> ‚ùå B≈ÇƒÖd wgrywania</span>';
            }
        }

        // Drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFileSelect(files);
            });
        });

        // Auto-od≈õwie≈ºanie listy serwer√≥w
        loadServers();
        setInterval(loadServers, 5000);

        // Obs≈Çuga Enter w konsoli
        document.getElementById('consoleInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendCommand();
        });
    </script>
</body>
</html>
HTML
    echo -e "${GREEN}‚úÖ Panel web utworzony${NC}"
}

# =============================================
# üîÑ SERWER WEB Z API I WGRYWANIEM PLIK√ìW
# =============================================

create_web_server() {
    echo -e "${PURPLE}üöÄ Tworzenie serwera web...${NC}"
    
    cat > "$WEB_DIR/server.py" << 'PYTHON'
#!/usr/bin/env python3
import http.server
import socketserver
import os
import json
import urllib.parse
from api import server_manager

PORT = 8080
WEB_DIR = "/home/purplehost/web"

class Handler(http.server.SimpleHTTPRequestHandler):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, directory=WEB_DIR, **kwargs)
    
    def do_GET(self):
        if self.path.startswith('/api/'):
            self.handle_api()
        else:
            if self.path == '/':
                self.path = '/index.html'
            super().do_GET()
    
    def do_POST(self):
        if self.path.startswith('/api/'):
            self.handle_api()
        else:
            self.send_error(404)
    
    def handle_api(self):
        try:
            path_parts = self.path.split('/')
            
            if len(path_parts) >= 3 and path_parts[2] == 'servers':
                if len(path_parts) == 3:
                    # GET /api/servers
                    if self.command == 'GET':
                        self.send_json(server_manager.get_all_servers())
                    # POST /api/servers
                    elif self.command == 'POST':
                        content_length = int(self.headers['Content-Length'])
                        body = self.rfile.read(content_length).decode()
                        data = json.loads(body)
                        server = server_manager.create_server(**data)
                        self.send_json(server, 201)
                
                elif len(path_parts) >= 4:
                    server_id = int(path_parts[3])
                    
                    if len(path_parts) == 4:
                        # GET /api/servers/{id}
                        if self.command == 'GET':
                            server = server_manager.get_server(server_id)
                            if server:
                                self.send_json(server)
                            else:
                                self.send_error(404)
                    
                    elif len(path_parts) == 5:
                        action = path_parts[4]
                        
                        if action == 'start':
                            # POST /api/servers/{id}/start
                            if self.command == 'POST':
                                if server_manager.start_server(server_id):
                                    self.send_json({'success': True})
                                else:
                                    self.send_json({'error': 'Server not found'}, 404)
                        
                        elif action == 'stop':
                            # POST /api/servers/{id}/stop
                            if self.command == 'POST':
                                if server_manager.stop_server(server_id):
                                    self.send_json({'success': True})
                                else:
                                    self.send_json({'error': 'Server not found'}, 404)
                        
                        elif action == 'console':
                            # GET /api/servers/{id}/console
                            if self.command == 'GET':
                                console_output = server_manager.get_console(server_id)
                                self.send_json(console_output)
                        
                        elif action == 'files':
                            # GET /api/servers/{id}/files
                            if self.command == 'GET':
                                query = urllib.parse.urlparse(self.path).query
                                params = urllib.parse.parse_qs(query)
                                path = params.get('path', [''])[0]
                                files = server_manager.get_server_files(server_id, path)
                                self.send_json(files)
                    
                    elif len(path_parts) == 6 and path_parts[4] == 'command':
                        # POST /api/servers/{id}/command
                        if self.command == 'POST':
                            content_length = int(self.headers['Content-Length'])
                            body = self.rfile.read(content_length).decode()
                            data = json.loads(body)
                            command = data.get('command', '')
                            if command:
                                success = server_manager.send_command(server_id, command)
                                self.send_json({'success': success})
                            else:
                                self.send_json({'error': 'No command'}, 400)
                    
                    elif len(path_parts) == 6 and path_parts[4] == 'upload':
                        # POST /api/servers/{id}/upload
                        if self.command == 'POST':
                            content_length = int(self.headers['Content-Length'])
                            body = self.rfile.read(content_length).decode()
                            data = json.loads(body)
                            file_path = data.get('file_path', '')
                            file_content = data.get('file_content', '')
                            
                            if file_path and file_content:
                                success = server_manager.upload_file(server_id, file_path, file_content)
                                self.send_json({'success': success})
                            else:
                                self.send_json({'error': 'Missing file data'}, 400)
                
                else:
                    self.send_error(404)
            else:
                self.send_error(404)
                
        except Exception as e:
            self.send_json({'error': str(e)}, 500)
    
    def send_json(self, data, status=200):
        self.send_response(status)
        self.send_header('Content-type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data).encode())
    
    def log_message(self, format, *args):
        print(f"üåê {self.address_string()} - {format % args}")

print(f"üöÄ PurpleHost starting on http://localhost:{PORT}")
print("üí• PRAWDZIWE SERWERY MINECRAFT + WGRYWANIE PLIK√ìW")
print("üìÅ Serving from:", WEB_DIR)

os.chdir(WEB_DIR)

try:
    with socketserver.TCPServer(("", PORT), Handler) as httpd:
        print("‚úÖ Server ready!")
        print("‚èπÔ∏è  Press Ctrl+C to stop")
        httpd.serve_forever()
except OSError as e:
    print(f"‚ùå Error: {e}")
    if "Address already in use" in str(e):
        print("üí° Port 8080 zajƒôty. Zmie≈Ñ PORT w skrypcie.")
PYTHON

    chmod +x "$WEB_DIR/server.py"
    chmod +x "$WEB_DIR/api.py"
    echo -e "${GREEN}‚úÖ Serwer web utworzony${NC}"
}

# =============================================
# üöÄ URUCHOMIENIE SYSTEMU
# =============================================

start_system() {
    echo -e "${PURPLE}üöÄ Uruchamianie PurpleHost...${NC}"
    
    # Zatrzymaj istniejƒÖce serwery
    pkill -f "server.py" 2>/dev/null
    sleep 2
    
    # Uruchom
    cd "$WEB_DIR"
    nohup python3 server.py > "$LOG_DIR/web_server.log" 2>&1 &
    
    sleep 3
    
    if ps -p $! >/dev/null 2>&1; then
        echo -e "${GREEN}üéâ PURPLEHOST DZIA≈ÅA!${NC}"
        echo ""
        echo -e "${CYAN}üåê Adres panelu: http://localhost:8080${NC}"
        echo -e "${CYAN}üí• Prawdziwe serwery Minecraft z konsolƒÖ i plikami${NC}"
        echo -e "${CYAN}üì§ Teraz z wgrywaniem plik√≥w!${NC}"
        echo ""
        echo -e "${YELLOW}üìù Jak u≈ºywaƒá:${NC}"
        echo "1. Wejd≈∫ na http://localhost:8080"
        echo "2. Utw√≥rz serwer Minecraft"
        echo "3. Uruchom serwer - pobierze siƒô server.jar"
        echo "4. Wejd≈∫ do zarzƒÖdzania - prawdziwa konsola!"
        echo "5. U≈ºyj przycisku 'Wgraj Pliki' aby dodaƒá pluginy, ≈õwiaty, etc."
        echo "6. Pod≈ÇƒÖcz siƒô z gry: localhost:PORT"
        
        if [ -n "$DISPLAY" ]; then
            xdg-open "http://localhost:8080" 2>/dev/null &
        fi
        
        # Pokazuj logi
        tail -f "$LOG_DIR/web_server.log"
    else
        echo -e "${RED}‚ùå B≈ÇƒÖd uruchamiania${NC}"
        cat "$LOG_DIR/web_server.log"
    fi
}

# =============================================
# üìú MAIN
# =============================================

clear
echo -e "${PURPLE}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë          üöÄ PURPLEHOST PRO           ‚ïë"
echo "‚ïë      Prawdziwe Serwery Minecraft     ‚ïë"
echo "‚ïë           + Wgrywanie Plik√≥w         ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"

create_structure
check_dependencies
create_backend
create_web_panel
create_web_server
start_system
