#!/bin/bash

# =============================================
# ğŸ¦– PANEL SERWERÃ“W - PRODUCTION
# =============================================

# Konfiguracja
PANEL_DIR="/home/panel"
SERVERS_DIR="$PANEL_DIR/servers"
LOGS_DIR="$PANEL_DIR/logs"
BACKUPS_DIR="$PANEL_DIR/backups"
CONFIG_DIR="$PANEL_DIR/config"
WEB_DIR="$PANEL_DIR/web"
USERS_FILE="$PANEL_DIR/users.db"
PANEL_PID_FILE="$PANEL_DIR/panel.pid"
WEB_PID_FILE="$PANEL_DIR/web.pid"
PORT=8080

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================
# ğŸ› ï¸ FUNKCJE POMOCNICZE
# =============================================

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

error() {
    echo -e "${RED}[BÅÄ„D]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

warning() {
    echo -e "${YELLOW}[OSTRZEÅ»ENIE]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

setup_directories() {
    mkdir -p "$SERVERS_DIR" "$LOGS_DIR" "$BACKUPS_DIR" "$CONFIG_DIR" "$WEB_DIR"
    log "Katalogi utworzone"
}

check_dependencies() {
    local missing=()
    for cmd in nc screen java python3 curl; do
        if ! command -v $cmd &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        warning "BrakujÄ…ce zaleÅ¼noÅ›ci: ${missing[*]}"
        echo "Instalowanie..."
        apt update > /dev/null 2>&1
        apt install -y netcat-openbsd screen default-jre python3 curl > /dev/null 2>&1
    fi
}

# =============================================
# ğŸ® ZARZÄ„DZANIE SERWERAMI
# =============================================

create_server() {
    local name="$1"
    local type="$2"
    local port="$3"
    local memory="$4"
    local owner="$5"
    
    # DomyÅ›lne wartoÅ›ci
    port=${port:-25565}
    memory=${memory:-1024}
    owner=${owner:-admin}
    
    # Generuj ID
    local id=$(echo "$name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-')
    
    # SprawdÅº czy port jest wolny
    if nc -z localhost $port 2>/dev/null; then
        echo "ERROR: Port $port jest zajÄ™ty!"
        return 1
    fi
    
    # SprawdÅº czy serwer juÅ¼ istnieje
    if [ -d "$SERVERS_DIR/$id" ]; then
        echo "ERROR: Serwer o ID '$id' juÅ¼ istnieje!"
        return 1
    fi
    
    # UtwÃ³rz katalog serwera
    mkdir -p "$SERVERS_DIR/$id"
    
    # Zapisz konfiguracjÄ™
    cat > "$SERVERS_DIR/$id/server.conf" << CONF
ID="$id"
NAME="$name"
TYPE="$type"
PORT="$port"
MEMORY="$memory"
OWNER="$owner"
STATUS="stopped"
PID=""
CREATED="$(date '+%Y-%m-%d %H:%M:%S')"
CONF

    # UtwÃ³rz skrypt startowy
    case $type in
        minecraft)
            create_minecraft_server "$id" "$memory"
            ;;
        rust)
            create_rust_server "$id" "$port"
            ;;
        ark)
            create_ark_server "$id" "$port"
            ;;
        csgo)
            create_csgo_server "$id" "$port"
            ;;
        teamspeak)
            create_teamspeak_server "$id" "$port"
            ;;
        *)
            create_custom_server "$id"
            ;;
    esac
    
    log "Utworzono serwer: $name (ID: $id, Port: $port)"
    echo "SUCCESS: Serwer '$name' utworzony pomyÅ›lnie!"
    return 0
}

create_minecraft_server() {
    local id=$1
    local memory=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << 'START'
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera Minecraft $NAME..."
echo "Port: $PORT | RAM: ${MEMORY}MB"
java -Xmx${MEMORY}M -Xms${MEMORY}M -jar server.jar nogui
START
    
    chmod +x "$dir/start.sh"
    
    # Pobierz serwer Minecraft jeÅ›li nie istnieje
    if [ ! -f "$dir/server.jar" ]; then
        echo "Pobieranie serwera Minecraft..."
        wget -q -O "$dir/server.jar" "https://piston-data.mojang.com/v1/objects/8f3112a1049751cc472ec13e397eade5336ca7ae/server.jar"
        echo "eula=true" > "$dir/eula.txt"
        
        # Podstawowa konfiguracja
        cat > "$dir/server.properties" << PROP
server-port=$PORT
online-mode=false
max-players=20
PROP
    fi
}

create_rust_server() {
    local id=$1
    local port=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << START
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera Rust $NAME..."
echo "Port: $PORT"
while true; do
    echo "[RUST] Serwer \$NAME dziaÅ‚a na porcie \$PORT - \$(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
    
    # Plik konfiguracyjny Rust
    cat > "$dir/server.cfg" << RUST_CFG
server.port $PORT
server.level "Procedural Map"
server.seed 1234
server.worldsize 4000
server.maxplayers 50
server.hostname "$NAME"
server.description "Panel Managed Rust Server"
RUST_CFG
}

create_ark_server() {
    local id=$1
    local port=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << START
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera ARK $NAME..."
echo "Port: $PORT"
while true; do
    echo "[ARK] Serwer \$NAME dziaÅ‚a na porcie \$PORT - \$(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
}

create_csgo_server() {
    local id=$1
    local port=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << START
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera CS:GO $NAME..."
echo "Port: $PORT"
while true; do
    echo "[CSGO] Serwer \$NAME dziaÅ‚a na porcie \$PORT - \$(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
}

create_teamspeak_server() {
    local id=$1
    local port=$2
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << START
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera TeamSpeak $NAME..."
echo "Port: $PORT"
while true; do
    echo "[TS3] Serwer \$NAME dziaÅ‚a na porcie \$PORT - \$(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
}

create_custom_server() {
    local id=$1
    local dir="$SERVERS_DIR/$id"
    
    cat > "$dir/start.sh" << 'START'
#!/bin/bash
cd "$(dirname "$0")"
source server.conf
echo "Uruchamianie serwera $NAME..."
echo "Port: $PORT | Typ: $TYPE"
while true; do
    echo "[$TYPE] Serwer $NAME dziaÅ‚a na porcie $PORT - $(date)"
    sleep 30
done
START
    
    chmod +x "$dir/start.sh"
}

start_server() {
    local id=$1
    local dir="$SERVERS_DIR/$id"
    
    if [ ! -d "$dir" ]; then
        echo "ERROR: Serwer '$id' nie istnieje!"
        return 1
    fi
    
    source "$dir/server.conf"
    
    if [ "$STATUS" = "running" ]; then
        echo "WARNING: Serwer '$NAME' jest juÅ¼ uruchomiony!"
        return 1
    fi
    
    echo "Uruchamianie serwera '$NAME'..."
    
    # Uruchom w screen session
    cd "$dir"
    screen -dmS "server_$id" bash start.sh
    local pid=$!
    
    # Zapisz PID i status
    sed -i "s/STATUS=.*/STATUS=\"running\"/" "$dir/server.conf"
    sed -i "s/PID=.*/PID=\"$pid\"/" "$dir/server.conf"
    
    log "Uruchomiono serwer: $NAME (PID: $pid)"
    echo "SUCCESS: Serwer '$NAME' uruchomiony!"
    return 0
}

stop_server() {
    local id=$1
    local dir="$SERVERS_DIR/$id"
    
    if [ ! -d "$dir" ]; then
        echo "ERROR: Serwer '$id' nie istnieje!"
        return 1
    fi
    
    source "$dir/server.conf"
    
    if [ "$STATUS" != "running" ]; then
        echo "WARNING: Serwer '$NAME' nie jest uruchomiony!"
        return 1
    fi
    
    echo "Zatrzymywanie serwera '$NAME'..."
    
    # Zabij proces
    if [ -n "$PID" ]; then
        kill "$PID" 2>/dev/null
    fi
    
    # Zabij screen session
    screen -S "server_$id" -X quit 2>/dev/null
    
    # Zaktualizuj status
    sed -i "s/STATUS=.*/STATUS=\"stopped\"/" "$dir/server.conf"
    sed -i "s/PID=.*/PID=\"\"/" "$dir/server.conf"
    
    log "Zatrzymano serwer: $NAME"
    echo "SUCCESS: Serwer '$NAME' zatrzymany!"
    return 0
}

restart_server() {
    local id=$1
    stop_server "$id"
    sleep 2
    start_server "$id"
}

delete_server() {
    local id=$1
    local dir="$SERVERS_DIR/$id"
    
    if [ ! -d "$dir" ]; then
        echo "ERROR: Serwer '$id' nie istnieje!"
        return 1
    fi
    
    source "$dir/server.conf"
    
    # Zatrzymaj serwer jeÅ›li dziaÅ‚a
    if [ "$STATUS" = "running" ]; then
        stop_server "$id"
        sleep 2
    fi
    
    # UsuÅ„ katalog
    rm -rf "$dir"
    log "UsuniÄ™to serwer: $NAME"
    echo "SUCCESS: Serwer '$NAME' zostaÅ‚ usuniÄ™ty!"
    return 0
}

list_servers() {
    echo ""
    echo -e "${BLUE}ğŸ® LISTA SERWERÃ“W${NC}"
    echo -e "${CYAN}================================${NC}"
    
    if [ ! "$(ls -A $SERVERS_DIR)" ]; then
        echo -e "${YELLOW}ğŸ“­ Brak serwerÃ³w${NC}"
        return
    fi
    
    for server_dir in "$SERVERS_DIR"/*; do
        if [ -f "$server_dir/server.conf" ]; then
            source "$server_dir/server.conf"
            
            local status_color=$GREEN
            local status_icon="ğŸŸ¢"
            if [ "$STATUS" != "running" ]; then
                status_color=$RED
                status_icon="ğŸ”´"
            fi
            
            echo -e " $status_icon $NAME"
            echo -e "   ğŸ“ ID: $ID | ğŸšª Port: $PORT"
            echo -e "   ğŸ§  RAM: ${MEMORY}MB | ğŸ‘¤ WÅ‚aÅ›ciciel: $OWNER"
            echo -e "   ğŸ“Š Status: ${status_color}$STATUS${NC}"
            echo -e "${CYAN}--------------------------------${NC}"
        fi
    done
}

# =============================================
# ğŸŒ PANEL WEB Z TWORZENIEM SERWERÃ“W
# =============================================

start_web_panel() {
    echo -e "${YELLOW}ğŸŒ URUCHAMIANIE PANELU WEB...${NC}"
    
    stop_web_panel
    
    # UtwÃ³rz interfejs web
    create_web_interface
    
    # Uruchom serwer web z obsÅ‚ugÄ… CGI
    cd "$WEB_DIR"
    python3 -m http.server $PORT > "$LOGS_DIR/web.log" 2>&1 &
    echo $! > "$WEB_PID_FILE"
    
    local ip=$(hostname -I | awk '{print $1}')
    
    log "Panel web uruchomiony na porcie $PORT"
    echo -e "${GREEN}âœ… Panel web uruchomiony!${NC}"
    echo -e "${CYAN}ğŸŒ Adresy dostÄ™pu:${NC}"
    echo -e "   Local:    http://localhost:$PORT"
    echo -e "   SieÄ‡:     http://$ip:$PORT"
    echo -e "   Status:   http://localhost:$PORT/status"
}

stop_web_panel() {
    if [ -f "$WEB_PID_FILE" ]; then
        local pid=$(cat "$WEB_PID_FILE")
        kill "$pid" 2>/dev/null
        rm -f "$WEB_PID_FILE"
    fi
    pkill -f "python3 -m http.server" 2>/dev/null
}

create_web_interface() {
    # Strona gÅ‚Ã³wna
    cat > "$WEB_DIR/index.html" << 'HTML'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦– Panel SerwerÃ³w</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .header h1 { 
            font-size: 2.5em; 
            color: #2d3748;
            margin-bottom: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background: #4299e1;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .server-list {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        .server-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4299e1;
        }
        .server-card.running { border-left-color: #48bb78; }
        .server-card.stopped { border-left-color: #e53e3e; }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .server-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
        }
        .server-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-running { background: #c6f6d5; color: #276749; }
        .status-stopped { background: #fed7d7; color: #c53030; }
        .server-info {
            color: #718096;
            margin: 10px 0;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-weight: bold;
        }
        .btn-start { background: #48bb78; color: white; }
        .btn-stop { background: #e53e3e; color: white; }
        .btn-restart { background: #ed8936; color: white; }
        .btn-delete { background: #a0aec0; color: white; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn-primary {
            background: #4299e1;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦– Panel SerwerÃ³w</h1>
            <p>ZarzÄ…dzanie serwerami gry w czasie rzeczywistym</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('servers')">ğŸ® Serwery</div>
            <div class="tab" onclick="showTab('create')">â• Nowy Serwer</div>
            <div class="tab" onclick="showTab('stats')">ğŸ“Š Statystyki</div>
        </div>

        <div id="servers-tab" class="tab-content active">
            <div class="server-list" id="serverList">
                <p>Åadowanie serwerÃ³w...</p>
            </div>
            <div style="text-align: center;">
                <button class="btn-primary" onclick="refreshServers()">ğŸ”„ OdÅ›wieÅ¼</button>
            </div>
        </div>

        <div id="create-tab" class="tab-content">
            <h3>â• Tworzenie Nowego Serwera</h3>
            <form id="createServerForm">
                <div class="form-group">
                    <label for="serverName">Nazwa serwera:</label>
                    <input type="text" id="serverName" required placeholder="np. MÃ³j Serwer Minecraft">
                </div>
                <div class="form-group">
                    <label for="serverType">Typ serwera:</label>
                    <select id="serverType" required>
                        <option value="minecraft">ğŸ® Minecraft</option>
                        <option value="rust">ğŸ¦€ Rust</option>
                        <option value="ark">ğŸ¦– ARK: Survival Evolved</option>
                        <option value="csgo">ğŸ”« CS:GO</option>
                        <option value="teamspeak">ğŸ¤ TeamSpeak</option>
                        <option value="custom">âš™ï¸ Inny</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="serverPort">Port serwera:</label>
                    <input type="number" id="serverPort" placeholder="25565" min="1000" max="65535">
                </div>
                <div class="form-group">
                    <label for="serverMemory">PamiÄ™Ä‡ RAM (MB):</label>
                    <input type="number" id="serverMemory" placeholder="1024" min="512" max="16384">
                </div>
                <div class="form-group">
                    <label for="serverOwner">WÅ‚aÅ›ciciel:</label>
                    <input type="text" id="serverOwner" placeholder="admin" value="admin">
                </div>
                <button type="submit" class="btn-primary">ğŸš€ UtwÃ³rz Serwer</button>
            </form>
        </div>

        <div id="stats-tab" class="tab-content">
            <h3>ğŸ“Š Statystyki Systemu</h3>
            <div id="systemStats">
                <p>Åadowanie statystyk...</p>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Ukryj wszystkie zakÅ‚adki
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // PokaÅ¼ wybranÄ… zakÅ‚adkÄ™
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        async function refreshServers() {
            try {
                const response = await fetch('/api/servers');
                const servers = await response.json();
                
                const container = document.getElementById('serverList');
                container.innerHTML = '';
                
                if (servers.length === 0) {
                    container.innerHTML = '<p>ğŸ“­ Brak serwerÃ³w. UtwÃ³rz pierwszy serwer!</p>';
                    return;
                }
                
                servers.forEach(server => {
                    const statusClass = server.status === 'running' ? 'running' : 'stopped';
                    const statusText = server.status === 'running' ? 'DZIAÅA' : 'ZATRZYMANY';
                    
                    container.innerHTML += `
                        <div class="server-card ${statusClass}">
                            <div class="server-header">
                                <div class="server-name">${server.name}</div>
                                <div class="server-status status-${server.status}">${statusText}</div>
                            </div>
                            <div class="server-info">
                                <strong>ID:</strong> ${server.id} | 
                                <strong>Port:</strong> ${server.port} | 
                                <strong>RAM:</strong> ${server.memory}MB
                            </div>
                            <div class="server-info">
                                <strong>Typ:</strong> ${server.type} | 
                                <strong>WÅ‚aÅ›ciciel:</strong> ${server.owner}
                            </div>
                            <div>
                                ${server.status !== 'running' ? 
                                    `<button class="btn btn-start" onclick="controlServer('${server.id}', 'start')">â–¶ Start</button>` : 
                                    `<button class="btn btn-stop" onclick="controlServer('${server.id}', 'stop')">â¹ Stop</button>`
                                }
                                <button class="btn btn-restart" onclick="controlServer('${server.id}', 'restart')">ğŸ”„ Restart</button>
                                <button class="btn btn-delete" onclick="deleteServer('${server.id}')">ğŸ—‘ UsuÅ„</button>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                document.getElementById('serverList').innerHTML = '<p>âŒ BÅ‚Ä…d Å‚adowania serwerÃ³w</p>';
            }
        }

        async function controlServer(serverId, action) {
            try {
                const response = await fetch(`/api/server/${serverId}/${action}`, { method: 'POST' });
                const result = await response.json();
                alert(result.message);
                refreshServers();
            } catch (error) {
                alert('âŒ BÅ‚Ä…d: ' + error);
            }
        }

        async function deleteServer(serverId) {
            if (confirm('Czy na pewno chcesz usunÄ…Ä‡ ten serwer?')) {
                try {
                    const response = await fetch(`/api/server/${serverId}/delete`, { method: 'POST' });
                    const result = await response.json();
                    alert(result.message);
                    refreshServers();
                } catch (error) {
                    alert('âŒ BÅ‚Ä…d: ' + error);
                }
            }
        }

        // Formularz tworzenia serwera
        document.getElementById('createServerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                name: document.getElementById('serverName').value,
                type: document.getElementById('serverType').value,
                port: document.getElementById('serverPort').value || '25565',
                memory: document.getElementById('serverMemory').value || '1024',
                owner: document.getElementById('serverOwner').value || 'admin'
            };

            try {
                const response = await fetch('/api/server/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                alert(result.message);
                
                if (result.success) {
                    this.reset();
                    showTab('servers');
                    refreshServers();
                }
            } catch (error) {
                alert('âŒ BÅ‚Ä…d podczas tworzenia serwera: ' + error);
            }
        });

        // OdÅ›wieÅ¼ przy starcie i co 30 sekund
        refreshServers();
        setInterval(refreshServers, 30000);
    </script>
</body>
</html>
HTML

    # Strona statusu
    cat > "$WEB_DIR/status.html" << 'STATUS'
<!DOCTYPE html>
<html>
<head>
    <title>Status Panelu</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .status { padding: 10px; margin: 5px; border-radius: 5px; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>ğŸ¦– Status Panelu</h1>
    <div class="status online">âœ… Panel dziaÅ‚a poprawnie</div>
    <div class="status online">ğŸŒ Serwer web aktywny</div>
    <div><a href="/">â† PowrÃ³t do panelu</a></div>
</body>
</html>
STATUS

    # API do tworzenia serwerÃ³w
    cat > "$WEB_DIR/api.py" << 'PYTHON'
#!/usr/bin/env python3
import json
import os
import cgi
import sys
import subprocess

SERVERS_DIR = "/home/panel/servers"

def get_servers():
    servers = []
    for server_id in os.listdir(SERVERS_DIR):
        server_dir = os.path.join(SERVERS_DIR, server_id)
        conf_file = os.path.join(server_dir, "server.conf")
        
        if os.path.isfile(conf_file):
            with open(conf_file, 'r') as f:
                config = {}
                for line in f:
                    if '=' in line:
                        key, value = line.strip().split('=', 1)
                        config[key] = value.strip('"')
                
                servers.append({
                    'id': config.get('ID', ''),
                    'name': config.get('NAME', ''),
                    'type': config.get('TYPE', ''),
                    'port': config.get('PORT', ''),
                    'memory': config.get('MEMORY', ''),
                    'owner': config.get('OWNER', ''),
                    'status': config.get('STATUS', 'stopped')
                })
    
    return servers

def handle_create_server(data):
    try:
        name = data.get('name', '')
        server_type = data.get('type', 'minecraft')
        port = data.get('port', '25565')
        memory = data.get('memory', '1024')
        owner = data.get('owner', 'admin')
        
        # WywoÅ‚aj funkcjÄ™ bash do tworzenia serwera
        cmd = f'bash -c "source /home/panel/panel.sh; create_server \\"{name}\\" \\"{server_type}\\" \\"{port}\\" \\"{memory}\\" \\"{owner}\\""'
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        
        if "SUCCESS" in result.stdout:
            return {'success': True, 'message': result.stdout.split('SUCCESS: ')[1].strip()}
        else:
            return {'success': False, 'message': result.stderr or result.stdout}
            
    except Exception as e:
        return {'success': False, 'message': str(e)}

def handle_server_action(server_id, action):
    try:
        if action == 'start':
            cmd = f'bash -c "source /home/panel/panel.sh; start_server \\"{server_id}\\""'
        elif action == 'stop':
            cmd = f'bash -c "source /home/panel/panel.sh; stop_server \\"{server_id}\\""'
        elif action == 'restart':
            cmd = f'bash -c "source /home/panel/panel.sh; restart_server \\"{server_id}\\""'
        elif action == 'delete':
            cmd = f'bash -c "source /home/panel/panel.sh; delete_server \\"{server_id}\\""'
        else:
            return {'success': False, 'message': 'Nieznana akcja'}
        
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        
        if "SUCCESS" in result.stdout or "WARNING" in result.stdout:
            message = result.stdout.split(': ')[1].strip() if ': ' in result.stdout else result.stdout.strip()
            return {'success': True, 'message': message}
        else:
            return {'success': False, 'message': result.stderr or result.stdout}
            
    except Exception as e:
        return {'success': False, 'message': str(e)}

def main():
    print("Content-Type: application/json\n")
    
    try:
        if os.environ.get('REQUEST_METHOD') == 'GET':
            if os.environ.get('PATH_INFO') == '/api/servers':
                servers = get_servers()
                print(json.dumps(servers))
                
        elif os.environ.get('REQUEST_METHOD') == 'POST':
            content_length = int(os.environ.get('CONTENT_LENGTH', 0))
            post_data = sys.stdin.read(content_length)
            
            if os.environ.get('PATH_INFO', '').startswith('/api/server/'):
                path_parts = os.environ['PATH_INFO'].split('/')
                if len(path_parts) >= 5:
                    server_id = path_parts[3]
                    action = path_parts[4]
                    
                    if action == 'create':
                        data = json.loads(post_data)
                        result = handle_create_server(data)
                        print(json.dumps(result))
                    else:
                        result = handle_server_action(server_id, action)
                        print(json.dumps(result))
                        
    except Exception as e:
        print(json.dumps({'success': False, 'message': str(e)}))

if __name__ == "__main__":
    main()
PYTHON

    chmod +x "$WEB_DIR/api.py"
    
    # Skrypt do obsÅ‚ugi API przez CGI
    cat > "$WEB_DIR/api" << 'CGI'
#!/bin/bash
echo "Content-Type: application/json"
echo ""

# PrzekaÅ¼ Å¼Ä…danie do skryptu Python
/home/panel/web/api.py
CGI

    chmod +x "$WEB_DIR/api"
    
    echo -e "${GREEN}âœ… Interfejs web z tworzeniem serwerÃ³w utworzony${NC}"
}

# =============================================
# ğŸ“Š FUNKCJE SYSTEMOWE
# =============================================

show_system_stats() {
    echo ""
    echo -e "${BLUE}ğŸ“Š STATYSTYKI SYSTEMU${NC}"
    echo -e "${CYAN}================================${NC}"
    
    # CPU
    local cpu=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}')
    echo -e " ğŸ’» UÅ¼ycie CPU: ${cpu}%"
    
    # PamiÄ™Ä‡
    local mem_total=$(free -m | awk 'NR==2{print $2}')
    local mem_used=$(free -m | awk 'NR==2{print $3}')
    local mem_percent=$((mem_used * 100 / mem_total))
    echo -e " ğŸ§  PamiÄ™Ä‡ RAM: ${mem_used}MB/${mem_total}MB (${mem_percent}%)"
    
    # Serwery
    local total_servers=0
    local running_servers=0
    
    for server_dir in "$SERVERS_DIR"/*; do
        if [ -f "$server_dir/server.conf" ]; then
            ((total_servers++))
            source "$server_dir/server.conf"
            if [ "$STATUS" = "running" ]; then
                ((running_servers++))
            fi
        fi
    done
    
    echo -e " ğŸ® Serwery: $running_servers/$total_servers uruchomionych"
    echo -e " ğŸ“ Katalog panelu: $PANEL_DIR"
    echo -e "${CYAN}================================${NC}"
}

# =============================================
# ğŸ¯ MENU GÅÃ“WNE
# =============================================

show_menu() {
    echo -e "${GREEN}"
    echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘           ğŸ¦– PANEL SERWERÃ“W          â•‘"
    echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo -e "â•‘                                      â•‘"
    echo -e "â•‘  ${YELLOW}1${GREEN}ï¸âƒ£  - Lista serwerÃ³w               â•‘"
    echo -e "â•‘  ${YELLOW}2${GREEN}ï¸âƒ£  - UtwÃ³rz serwer                â•‘"
    echo -e "â•‘  ${YELLOW}3${GREEN}ï¸âƒ£  - Uruchom serwer              â•‘"
    echo -e "â•‘  ${YELLOW}4${GREEN}ï¸âƒ£  - Zatrzymaj serwer            â•‘"
    echo -e "â•‘  ${YELLOW}5${GREEN}ï¸âƒ£  - Restartuj serwer            â•‘"
    echo -e "â•‘  ${YELLOW}6${GREEN}ï¸âƒ£  - UsuÅ„ serwer                 â•‘"
    echo -e "â•‘  ${YELLOW}7${GREEN}ï¸âƒ£  - Panel web                   â•‘"
    echo -e "â•‘  ${YELLOW}8${GREEN}ï¸âƒ£  - Statystyki                  â•‘"
    echo -e "â•‘  ${YELLOW}0${GREEN}ï¸âƒ£  - WyjÅ›cie                     â•‘"
    echo -e "â•‘                                      â•‘"
    echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo -e "â•‘        Wybierz opcjÄ™ (0-8):          â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# =============================================
# ğŸ“œ MAIN SCRIPT
# =============================================

# Inicjalizacja
mkdir -p "$PANEL_DIR"
setup_directories
check_dependencies

# Zapisz PID panelu
echo $$ > "$PANEL_PID_FILE"

# Funkcja sprzÄ…tania
cleanup() {
    echo -e "\n${YELLOW}ğŸ›‘ Zatrzymywanie panelu...${NC}"
    stop_web_panel
    rm -f "$PANEL_PID_FILE"
    echo -e "${GREEN}âœ… Panel zatrzymany${NC}"
    exit 0
}

trap cleanup INT TERM

clear

echo -e "${BLUE}"
echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘           ğŸ¦– PANEL SERWERÃ“W          â•‘"
echo -e "â•‘         Production Edition           â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo -e "${CYAN}Katalog panelu: $PANEL_DIR${NC}"
echo -e "${CYAN}Logi: $LOGS_DIR/panel.log${NC}"
echo ""

# SprawdÅº czy funkcja create_server jest wywoÅ‚ana z parametrami
if [ $# -ge 5 ]; then
    create_server "$1" "$2" "$3" "$4" "$5"
    exit $?
fi

while true; do
    show_menu
    read -p "TwÃ³j wybÃ³r: " choice
    
    case $choice in
        1)
            list_servers
            ;;
        2)
            echo ""
            echo -e "${BLUE}ğŸ® TWORZENIE SERWERA${NC}"
            read -p "Nazwa serwera: " name
            read -p "Typ (minecraft/rust/ark/csgo/teamspeak): " type
            read -p "Port: " port
            read -p "RAM (MB): " memory
            read -p "WÅ‚aÅ›ciciel: " owner
            create_server "$name" "$type" "$port" "$memory" "$owner"
            ;;
        3)
            read -p "ID serwera do uruchomienia: " id
            start_server "$id"
            ;;
        4)
            read -p "ID serwera do zatrzymania: " id
            stop_server "$id"
            ;;
        5)
            read -p "ID serwera do restartu: " id
            restart_server "$id"
            ;;
        6)
            read -p "ID serwera do usuniÄ™cia: " id
            delete_server "$id"
            ;;
        7)
            start_web_panel
            ;;
        8)
            show_system_stats
            ;;
        0)
            cleanup
            ;;
        *)
            echo -e "${RED}âŒ NieprawidÅ‚owy wybÃ³r!${NC}"
            ;;
    esac
    
    echo ""
    read -p "NaciÅ›nij Enter aby kontynuowaÄ‡..."
    clear
done
