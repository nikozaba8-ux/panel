#!/bin/bash

# =============================================
# ğŸ¦– PTERODACTYL-LIKE PANEL - ALL IN ONE
# =============================================

# Konfiguracja
PANEL_DIR="/home/panel"
SERVERS_DIR="$PANEL_DIR/servers"
LOGS_DIR="$PANEL_DIR/logs"
BACKUPS_DIR="$PANEL_DIR/backups"
CONFIG_DIR="$PANEL_DIR/config"
WEB_DIR="$PANEL_DIR/web"
USERS_DIR="$PANEL_DIR/users"
DATABASES_DIR="$PANEL_DIR/databases"
RESOURCES_DIR="$PANEL_DIR/resources"
PANEL_BACKUP_DIR="$PANEL_DIR/panel-backups"
PID_FILE="$PANEL_DIR/panel.pid"
PORT=8080

# Limity systemowe
MAX_SERVERS_PER_USER=10
MAX_MEMORY_PER_USER=16384
MIN_PORT=25500
MAX_PORT=30000
DEFAULT_PORTS=(
    ["minecraft"]=25565
    ["fivem"]=30120
    ["python"]=8000
)

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================
# ğŸ› ï¸ FUNKCJE POMOCNICZE
# =============================================

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

error() {
    echo -e "${RED}[BÅÄ„D]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

warning() {
    echo -e "${YELLOW}[OSTRZEÅ»ENIE]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

check_dependencies() {
    echo -e "${YELLOW}Sprawdzanie zaleÅ¼noÅ›ci...${NC}"
    local missing=()
    for cmd in nc jq wget unzip python3 java; do
        if ! command -v $cmd &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        warning "BrakujÄ…ce zaleÅ¼noÅ›ci: ${missing[*]}"
        echo "Instalowanie..."
        apt update > /dev/null 2>&1
        apt install -y netcat-openbsd jq wget unzip python3 python3-pip default-jre > /dev/null 2>&1
        pip3 install flask django fastapi uvicorn > /dev/null 2>&1
        echo -e "${GREEN}âœ… ZaleÅ¼noÅ›ci zainstalowane${NC}"
    else
        echo -e "${GREEN}âœ… Wszystkie zaleÅ¼noÅ›ci sÄ… dostÄ™pne${NC}"
    fi
}

setup_directories() {
    mkdir -p "$SERVERS_DIR" "$LOGS_DIR" "$BACKUPS_DIR" "$CONFIG_DIR" "$WEB_DIR" \
             "$USERS_DIR" "$DATABASES_DIR" "$RESOURCES_DIR" "$PANEL_BACKUP_DIR"
}

# =============================================
# ğŸ”§ ZARZÄ„DZANIE PANELEM
# =============================================

create_panel_backup() {
    local backup_name="panel-backup-$(date '+%Y%m%d-%H%M%S')"
    local backup_path="$PANEL_BACKUP_DIR/$backup_name.tar.gz"
    
    log "Tworzenie backupu panelu..."
    if tar -czf "$backup_path" -C /home panel 2>/dev/null; then
        log "Backup panelu utworzony: $backup_path"
        echo "$backup_path"
    else
        error "BÅ‚Ä…d podczas tworzenia backupu panelu"
        return 1
    fi
}

# =============================================
# ğŸŒ SERWER WEB - NATYCHMIASTOWE URUCHOMIENIE
# =============================================

check_port_available() {
    local port=$1
    # SprawdÅº czy port jest wolny
    if ! nc -z localhost $port 2>/dev/null; then
        return 0  # Port wolny
    else
        return 1  # Port zajÄ™ty
    fi
}

find_available_port() {
    local start_port=8080
    local max_port=8100
    local port=$start_port
    
    while [ $port -le $max_port ]; do
        if check_port_available $port; then
            echo $port
            return 0
        fi
        port=$((port + 1))
    done
    
    # JeÅ›li nie znaleziono portu, uÅ¼yj losowego powyÅ¼ej 8100
    echo $((8100 + RANDOM % 1000))
    return 0
}

start_web_server() {
    # SprawdÅº czy port 8080 jest dostÄ™pny, jeÅ›li nie znajdÅº inny
    if ! check_port_available $PORT; then
        warning "Port $PORT jest zajÄ™ty, szukam wolnego portu..."
        NEW_PORT=$(find_available_port)
        if [ $? -eq 0 ]; then
            PORT=$NEW_PORT
            log "UÅ¼ywam portu: $PORT"
        else
            error "Nie moÅ¼na znaleÅºÄ‡ wolnego portu!"
            return 1
        fi
    fi

    # Zatrzymaj istniejÄ…cy serwer jeÅ›li dziaÅ‚a
    stop_web_server

    log "Uruchamianie serwera web na porcie $PORT..."
    
    # Uruchom serwer w tle - UPROSZCZONA WERSJA DLA SZYBSZEGO STARTOWANIA
    {
        while true; do
            nc -l -p $PORT -c "
                read -r request
                uri=\$(echo \"\$request\" | awk '{print \$2}')
                method=\$(echo \"\$request\" | awk '{print \$1}')
                
                # Prosty routing
                case \"\$uri\" in
                    \"/\"|\"/admin\"|\"/admin/\"*)
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                        cat \"$WEB_DIR/index.html\" 2>/dev/null || echo \"<h1>Panel Pterodactyl</h1><p>Panel jest uruchomiony na porcie $PORT</p>\"
                        ;;
                    \"/client\"*)
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                        cat \"$WEB_DIR/client/index.html\" 2>/dev/null || echo \"<h1>Client Panel</h1><p>Panel klienta</p>\"
                        ;;
                    \"/api/\"*)
                        # Proste API
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: application/json\r\nConnection: close\r\n\r\"
                        echo '{\"status\":\"online\",\"port\":\"'$PORT'\",\"message\":\"Panel dziaÅ‚a poprawnie\"}'
                        ;;
                    *)
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                        cat \"$WEB_DIR/index.html\" 2>/dev/null || echo \"<h1>Panel Pterodactyl</h1><p>Port: $PORT</p>\"
                        ;;
                esac
            "
        done
    } > /dev/null 2>&1 &
    
    echo $! > "$PID_FILE"
    log "âœ… Serwer web uruchomiony: http://localhost:$PORT"
    
    # Natychmiastowe zwrÃ³cenie kontroli - NIE CZEKAJ
    return 0
}

stop_web_server() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            kill "$pid" 2>/dev/null
            wait "$pid" 2>/dev/null
            log "Serwer web zatrzymany"
        fi
        rm -f "$PID_FILE"
    fi
}

# =============================================
# ğŸŒ INTERFEJS WEB - UPROSZCZONY
# =============================================

create_web_interface() {
    # Strona gÅ‚Ã³wna Admin - UPROSZCZONA
    cat > "$WEB_DIR/index.html" << 'EOF'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Serwerowy - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333; 
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px;
        }
        .header h1 { 
            font-size: 3em; 
            margin-bottom: 10px; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .status {
            background: #c6f6d5;
            color: #276749;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
        }
        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); 
            transition: transform 0.3s ease; 
            border-left: 4px solid #4299e1;
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin-bottom: 15px; color: #2d3748; }
        .card p { color: #718096; margin-bottom: 20px; }
        .btn { 
            display: inline-block; 
            padding: 12px 30px; 
            background: #4299e1; 
            color: white; 
            text-decoration: none; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
        .btn-success { background: #48bb78; }
        .btn-warning { background: #ed8936; }
        .btn-danger { background: #e53e3e; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .info-panel {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦– Panel Pterodactyl</h1>
            <p>Port: <strong id="current-port">8080</strong> â€¢ 
               <span class="status">âœ… ONLINE</span>
            </p>
        </div>

        <div class="info-panel">
            <h3>ğŸš€ Panel zostaÅ‚ uruchomiony pomyÅ›lnie!</h3>
            <p>MoÅ¼esz teraz zarzÄ…dzaÄ‡ serwerami i uÅ¼ytkownikami.</p>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>ğŸ‘¥ UÅ¼ytkownicy</h3>
                <p>ZarzÄ…dzaj uÅ¼ytkownikami systemu</p>
                <a href="/admin/users" class="btn">PrzejdÅº</a>
            </div>
            <div class="card">
                <h3>ğŸ® Serwery</h3>
                <p>TwÃ³rz i zarzÄ…dzaj serwerami</p>
                <a href="/admin/servers" class="btn">PrzejdÅº</a>
            </div>
            <div class="card">
                <h3>ğŸ“Š Statystyki</h3>
                <p>Monitoruj wydajnoÅ›Ä‡ systemu</p>
                <a href="/admin/stats" class="btn">PrzejdÅº</a>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>ğŸ”§ ZarzÄ…dzanie</h3>
                <p>Backup, reinstalacja, ustawienia</p>
                <a href="/admin/management" class="btn btn-warning">ZarzÄ…dzaj</a>
            </div>
            <div class="card">
                <h3>ğŸ‘¤ Panel Klienta</h3>
                <p>PrzejdÅº do panelu klienta</p>
                <a href="/client/?user=testuser" class="btn btn-success">Client Area</a>
            </div>
        </div>
    </div>

    <script>
        // Pobierz aktualny port
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.port) {
                    document.getElementById('current-port').textContent = data.port;
                }
            });
    </script>
</body>
</html>
EOF

    # Panel klienta - UPROSZCZONY
    mkdir -p "$WEB_DIR/client"
    cat > "$WEB_DIR/client/index.html" << 'EOF'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Klienta</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333; 
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px;
        }
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
            color: #2d3748;
        }
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); 
            border-left: 4px solid #48bb78;
        }
        .btn { 
            display: inline-block; 
            padding: 12px 30px; 
            background: #4299e1; 
            color: white; 
            text-decoration: none; 
            border-radius: 8px; 
            font-weight: 600; 
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        .btn-success { background: #48bb78; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘‹ Witaj w Panelu Klienta</h1>
            <p>ZarzÄ…dzaj swoimi serwerami</p>
        </div>

        <div class="card">
            <h2>ğŸ® Twoje Serwery</h2>
            <p>Tutaj moÅ¼esz tworzyÄ‡ i zarzÄ…dzaÄ‡ swoimi serwerami.</p>
            <button class="btn btn-success" onclick="createServer()">â• UtwÃ³rz Serwer</button>
        </div>

        <div class="card">
            <h2>ğŸ“Š PodglÄ…d SerwerÃ³w</h2>
            <div id="servers-list">
                <p>Åadowanie listy serwerÃ³w...</p>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="/" class="btn">ğŸ  PowrÃ³t do Panelu Admina</a>
        </div>
    </div>

    <script>
        function createServer() {
            alert('Funkcja tworzenia serwera bÄ™dzie dostÄ™pna wkrÃ³tce!');
        }

        // Symulacja Å‚adowania serwerÃ³w
        setTimeout(() => {
            document.getElementById('servers-list').innerHTML = `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h3>ğŸ¦– PrzykÅ‚adowy Serwer</h3>
                    <p>Status: <span style="color: #48bb78;">â— DZIAÅA</span></p>
                    <p>Typ: Minecraft â€¢ Port: 25565 â€¢ RAM: 2048MB</p>
                </div>
            `;
        }, 1000);
    </script>
</body>
</html>
EOF

    echo -e "${GREEN}âœ… Interfejs web utworzony${NC}"
}

# =============================================
# ğŸš€ SZYBKA INICJALIZACJA
# =============================================

quick_initialize() {
    echo -e "${BLUE}ğŸ¦– Szybka inicjalizacja Panelu Pterodactyl...${NC}"
    
    # SprawdÅº uprawnienia
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}Uruchom jako root: sudo $0${NC}"
        exit 1
    fi
    
    # Szybkie sprawdzenie zaleÅ¼noÅ›ci
    echo -e "${YELLOW}ğŸ” Szybkie sprawdzenie zaleÅ¼noÅ›ci...${NC}"
    for cmd in nc python3; do
        if ! command -v $cmd &> /dev/null; then
            echo -e "${YELLOW}ğŸ“¦ Instalowanie: $cmd${NC}"
            apt update > /dev/null 2>&1
            apt install -y netcat-openbsd python3 > /dev/null 2>&1
        fi
    done
    
    # UtwÃ³rz katalogi
    echo -e "${YELLOW}ğŸ“ Tworzenie struktur katalogÃ³w...${NC}"
    setup_directories
    
    # UtwÃ³rz podstawowego uÅ¼ytkownika
    if [ ! -f "$USERS_DIR/testuser.conf" ]; then
        cat > "$USERS_DIR/testuser.conf" << EOF
USERNAME="testuser"
USER_EMAIL="test@example.com"
USER_PASSWORD="test123"
USER_CREATED="$(date '+%Y-%m-%d %H:%M:%S')"
EOF
        echo -e "${GREEN}âœ… Utworzono uÅ¼ytkownika testowego${NC}"
    fi
    
    # UtwÃ³rz interfejs web
    echo -e "${YELLOW}ğŸŒ Tworzenie interfejsu web...${NC}"
    create_web_interface
    
    # URUCHOM SERwer NATYCHMIAST
    echo -e "${YELLOW}ğŸš€ Uruchamianie serwera web...${NC}"
    start_web_server
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}=============================================${NC}"
        echo -e "${GREEN}ğŸ‰ PANEL PTERODACTYL JEST GOTOWY!${NC}"
        echo -e "${GREEN}=============================================${NC}"
        echo -e "${CYAN}ğŸŒ Panel Admin:${NC}    http://localhost:$PORT"
        echo -e "${CYAN}ğŸ‘¤ Client Area:${NC}    http://localhost:$PORT/client/?user=testuser"
        echo -e "${CYAN}ğŸ” Dane testowe:${NC}   uÅ¼ytkownik: testuser, hasÅ‚o: test123"
        echo -e "${GREEN}=============================================${NC}"
        echo -e "${YELLOW}ğŸ’¡ Panel jest juÅ¼ dostÄ™pny w przeglÄ…darce!${NC}"
    else
        echo -e "${RED}âŒ BÅ‚Ä…d podczas uruchamiania panelu${NC}"
        exit 1
    fi
}

# =============================================
# ğŸ“œ MAIN SCRIPT - NATYCHMIASTOWE URUCHOMIENIE
# =============================================

# SprawdÅº czy to pierwsze uruchomienie
if [ ! -d "$PANEL_DIR" ] || [ "$1" = "start" ]; then
    # NATYCHMIASTOWE URUCHOMIENIE PANELU
    quick_initialize
    
    # Uruchom peÅ‚nÄ… pÄ™tlÄ™ serwera w tle
    {
        # Poczekaj chwilÄ™ aÅ¼ podstawowy serwer siÄ™ uruchomi
        sleep 3
        
        # Teraz uruchom peÅ‚nÄ… wersjÄ™ serwera z API
        stop_web_server
        
        # PeÅ‚na wersja serwera z API
        {
            while true; do
                nc -l -p $PORT -c "
                    read -r request
                    export REQUEST_URI=\$(echo \"\$request\" | awk '{print \$2}')
                    export REQUEST_METHOD=\$(echo \"\$request\" | awk '{print \$1}')
                    
                    # Proste API
                    if [[ \"\$REQUEST_URI\" == \"/api/status\" ]]; then
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: application/json\r\nConnection: close\r\n\r\"
                        echo '{\"status\":\"online\",\"port\":\"'$PORT'\",\"message\":\"Panel dziaÅ‚a poprawnie\"}'
                    elif [[ \"\$REQUEST_URI\" == \"/api/\"* ]]; then
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: application/json\r\nConnection: close\r\n\r\"
                        echo '{\"success\":true,\"message\":\"API dziaÅ‚a\"}'
                    elif [[ \"\$REQUEST_URI\" == \"/client\"* ]]; then
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                        cat \"$WEB_DIR/client/index.html\"
                    else
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                        cat \"$WEB_DIR/index.html\"
                    fi
                "
            done
        } > /dev/null 2>&1 &
        
        echo $! > "$PID_FILE"
        log "âœ… PeÅ‚na wersja serwera uruchomiona"
        
    } &
    
    # Pozostaw panel dziaÅ‚ajÄ…cy
    echo -e "${YELLOW}â³ Panel kontynuuje pracÄ™ w tle...${NC}"
    echo -e "${YELLOW}ğŸ›‘ Aby zatrzymaÄ‡: Ctrl+C${NC}"
    
    # Czekaj na Ctrl+C
    while true; do
        sleep 10
    done

else
    # JeÅ›li panel juÅ¼ istnieje, po prostu go uruchom
    echo -e "${GREEN}ğŸ”„ Uruchamianie istniejÄ…cego panelu...${NC}"
    start_web_server
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Panel uruchomiony: http://localhost:$PORT${NC}"
        echo -e "${YELLOW}ğŸ›‘ NaciÅ›nij Ctrl+C aby zatrzymaÄ‡${NC}"
        
        # Czekaj na Ctrl+C
        while true; do
            sleep 10
        done
    else
        echo -e "${RED}âŒ BÅ‚Ä…d podczas uruchamiania panelu${NC}"
        exit 1
    fi
fi

# PrzechwyÄ‡ Ctrl+C
trap 'stop_web_server; echo -e "\n${YELLOW}ğŸ›‘ Panel zatrzymany${NC}"; exit 0' INT TERM
