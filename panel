#!/bin/bash

# =============================================
# ğŸ¦– PTERODACTYL-LIKE PANEL - ALL IN ONE
# =============================================

# Konfiguracja
PANEL_DIR="/home/panel"
SERVERS_DIR="$PANEL_DIR/servers"
LOGS_DIR="$PANEL_DIR/logs"
BACKUPS_DIR="$PANEL_DIR/backups"
CONFIG_DIR="$PANEL_DIR/config"
WEB_DIR="$PANEL_DIR/web"
USERS_DIR="$PANEL_DIR/users"
DATABASES_DIR="$PANEL_DIR/databases"
RESOURCES_DIR="$PANEL_DIR/resources"
PANEL_BACKUP_DIR="$PANEL_DIR/panel-backups"
PID_FILE="$PANEL_DIR/panel.pid"
PORT=8080

# Limity systemowe
MAX_SERVERS_PER_USER=10
MAX_MEMORY_PER_USER=16384
MIN_PORT=25500
MAX_PORT=30000
DEFAULT_PORTS=(
    ["minecraft"]=25565
    ["fivem"]=30120
    ["python"]=8000
)

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================
# ğŸŒ FUNKCJE DO WYKRYWANIA IP
# =============================================

get_local_ip() {
    # PrÃ³buj rÃ³Å¼ne metody uzyskania lokalnego IP
    local ip=""
    
    # Metoda 1: ip route
    if command -v ip > /dev/null; then
        ip=$(ip route get 1 2>/dev/null | awk '{print $7}' | head -1)
    fi
    
    # Metoda 2: hostname -I
    if [ -z "$ip" ] || [ "$ip" = "127.0.0.1" ]; then
        ip=$(hostname -I 2>/dev/null | awk '{print $1}')
    fi
    
    # Metoda 3: ifconfig
    if [ -z "$ip" ] || [ "$ip" = "127.0.0.1" ]; then
        if command -v ifconfig > /dev/null; then
            ip=$(ifconfig 2>/dev/null | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1)
        fi
    fi
    
    # Metoda 4: netstat
    if [ -z "$ip" ] || [ "$ip" = "127.0.0.1" ]; then
        if command -v netstat > /dev/null; then
            ip=$(netstat -rn 2>/dev/null | grep -E '^0.0.0.0' | awk '{print $2}' | head -1)
        fi
    fi
    
    # JeÅ›li nadal nie znaleziono, uÅ¼yj localhost
    if [ -z "$ip" ] || [ "$ip" = "127.0.0.1" ]; then
        ip="localhost"
    fi
    
    echo "$ip"
}

get_public_ip() {
    # PrÃ³buj uzyskaÄ‡ publiczne IP
    local public_ip=""
    
    # Metoda 1: curl do zewnÄ™trznych serwisÃ³w
    if command -v curl > /dev/null; then
        public_ip=$(curl -s --connect-timeout 3 http://ipinfo.io/ip 2>/dev/null || \
                   curl -s --connect-timeout 3 http://ifconfig.me 2>/dev/null || \
                   curl -s --connect-timeout 3 http://api.ipify.org 2>/dev/null)
    fi
    
    # Metoda 2: wget
    if [ -z "$public_ip" ] && command -v wget > /dev/null; then
        public_ip=$(wget -q -O - --timeout=3 http://ipinfo.io/ip 2>/dev/null)
    fi
    
    echo "$public_ip"
}

get_server_ips() {
    local local_ip=$(get_local_ip)
    local public_ip=$(get_public_ip)
    
    # SprawdÅº czy publiczne IP jest inne niÅ¼ lokalne
    if [ -n "$public_ip" ] && [ "$public_ip" != "$local_ip" ] && [ "$public_ip" != "localhost" ]; then
        echo "$local_ip|$public_ip"
    else
        echo "$local_ip|"
    fi
}

# =============================================
# ğŸ› ï¸ FUNKCJE POMOCNICZE
# =============================================

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

error() {
    echo -e "${RED}[BÅÄ„D]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

warning() {
    echo -e "${YELLOW}[OSTRZEÅ»ENIE]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

check_dependencies() {
    echo -e "${YELLOW}Sprawdzanie zaleÅ¼noÅ›ci...${NC}"
    local missing=()
    for cmd in nc jq wget unzip python3 java curl; do
        if ! command -v $cmd &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        warning "BrakujÄ…ce zaleÅ¼noÅ›ci: ${missing[*]}"
        echo "Instalowanie..."
        apt update > /dev/null 2>&1
        apt install -y netcat-openbsd jq wget unzip python3 python3-pip default-jre curl > /dev/null 2>&1
        pip3 install flask django fastapi uvicorn > /dev/null 2>&1
        echo -e "${GREEN}âœ… ZaleÅ¼noÅ›ci zainstalowane${NC}"
    else
        echo -e "${GREEN}âœ… Wszystkie zaleÅ¼noÅ›ci sÄ… dostÄ™pne${NC}"
    fi
}

setup_directories() {
    mkdir -p "$SERVERS_DIR" "$LOGS_DIR" "$BACKUPS_DIR" "$CONFIG_DIR" "$WEB_DIR" \
             "$USERS_DIR" "$DATABASES_DIR" "$RESOURCES_DIR" "$PANEL_BACKUP_DIR"
}

# =============================================
# ğŸŒ SERWER WEB Z AUTO-IP
# =============================================

check_port_available() {
    local port=$1
    if ! nc -z localhost $port 2>/dev/null; then
        return 0
    else
        return 1
    fi
}

find_available_port() {
    local start_port=8080
    local max_port=8100
    local port=$start_port
    
    while [ $port -le $max_port ]; do
        if check_port_available $port; then
            echo $port
            return 0
        fi
        port=$((port + 1))
    done
    
    echo $((8100 + RANDOM % 1000))
    return 0
}

start_web_server() {
    # SprawdÅº i znajdÅº port
    if ! check_port_available $PORT; then
        warning "Port $PORT jest zajÄ™ty, szukam wolnego portu..."
        NEW_PORT=$(find_available_port)
        if [ $? -eq 0 ]; then
            PORT=$NEW_PORT
            log "UÅ¼ywam portu: $PORT"
        else
            error "Nie moÅ¼na znaleÅºÄ‡ wolnego portu!"
            return 1
        fi
    fi

    # Zatrzymaj istniejÄ…cy serwer jeÅ›li dziaÅ‚a
    stop_web_server

    # Pobierz adresy IP serwera
    local ips=$(get_server_ips)
    local local_ip=$(echo "$ips" | cut -d'|' -f1)
    local public_ip=$(echo "$ips" | cut -d'|' -f2)
    
    log "Wykryte IP: Lokalne: $local_ip, Publiczne: ${public_ip:-brak}"

    log "Uruchamianie serwera web na porcie $PORT..."
    
    # Uruchom serwer w tle
    {
        while true; do
            nc -l -p $PORT -c "
                read -r request
                uri=\$(echo \"\$request\" | awk '{print \$2}')
                method=\$(echo \"\$request\" | awk '{print \$1}')
                
                # Aktualizuj IP przy kaÅ¼dym Å¼Ä…daniu
                current_ips=\$(get_server_ips)
                current_local_ip=\$(echo \"\$current_ips\" | cut -d'|' -f1)
                current_public_ip=\$(echo \"\$current_ips\" | cut -d'|' -f2)
                
                case \"\$uri\" in
                    \"/\"|\"/admin\"|\"/admin/\"*)
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                        # ZastÄ…p placeholdery aktualnymi IP
                        sed \"s/%%LOCAL_IP%%/\$current_local_ip/g; s/%%PUBLIC_IP%%/\$current_public_ip/g; s/%%PORT%%/$PORT/g\" \"$WEB_DIR/index.html\"
                        ;;
                    \"/client\"*)
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                        sed \"s/%%LOCAL_IP%%/\$current_local_ip/g; s/%%PUBLIC_IP%%/\$current_public_ip/g; s/%%PORT%%/$PORT/g\" \"$WEB_DIR/client/index.html\"
                        ;;
                    \"/api/\"*)
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: application/json\r\nConnection: close\r\n\r\"
                        echo '{\"status\":\"online\",\"port\":\"'$PORT'\",\"local_ip\":\"'\"\$current_local_ip\"'\",\"public_ip\":\"'\"\$current_public_ip\"'\"}'
                        ;;
                    *)
                        echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                        sed \"s/%%LOCAL_IP%%/\$current_local_ip/g; s/%%PUBLIC_IP%%/\$current_public_ip/g; s/%%PORT%%/$PORT/g\" \"$WEB_DIR/index.html\"
                        ;;
                esac
            " 2>/dev/null
        done
    } > /dev/null 2>&1 &
    
    echo $! > "$PID_FILE"
    log "âœ… Serwer web uruchomiony"
    
    # WyÅ›wietl informacje o dostÄ™pie
    echo -e "${GREEN}ğŸŒ Adresy dostÄ™pu:${NC}"
    echo -e "${CYAN}  Local:${NC}    http://$local_ip:$PORT"
    if [ -n "$public_ip" ]; then
        echo -e "${CYAN}  Public:${NC}   http://$public_ip:$PORT"
    fi
    echo -e "${CYAN}  Localhost:${NC} http://localhost:$PORT"
    
    return 0
}

stop_web_server() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            kill "$pid" 2>/dev/null
            wait "$pid" 2>/dev/null
            log "Serwer web zatrzymany"
        fi
        rm -f "$PID_FILE"
    fi
}

# =============================================
# ğŸŒ INTERFEJS WEB Z AUTO-IP
# =============================================

create_web_interface() {
    # Strona gÅ‚Ã³wna Admin z dynamicznym IP
    cat > "$WEB_DIR/index.html" << 'EOF'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Serwerowy - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333; 
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px;
        }
        .header h1 { 
            font-size: 3em; 
            margin-bottom: 10px; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .status {
            background: #c6f6d5;
            color: #276749;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
            margin: 5px;
        }
        .ip-info {
            background: #e0f2fe;
            border: 2px solid #bae6fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .ip-address {
            font-family: 'Courier New', monospace;
            background: #1a202c;
            color: #cbd5e0;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 5px 0;
            display: inline-block;
        }
        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); 
            transition: transform 0.3s ease; 
            border-left: 4px solid #4299e1;
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin-bottom: 15px; color: #2d3748; }
        .card p { color: #718096; margin-bottom: 20px; }
        .btn { 
            display: inline-block; 
            padding: 12px 30px; 
            background: #4299e1; 
            color: white; 
            text-decoration: none; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            border: none;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        .btn-success { background: #48bb78; }
        .btn-warning { background: #ed8936; }
        .btn-danger { background: #e53e3e; }
        .btn-info { background: #38b2ac; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .info-panel {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .copy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦– Panel Pterodactyl</h1>
            <p>Port: <strong>%%PORT%%</strong> â€¢ 
               <span class="status">âœ… ONLINE</span>
            </p>
        </div>

        <div class="ip-info">
            <h3>ğŸŒ Adresy Serwera</h3>
            <div style="margin: 15px 0;">
                <strong>Lokalne IP:</strong><br>
                <span class="ip-address" id="local-ip">http://%%LOCAL_IP%%:%%PORT%%</span>
                <button class="copy-btn" onclick="copyToClipboard('local-ip')">ğŸ“‹</button>
            </div>
            <div style="margin: 15px 0;">
                <strong>Publiczne IP:</strong><br>
                <span class="ip-address" id="public-ip">http://%%PUBLIC_IP%%:%%PORT%%</span>
                <button class="copy-btn" onclick="copyToClipboard('public-ip')">ğŸ“‹</button>
            </div>
            <div style="margin: 15px 0;">
                <strong>Localhost:</strong><br>
                <span class="ip-address" id="localhost-ip">http://localhost:%%PORT%%</span>
                <button class="copy-btn" onclick="copyToClipboard('localhost-ip')">ğŸ“‹</button>
            </div>
        </div>

        <div class="info-panel">
            <h3>ğŸš€ Panel zostaÅ‚ uruchomiony pomyÅ›lnie!</h3>
            <p>UÅ¼yj powyÅ¼szych adresÃ³w aby uzyskaÄ‡ dostÄ™p do panelu z innych urzÄ…dzeÅ„ w sieci.</p>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>ğŸ‘¥ UÅ¼ytkownicy</h3>
                <p>ZarzÄ…dzaj uÅ¼ytkownikami systemu</p>
                <a href="/admin/users" class="btn">PrzejdÅº</a>
            </div>
            <div class="card">
                <h3>ğŸ® Serwery</h3>
                <p>TwÃ³rz i zarzÄ…dzaj serwerami</p>
                <a href="/admin/servers" class="btn">PrzejdÅº</a>
            </div>
            <div class="card">
                <h3>ğŸ“Š Statystyki</h3>
                <p>Monitoruj wydajnoÅ›Ä‡ systemu</p>
                <a href="/admin/stats" class="btn">PrzejdÅº</a>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>ğŸ”§ ZarzÄ…dzanie</h3>
                <p>Backup, reinstalacja, ustawienia</p>
                <a href="/admin/management" class="btn btn-warning">ZarzÄ…dzaj</a>
            </div>
            <div class="card">
                <h3>ğŸ‘¤ Panel Klienta</h3>
                <p>PrzejdÅº do panelu klienta</p>
                <a href="/client/?user=testuser" class="btn btn-success">Client Area</a>
            </div>
            <div class="card">
                <h3>ğŸ”„ OdÅ›wieÅ¼ IP</h3>
                <p>Ponownie wykryj adresy IP</p>
                <button class="btn btn-info" onclick="refreshIPs()">ğŸ”„ OdÅ›wieÅ¼</button>
            </div>
        </div>
    </div>

    <script>
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… Skopiowano: ' + text);
            });
        }

        function refreshIPs() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.local_ip && data.port) {
                        document.getElementById('local-ip').textContent = 
                            'http://' + data.local_ip + ':' + data.port;
                    }
                    if (data.public_ip && data.port) {
                        document.getElementById('public-ip').textContent = 
                            'http://' + data.public_ip + ':' + data.port;
                    }
                    if (data.port) {
                        document.getElementById('localhost-ip').textContent = 
                            'http://localhost:' + data.port;
                    }
                    alert('âœ… Adresy IP zaktualizowane!');
                })
                .catch(error => {
                    alert('âŒ BÅ‚Ä…d podczas odÅ›wieÅ¼ania IP');
                });
        }

        // Auto-odÅ›wieÅ¼anie co 30 sekund
        setInterval(refreshIPs, 30000);
    </script>
</body>
</html>
EOF

    # Panel klienta z dynamicznym IP
    mkdir -p "$WEB_DIR/client"
    cat > "$WEB_DIR/client/index.html" << 'EOF'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Klienta</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333; 
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px;
        }
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
            color: #2d3748;
        }
        .ip-info {
            background: #e0f2fe;
            border: 2px solid #bae6fd;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .ip-address {
            font-family: 'Courier New', monospace;
            background: #1a202c;
            color: #cbd5e0;
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px;
            display: inline-block;
        }
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); 
            border-left: 4px solid #48bb78;
        }
        .btn { 
            display: inline-block; 
            padding: 12px 30px; 
            background: #4299e1; 
            color: white; 
            text-decoration: none; 
            border-radius: 8px; 
            font-weight: 600; 
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        .btn-success { background: #48bb78; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘‹ Witaj w Panelu Klienta</h1>
            <p>ZarzÄ…dzaj swoimi serwerami</p>
        </div>

        <div class="ip-info">
            <h3>ğŸŒ Adres Panelu</h3>
            <div>
                <span class="ip-address">http://%%LOCAL_IP%%:%%PORT%%/client/</span>
            </div>
            <div>
                <span class="ip-address">http://%%PUBLIC_IP%%:%%PORT%%/client/</span>
            </div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                UÅ¼yj tych adresÃ³w aby uzyskaÄ‡ dostÄ™p z innych urzÄ…dzeÅ„
            </p>
        </div>

        <div class="card">
            <h2>ğŸ® Twoje Serwery</h2>
            <p>Tutaj moÅ¼esz tworzyÄ‡ i zarzÄ…dzaÄ‡ swoimi serwerami.</p>
            <button class="btn btn-success" onclick="createServer()">â• UtwÃ³rz Serwer</button>
        </div>

        <div class="card">
            <h2>ğŸ“Š PodglÄ…d SerwerÃ³w</h2>
            <div id="servers-list">
                <p>Åadowanie listy serwerÃ³w...</p>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="/" class="btn">ğŸ  PowrÃ³t do Panelu Admina</a>
        </div>
    </div>

    <script>
        function createServer() {
            alert('Funkcja tworzenia serwera bÄ™dzie dostÄ™pna wkrÃ³tce!');
        }

        // Symulacja Å‚adowania serwerÃ³w
        setTimeout(() => {
            document.getElementById('servers-list').innerHTML = `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h3>ğŸ¦– PrzykÅ‚adowy Serwer</h3>
                    <p>Status: <span style="color: #48bb78;">â— DZIAÅA</span></p>
                    <p>Typ: Minecraft â€¢ Port: 25565 â€¢ RAM: 2048MB</p>
                    <p>Adres: <code>%%LOCAL_IP%%:25565</code></p>
                </div>
            `;
        }, 1000);
    </script>
</body>
</html>
EOF

    echo -e "${GREEN}âœ… Interfejs web utworzony z dynamicznym IP${NC}"
}

# =============================================
# ğŸš€ SZYBKA INICJALIZACJA Z AUTO-IP
# =============================================

quick_initialize() {
    echo -e "${BLUE}ğŸ¦– Szybka inicjalizacja Panelu Pterodactyl...${NC}"
    
    # SprawdÅº uprawnienia
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}Uruchom jako root: sudo $0${NC}"
        exit 1
    fi
    
    # Szybkie sprawdzenie zaleÅ¼noÅ›ci
    echo -e "${YELLOW}ğŸ” Sprawdzanie zaleÅ¼noÅ›ci...${NC}"
    for cmd in nc python3 curl; do
        if ! command -v $cmd &> /dev/null; then
            echo -e "${YELLOW}ğŸ“¦ Instalowanie: $cmd${NC}"
            apt update > /dev/null 2>&1
            apt install -y netcat-openbsd python3 curl > /dev/null 2>&1
        fi
    done
    
    # UtwÃ³rz katalogi
    echo -e "${YELLOW}ğŸ“ Tworzenie struktur katalogÃ³w...${NC}"
    setup_directories
    
    # UtwÃ³rz podstawowego uÅ¼ytkownika
    if [ ! -f "$USERS_DIR/testuser.conf" ]; then
        cat > "$USERS_DIR/testuser.conf" << EOF
USERNAME="testuser"
USER_EMAIL="test@example.com"
USER_PASSWORD="test123"
USER_CREATED="$(date '+%Y-%m-%d %H:%M:%S')"
EOF
        echo -e "${GREEN}âœ… Utworzono uÅ¼ytkownika testowego${NC}"
    fi
    
    # Wykryj IP przed uruchomieniem
    echo -e "${YELLOW}ğŸŒ Wykrywanie adresÃ³w IP serwera...${NC}"
    local ips=$(get_server_ips)
    local local_ip=$(echo "$ips" | cut -d'|' -f1)
    local public_ip=$(echo "$ips" | cut -d'|' -f2)
    
    echo -e "${CYAN}ğŸ“¡ Lokalne IP:${NC} $local_ip"
    if [ -n "$public_ip" ]; then
        echo -e "${CYAN}ğŸŒ Publiczne IP:${NC} $public_ip"
    else
        echo -e "${YELLOW}ğŸŒ Publiczne IP:${NC} nie wykryto (tylko sieÄ‡ lokalna)"
    fi
    
    # UtwÃ³rz interfejs web
    echo -e "${YELLOW}ğŸŒ Tworzenie interfejsu web...${NC}"
    create_web_interface
    
    # URUCHOM SERWER NATYCHMIAST
    echo -e "${YELLOW}ğŸš€ Uruchamianie serwera web...${NC}"
    start_web_server
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}=============================================${NC}"
        echo -e "${GREEN}ğŸ‰ PANEL PTERODACTYL JEST GOTOWY!${NC}"
        echo -e "${GREEN}=============================================${NC}"
        echo -e "${CYAN}ğŸ” Dane testowe:${NC}   uÅ¼ytkownik: testuser, hasÅ‚o: test123"
        echo -e "${GREEN}=============================================${NC}"
        echo -e "${YELLOW}ğŸ’¡ Panel jest juÅ¼ dostÄ™pny w przeglÄ…darce!${NC}"
        echo -e "${YELLOW}ğŸ“± UÅ¼yj adresÃ³w IP aby uzyskaÄ‡ dostÄ™p z innych urzÄ…dzeÅ„${NC}"
    else
        echo -e "${RED}âŒ BÅ‚Ä…d podczas uruchamiania panelu${NC}"
        exit 1
    fi
}

# =============================================
# ğŸ›‘ FUNKCJA SPRZÄ„TAJÄ„CA
# =============================================

cleanup() {
    echo -e "\n${YELLOW}ğŸ›‘ Zatrzymywanie panelu...${NC}"
    stop_web_server
    echo -e "${GREEN}âœ… Panel zostaÅ‚ zatrzymany${NC}"
    exit 0
}

# =============================================
# ğŸ¯ FUNKCJE ZARZÄ„DZANIA PANELEM
# =============================================

show_status() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… Panel jest uruchomiony (PID: $pid)${NC}"
            
            # Pobierz aktualne IP
            local ips=$(get_server_ips)
            local local_ip=$(echo "$ips" | cut -d'|' -f1)
            local public_ip=$(echo "$ips" | cut -d'|' -f2)
            
            echo -e "${CYAN}ğŸŒ Adresy dostÄ™pu:${NC}"
            echo -e "  Local:    http://$local_ip:$PORT"
            if [ -n "$public_ip" ]; then
                echo -e "  Public:   http://$public_ip:$PORT"
            fi
            echo -e "  Localhost: http://localhost:$PORT"
        else
            echo -e "${RED}âŒ Panel nie jest uruchomiony${NC}"
        fi
    else
        echo -e "${RED}âŒ Panel nie jest uruchomiony${NC}"
    fi
}

restart_panel() {
    echo -e "${YELLOW}ğŸ”„ Restartowanie panelu...${NC}"
    stop_web_server
    sleep 2
    start_web_server
}

backup_panel() {
    local backup_name="panel-backup-$(date '+%Y-%m-%d-%H-%M-%S')"
    local backup_path="$PANEL_BACKUP_DIR/$backup_name.tar.gz"
    
    echo -e "${YELLOW}ğŸ“¦ Tworzenie backupu panelu...${NC}"
    
    tar -czf "$backup_path" -C "$PANEL_DIR" . 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Backup utworzony: $backup_path${NC}"
    else
        echo -e "${RED}âŒ BÅ‚Ä…d podczas tworzenia backupu${NC}"
    fi
}

show_help() {
    echo -e "${GREEN}ğŸ¦– Panel Pterodactyl - Pomoc${NC}"
    echo ""
    echo -e "${CYAN}DostÄ™pne komendy:${NC}"
    echo -e "  ${YELLOW}start${NC}     - Uruchom panel"
    echo -e "  ${YELLOW}stop${NC}      - Zatrzymaj panel"
    echo -e "  ${YELLOW}restart${NC}   - Restartuj panel"
    echo -e "  ${YELLOW}status${NC}    - PokaÅ¼ status panelu"
    echo -e "  ${YELLOW}backup${NC}    - UtwÃ³rz backup panelu"
    echo -e "  ${YELLOW}help${NC}      - PokaÅ¼ tÄ™ pomoc"
    echo ""
    echo -e "${CYAN}PrzykÅ‚ady:${NC}"
    echo -e "  ${GREEN}sudo $0 start${NC}"
    echo -e "  ${GREEN}sudo $0 status${NC}"
    echo -e "  ${GREEN}sudo $0 backup${NC}"
}

# =============================================
# ğŸ“œ MAIN SCRIPT - AUTO-IP
# =============================================

# Zarejestruj trap dla sygnaÅ‚Ã³w
trap cleanup INT TERM

# SprawdÅº argumenty
case "${1:-}" in
    "start")
        # NATYCHMIASTOWE URUCHOMIENIE PANELU Z AUTO-IP
        quick_initialize
        
        # Uruchom peÅ‚nÄ… pÄ™tlÄ™ serwera w tle
        {
            sleep 3
            stop_web_server
            
            # PeÅ‚na wersja serwera z API i auto-IP
            {
                while true; do
                    nc -l -p $PORT -c "
                        read -r request
                        export REQUEST_URI=\$(echo \"\$request\" | awk '{print \$2}')
                        export REQUEST_METHOD=\$(echo \"\$request\" | awk '{print \$1}')
                        
                        # Aktualizuj IP przy kaÅ¼dym Å¼Ä…daniu
                        current_ips=\$(get_server_ips)
                        current_local_ip=\$(echo \"\$current_ips\" | cut -d'|' -f1)
                        current_public_ip=\$(echo \"\$current_ips\" | cut -d'|' -f2)
                        
                        if [[ \"\$REQUEST_URI\" == \"/api/status\" ]]; then
                            echo -e \"HTTP/1.1 200 OK\r\nContent-Type: application/json\r\nConnection: close\r\n\r\"
                            echo '{\"status\":\"online\",\"port\":\"'$PORT'\",\"local_ip\":\"'\"\$current_local_ip\"'\",\"public_ip\":\"'\"\$current_public_ip\"'\"}'
                        elif [[ \"\$REQUEST_URI\" == \"/api/\"* ]]; then
                            echo -e \"HTTP/1.1 200 OK\r\nContent-Type: application/json\r\nConnection: close\r\n\r\"
                            echo '{\"success\":true,\"message\":\"API dziaÅ‚a\",\"local_ip\":\"'\"\$current_local_ip\"'\",\"public_ip\":\"'\"\$current_public_ip\"'\"}'
                        elif [[ \"\$REQUEST_URI\" == \"/client\"* ]]; then
                            echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                            sed \"s/%%LOCAL_IP%%/\$current_local_ip/g; s/%%PUBLIC_IP%%/\$current_public_ip/g; s/%%PORT%%/$PORT/g\" \"$WEB_DIR/client/index.html\"
                        else
                            echo -e \"HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\"
                            sed \"s/%%LOCAL_IP%%/\$current_local_ip/g; s/%%PUBLIC_IP%%/\$current_public_ip/g; s/%%PORT%%/$PORT/g\" \"$WEB_DIR/index.html\"
                        fi
                    " 2>/dev/null
                done
            } > /dev/null 2>&1 &
            
            echo $! > "$PID_FILE"
            log "âœ… PeÅ‚na wersja serwera z Auto-IP uruchomiona"
            
        } &
        
        # Pozostaw panel dziaÅ‚ajÄ…cy
        echo -e "${YELLOW}â³ Panel kontynuuje pracÄ™ w tle...${NC}"
        echo -e "${YELLOW}ğŸ›‘ Aby zatrzymaÄ‡: Ctrl+C${NC}"
        
        # Czekaj na sygnaÅ‚ zakoÅ„czenia
        while true; do
            sleep 10
        done
        ;;
    "stop")
        stop_web_server
        ;;
    "restart")
        restart_panel
        ;;
    "status")
        show_status
        ;;
    "backup")
        backup_panel
        ;;
    "help"|"--help"|"-h")
        show_help
        ;;
    *)
        # DomyÅ›lnie uruchom panel jeÅ›li nie podano argumentÃ³w
        if [ ! -d "$PANEL_DIR" ]; then
            echo -e "${GREEN}ğŸ”„ Uruchamianie nowej instalacji panelu...${NC}"
            quick_initialize
        else
            echo -e "${GREEN}ğŸ”„ Uruchamianie istniejÄ…cego panelu z Auto-IP...${NC}"
            start_web_server
        fi
        
        if [ $? -eq 0 ]; then
            echo -e "${YELLOW}ğŸ›‘ NaciÅ›nij Ctrl+C aby zatrzymaÄ‡${NC}"
            
            while true; do
                sleep 10
            done
        else
            echo -e "${RED}âŒ BÅ‚Ä…d podczas uruchamiania panelu${NC}"
            exit 1
        fi
        ;;
esac
