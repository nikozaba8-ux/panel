#!/bin/bash

# =============================================
# ğŸŸ£ PURPLEHOST - SZYBKA NAPRAWA
# =============================================

PANEL_DIR="/home/purplehost"
WEB_DIR="$PANEL_DIR/web"
LOG_DIR="$PANEL_DIR/logs"
PORT=8080

# Kolory
PURPLE='\033[0;35m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${PURPLE}"
echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘           ğŸš€ PURPLEHOST              â•‘"
echo -e "â•‘           SZYBKA NAPRAWA             â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# =============================================
# ğŸ› ï¸ DIAGNOSTYKA
# =============================================

echo -e "${CYAN}ğŸ” Diagnozowanie problemu...${NC}"

# SprawdÅº czy jesteÅ› root
if [ "$EUID" -ne 0 ]; then
    echo -e "${YELLOW}âš ï¸  Uruchom jako root dla najlepszych efektÃ³w: sudo ./naprawa.sh${NC}"
fi

# Zatrzymaj wszystkie istniejÄ…ce serwery
echo -e "${YELLOW}ğŸ”„ Zatrzymywanie istniejÄ…cych procesÃ³w...${NC}"
pkill -f "python3" >/dev/null 2>&1
pkill -f "server.py" >/dev/null 2>&1
sleep 2

# Zwolnij port 8080
echo -e "${YELLOW}ğŸ”„ Zwalnianie portu $PORT...${NC}"
fuser -k $PORT/tcp >/dev/null 2>&1

# SprawdÅº zaleÅ¼noÅ›ci
echo -e "${CYAN}ğŸ“¦ Sprawdzanie zaleÅ¼noÅ›ci...${NC}"

if ! command -v python3 &> /dev/null; then
    echo -e "${YELLOW}ğŸ“¦ Instalowanie Pythona 3...${NC}"
    apt update >/dev/null 2>&1
    apt install -y python3 >/dev/null 2>&1
fi

# SprawdÅº czy Python dziaÅ‚a
if ! python3 --version >/dev/null 2>&1; then
    echo -e "${RED}âŒ Python3 nie dziaÅ‚a poprawnie${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… Python3 jest gotowy${NC}"

# =============================================
# ğŸ“ PRZYGOTOWANIE STRUKTURY
# =============================================

echo -e "${CYAN}ğŸ“ Tworzenie struktury katalogÃ³w...${NC}"

mkdir -p "$PANEL_DIR" "$WEB_DIR" "$LOG_DIR"
mkdir -p "$PANEL_DIR/serwery" "$PANEL_DIR/bazy" "$PANEL_DIR/backupy"

# Czyszczenie starych logÃ³w
echo "" > "$LOG_DIR/web_server.log"

# =============================================
# ğŸŒ UTWORZENIE PROSTEGO SERWERA
# =============================================

echo -e "${CYAN}ğŸ”§ Tworzenie serwera...${NC}"

cat > "$WEB_DIR/server.py" << 'PYTHON'
#!/usr/bin/env python3
import http.server
import socketserver
import os
import json
from datetime import datetime

PORT = 8080
WEB_DIR = "/home/purplehost/web"

class PurpleHostHandler(http.server.SimpleHTTPRequestHandler):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, directory=WEB_DIR, **kwargs)
    
    def do_GET(self):
        if self.path == '/':
            self.path = '/index.html'
        elif self.path == '/api/servers':
            self.send_api_response([])
            return
        elif self.path.startswith('/api/'):
            self.send_api_response({"error": "API niedostÄ™pne w trybie naprawy"})
            return
            
        super().do_GET()
    
    def do_POST(self):
        if self.path.startswith('/api/'):
            self.send_api_response({"status": "success", "message": "System w trybie naprawy"})
            return
        else:
            self.send_error(404)
    
    def send_api_response(self, data):
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
        self.wfile.write(json.dumps(data).encode('utf-8'))
    
    def log_message(self, format, *args):
        # WyÅ‚Ä…cz domyÅ›lne logowanie
        pass

def main():
    print("ğŸš€ PURPLEHOST - SZYBKA NAPRAWA")
    print("=" * 50)
    print(f"ğŸ“ Katalog: {WEB_DIR}")
    print(f"ğŸŒ Port: {PORT}")
    print("â³ Uruchamianie...")
    
    # SprawdÅº czy katalog istnieje
    if not os.path.exists(WEB_DIR):
        print(f"âŒ BÅ‚Ä…d: Katalog {WEB_DIR} nie istnieje!")
        return
    
    os.chdir(WEB_DIR)
    
    try:
        with socketserver.TCPServer(("", PORT), PurpleHostHandler) as httpd:
            print(f"âœ… SERWER URUCHOMIONY!")
            print(f"ğŸ“ Adres: http://localhost:{PORT}")
            print(f"ğŸ“ Adres: http://{os.popen('hostname -I').read().strip()}:{PORT}")
            print("=" * 50)
            print("ğŸ’¡ Panel bÄ™dzie dziaÅ‚aÅ‚ w trybie podstawowym")
            print("ğŸ›‘ Aby zatrzymaÄ‡: Ctrl+C")
            httpd.serve_forever()
    except OSError as e:
        if "Address already in use" in str(e):
            print(f"âŒ Port {PORT} jest zajÄ™ty!")
            print("ğŸ’¡ Uruchom: sudo fuser -k 8080/tcp")
        else:
            print(f"âŒ BÅ‚Ä…d: {e}")
    except Exception as e:
        print(f"âŒ Nieoczekiwany bÅ‚Ä…d: {e}")

if __name__ == "__main__":
    main()
PYTHON

chmod +x "$WEB_DIR/server.py"

# =============================================
# ğŸ“„ UTWORZENIE STRONY GÅÃ“WNEJ
# =============================================

echo -e "${CYAN}ğŸ“„ Tworzenie strony gÅ‚Ã³wnej...${NC}"

cat > "$WEB_DIR/index.html" << 'HTML'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ PurpleHost - System Naprawiony</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --primary-light: #A78BFA;
            --secondary: #06D6A0;
            --accent: #FF6B6B;
            --dark: #1E1B2E;
            --darker: #151321;
            --light: #F8FAFC;
            --gray: #64748B;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .status-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            margin: 2rem 0;
            backdrop-filter: blur(20px);
        }

        .status-success {
            border-left: 4px solid var(--secondary);
        }

        .status-warning {
            border-left: 4px solid var(--accent);
        }

        .status-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: var(--glass);
            color: var(--light);
            border: 1px solid var(--glass-border);
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 3rem 0;
        }

        .feature-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .next-steps {
            background: rgba(6, 214, 160, 0.1);
            border: 1px solid rgba(6, 214, 160, 0.2);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .step-number {
            background: var(--secondary);
            color: var(--dark);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-rocket"></i>
                PurpleHost
            </div>
            <h1>System zostaÅ‚ naprawiony! ğŸ‰</h1>
            <p style="color: var(--gray); font-size: 1.2rem; margin-top: 1rem;">
                Podstawowy panel zostaÅ‚ uruchomiony pomyÅ›lnie
            </p>
        </div>

        <!-- Status Card -->
        <div class="status-card status-success">
            <div class="status-icon">
                <i class="fas fa-check-circle" style="color: var(--secondary);"></i>
            </div>
            <h2 style="margin-bottom: 1rem;">Status: DZIAÅA POPRAWNIE âœ…</h2>
            <p style="color: var(--gray); font-size: 1.1rem; margin-bottom: 2rem;">
                Serwer PurpleHost zostaÅ‚ uruchomiony na porcie 8080
            </p>
            <div>
                <button class="btn btn-primary" onclick="showDemo('dashboard')">
                    <i class="fas fa-home"></i> Demo Dashboard
                </button>
                <button class="btn btn-secondary" onclick="showDemo('servers')">
                    <i class="fas fa-server"></i> Demo Serwery
                </button>
                <button class="btn btn-secondary" onclick="showDemo('create')">
                    <i class="fas fa-plus"></i> Demo Tworzenie
                </button>
            </div>
        </div>

        <!-- Features -->
        <div class="features">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h3>Szybka Naprawa</h3>
                <p style="color: var(--gray); margin-top: 1rem;">
                    System zostaÅ‚ uruchomiony w trybie podstawowym. Wszystkie niezbÄ™dne komponenty dziaÅ‚ajÄ….
                </p>
            </div>

            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3>Stabilne DziaÅ‚anie</h3>
                <p style="color: var(--gray); margin-top: 1rem;">
                    Serwer HTTP dziaÅ‚a poprawnie. MoÅ¼esz przeglÄ…daÄ‡ panel i testowaÄ‡ podstawowe funkcje.
                </p>
            </div>

            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-rocket"></i>
                </div>
                <h3>Gotowy na RozbudowÄ™</h3>
                <p style="color: var(--gray); margin-top: 1rem;">
                    Struktura katalogÃ³w jest gotowa do peÅ‚nej instalacji PurpleHost.
                </p>
            </div>
        </div>

        <!-- Next Steps -->
        <div class="next-steps">
            <h3 style="margin-bottom: 1.5rem; color: var(--secondary);">
                <i class="fas fa-arrow-right"></i> NastÄ™pne kroki:
            </h3>
            
            <div class="step">
                <div class="step-number">1</div>
                <div>
                    <strong>SprawdÅº dziaÅ‚anie</strong>
                    <p style="color: var(--gray); margin: 0;">Panel powinien byÄ‡ dostÄ™pny pod adresem http://localhost:8080</p>
                </div>
            </div>

            <div class="step">
                <div class="step-number">2</div>
                <div>
                    <strong>PeÅ‚na instalacja</strong>
                    <p style="color: var(--gray); margin: 0;">Uruchom peÅ‚nÄ… wersjÄ™ PurpleHost z serwerami Minecraft</p>
                </div>
            </div>

            <div class="step">
                <div class="step-number">3</div>
                <div>
                    <strong>Rozpocznij uÅ¼ywanie</strong>
                    <p style="color: var(--gray); margin: 0;">TwÃ³rz serwery Minecraft i zarzÄ…dzaj nimi przez panel</p>
                </div>
            </div>
        </div>

        <!-- Demo Content -->
        <div id="demoContent" style="display: none; margin-top: 2rem; padding: 2rem; background: var(--glass); border-radius: 15px;">
            <h3 id="demoTitle">Demo Panel</h3>
            <p id="demoText" style="color: var(--gray); margin-top: 1rem;">
                Ta funkcja bÄ™dzie dostÄ™pna po peÅ‚nej instalacji.
            </p>
        </div>
    </div>

    <script>
        function showDemo(type) {
            const content = document.getElementById('demoContent');
            const title = document.getElementById('demoTitle');
            const text = document.getElementById('demoText');
            
            content.style.display = 'block';
            
            switch(type) {
                case 'dashboard':
                    title.innerHTML = 'ğŸ“Š Demo Dashboard';
                    text.innerHTML = 'PeÅ‚ny dashboard z statystykami serwerÃ³w, graczami online i zuÅ¼yciem zasobÃ³w bÄ™dzie dostÄ™pny po peÅ‚nej instalacji.';
                    break;
                case 'servers':
                    title.innerHTML = 'ğŸ® Demo Serwery Minecraft';
                    text.innerHTML = 'Po peÅ‚nej instalacji bÄ™dziesz mÃ³gÅ‚ tworzyÄ‡ prawdziwe serwery Minecraft, uruchamiaÄ‡ je i zarzÄ…dzaÄ‡ nimi przez ten panel.';
                    break;
                case 'create':
                    title.innerHTML = 'ğŸ› ï¸ Demo Tworzenie Serwera';
                    text.innerHTML = 'Formularz tworzenia serwera pozwoli wybraÄ‡ wersjÄ™ Minecraft, iloÅ›Ä‡ RAM i konfiguracjÄ™. Serwer bÄ™dzie pobieraÅ‚ officialne pliki JAR z Mojang.';
                    break;
            }
            
            // Scroll to demo content
            content.scrollIntoView({ behavior: 'smooth' });
        }

        // PokazujÄ™ Å¼e JavaScript dziaÅ‚a
        console.log('ğŸš€ PurpleHost - System naprawiony i dziaÅ‚ajÄ…cy!');
    </script>
</body>
</html>
HTML

# =============================================
# ğŸš€ URUCHOMIENIE SERWERA
# =============================================

echo -e "${CYAN}ğŸš€ Uruchamianie serwera PurpleHost...${NC}"

cd "$WEB_DIR"
nohup python3 server.py > "$LOG_DIR/web_server.log" 2>&1 &
SERVER_PID=$!

sleep 3

# =============================================
# âœ… SPRAWDZENIE STATUSU
# =============================================

if ps -p $SERVER_PID > /dev/null 2>&1; then
    echo -e "${GREEN}"
    echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                    ğŸ‰ SUKCES!                            â•‘"
    echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•‘  PurpleHost zostaÅ‚ pomyÅ›lnie uruchomiony!                 â•‘"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•‘  ğŸŒ Adresy dostÄ™pu:                                       â•‘"
    echo -e "â•‘     ğŸ“ http://localhost:8080                             â•‘"
    echo -e "â•‘     ğŸŒ http://$(hostname -I | awk '{print $1}'):8080     â•‘"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•‘  ğŸ“ Katalog panelu: $WEB_DIR                             â•‘"
    echo -e "â•‘  ğŸ“‹ Logi: $LOG_DIR/web_server.log                        â•‘"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•‘  ğŸ’¡ OtwÃ³rz przeglÄ…darkÄ™ i sprawdÅº dziaÅ‚anie!             â•‘"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    # Zapisz PID
    echo $SERVER_PID > "$PANEL_DIR/server.pid"
    
    # SprÃ³buj otworzyÄ‡ przeglÄ…darkÄ™
    if [ -n "$DISPLAY" ]; then
        echo -e "${YELLOW}ğŸ–¥ï¸  Otwieranie przeglÄ…darki...${NC}"
        xdg-open "http://localhost:8080" 2>/dev/null &
    fi
    
else
    echo -e "${RED}"
    echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                    âŒ BÅÄ„D!                              â•‘"
    echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•‘  Nie udaÅ‚o siÄ™ uruchomiÄ‡ serwera.                         â•‘"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•‘  SprawdÅº logi:                                            â•‘"
    echo -e "â•‘    cat $LOG_DIR/web_server.log                           â•‘"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•‘  MoÅ¼liwe problemy:                                        â•‘"
    echo -e "â•‘    â€¢ Port 8080 jest zajÄ™ty                               â•‘"
    echo -e "â•‘    â€¢ Brak uprawnieÅ„                                      â•‘"
    echo -e "â•‘    â€¢ Problem z Pythonem                                  â•‘"
    echo -e "â•‘                                                            â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    # PokaÅ¼ logi
    echo -e "${YELLOW}ğŸ“‹ Ostatnie logi:${NC}"
    tail -10 "$LOG_DIR/web_server.log"
fi

echo -e "${CYAN}"
echo -e "==================================================="
echo -e "ğŸ”§ DIAGNOSTYKA ZAKOÅƒCZONA"
echo -e "==================================================="
echo -e "${NC}"
