#!/bin/bash

# ASCII Art - SKYPORT
ascii_art="

   _____ _                      
  / ____| |                     
 | (___ | | ____ _ _ __  _   _ 
  \___ \| |/ / _\` | '_ \| | | |
  ____) |   < (_| | |_) | |_| |
 |_____/|_|\_\__,_| .__/ \__, |
                  | |     __/ |
                  |_|    |___/ 
"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Function for consistent messaging
echo_message() {
    echo -e "${GREEN}$1${NC}"
}

echo_error() {
    echo -e "${RED}$1${NC}"
}

echo_warning() {
    echo -e "${YELLOW}$1${NC}"
}

echo_info() {
    echo -e "${BLUE}$1${NC}"
}

# Clear the screen
clear

# Check if the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo_error "Please run this script as root."
  exit 1
fi

echo -e "${CYAN}$ascii_art${NC}"
echo_message "=== SKYPORT PANEL INSTALLER ==="

# Update system
echo_message "[1/5] Updating system packages..."
apt update && apt upgrade -y
apt install -y curl software-properties-common git wget unzip build-essential

# Install Node.js
echo_message "[2/5] Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt-get install -y nodejs

# Verify Node.js installation
echo_info "Node.js version: $(node -v)"
echo_info "NPM version: $(npm -v)"

# Install and Setup Skyport Panel
echo_message "[3/5] Installing Skyport Panel..."
cd /opt

# Clean installation
if [ -d "skyport-panel" ]; then
    echo_info "Removing old installation..."
    rm -rf skyport-panel
fi

# Create skyport directory
mkdir -p skyport-panel
cd skyport-panel

# Create package.json for Skyport
cat > package.json << 'EOF'
{
  "name": "skyport-panel",
  "version": "1.0.0",
  "description": "FiveM Server Management Panel",
  "main": "app.js",
  "scripts": {
    "start": "node app.js",
    "dev": "nodemon app.js",
    "setup": "node setup.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "express-session": "^1.17.3",
    "ejs": "^3.1.9",
    "body-parser": "^1.20.2",
    "bcrypt": "^5.1.1",
    "sqlite3": "^5.1.6",
    "node-cron": "^3.0.2",
    "axios": "^1.6.2"
  },
  "keywords": ["fivem", "panel", "management"],
  "author": "Skyport",
  "license": "MIT"
}
EOF

# Create main application file
cat > app.js << 'EOF'
const express = require('express');
const session = require('express-session');
const bodyParser = require('body-parser');
const path = require('path');
const sqlite3 = require('sqlite3').verbose();
const bcrypt = require('bcrypt');
const axios = require('axios');
const cron = require('node-cron');

const app = express();
const PORT = process.env.PORT || 3001;

// Middleware
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(session({
    secret: 'skyport-secret-key-2024',
    resave: false,
    saveUninitialized: true,
    cookie: { secure: false }
}));

// Set EJS as template engine
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
app.use(express.static(path.join(__dirname, 'public')));

// Database setup
const db = new sqlite3.Database('./skyport.db');

// Initialize database
db.serialize(() => {
    db.run(`CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE,
        password TEXT,
        role TEXT DEFAULT 'admin'
    )`);
    
    db.run(`CREATE TABLE IF NOT EXISTS servers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT,
        ip TEXT,
        port INTEGER,
        status TEXT DEFAULT 'offline',
        players INTEGER DEFAULT 0,
        max_players INTEGER DEFAULT 32
    )`);
    
    // Create default admin user
    const defaultPassword = 'admin123';
    bcrypt.hash(defaultPassword, 10, (err, hash) => {
        if (err) return;
        db.run(`INSERT OR IGNORE INTO users (username, password, role) VALUES (?, ?, ?)`, 
               ['admin', hash, 'admin']);
    });
});

// Routes
app.get('/', (req, res) => {
    if (!req.session.user) {
        return res.redirect('/login');
    }
    
    db.all('SELECT * FROM servers', (err, servers) => {
        if (err) {
            console.error(err);
            servers = [];
        }
        
        res.render('dashboard', {
            user: req.session.user,
            servers: servers,
            page: 'dashboard'
        });
    });
});

app.get('/login', (req, res) => {
    if (req.session.user) {
        return res.redirect('/');
    }
    res.render('login', { error: null });
});

app.post('/login', (req, res) => {
    const { username, password } = req.body;
    
    db.get('SELECT * FROM users WHERE username = ?', [username], (err, user) => {
        if (err || !user) {
            return res.render('login', { error: 'Invalid credentials' });
        }
        
        bcrypt.compare(password, user.password, (err, result) => {
            if (result) {
                req.session.user = user;
                res.redirect('/');
            } else {
                res.render('login', { error: 'Invalid credentials' });
            }
        });
    });
});

app.get('/logout', (req, res) => {
    req.session.destroy();
    res.redirect('/login');
});

app.get('/servers', (req, res) => {
    if (!req.session.user) return res.redirect('/login');
    
    db.all('SELECT * FROM servers', (err, servers) => {
        res.render('servers', {
            user: req.session.user,
            servers: servers,
            page: 'servers'
        });
    });
});

app.get('/players', (req, res) => {
    if (!req.session.user) return res.redirect('/login');
    res.render('players', { user: req.session.user, page: 'players' });
});

app.get('/console', (req, res) => {
    if (!req.session.user) return res.redirect('/login');
    res.render('console', { user: req.session.user, page: 'console' });
});

// API Routes
app.get('/api/server/status', (req, res) => {
    // Mock server status
    res.json({
        status: 'online',
        players: 12,
        maxPlayers: 32,
        uptime: '2 hours',
        cpu: '45%',
        memory: '60%'
    });
});

// Start server
app.listen(PORT, '0.0.0.0', () => {
    console.log(`üöÄ Skyport Panel running on port ${PORT}`);
    console.log(`üìä Dashboard: http://localhost:${PORT}`);
    console.log(`üîë Default login: admin / admin123`);
});

process.on('SIGINT', () => {
    db.close();
    process.exit();
});
EOF

# Create views directory and EJS templates
mkdir -p views
mkdir -p public/css
mkdir -p public/js

# Create main layout
cat > views/header.ejs << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyport - <%= typeof page !== 'undefined' ? page.charAt(0).toUpperCase() + page.slice(1) : 'Dashboard' %></title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-brand {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .nav-links {
            display: flex;
            gap: 2rem;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.2);
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">Skyport</div>
        <div class="nav-links">
            <a href="/" class="<%= page === 'dashboard' ? 'active' : '' %>">Dashboard</a>
            <a href="/servers" class="<%= page === 'servers' ? 'active' : '' %>">Servers</a>
            <a href="/players" class="<%= page === 'players' ? 'active' : '' %>">Players</a>
            <a href="/console" class="<%= page === 'console' ? 'active' : '' %>">Console</a>
            <% if (user) { %>
                <a href="/logout">Logout (<%= user.username %>)</a>
            <% } %>
        </div>
    </nav>
EOF

cat > views/footer.ejs << 'EOF'
    <script>
        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            if (window.location.pathname === '/') {
                fetch('/api/server/status')
                    .then(r => r.json())
                    .then(data => {
                        document.querySelectorAll('[data-stat]').forEach(el => {
                            const stat = el.getAttribute('data-stat');
                            if (data[stat]) {
                                el.textContent = data[stat];
                            }
                        });
                    });
            }
        }, 30000);
    </script>
</body>
</html>
EOF

# Create dashboard view
cat > views/dashboard.ejs << 'EOF'
<%- include('header', {page: 'dashboard'}) %>
<div class="container">
    <div class="card">
        <h1>Welcome to Skyport, <%= user.username %>! üöÄ</h1>
        <p>FiveM Server Management Panel</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Server Status</h3>
            <p data-stat="status" style="color: #4ade80; font-weight: bold;">Online</p>
        </div>
        <div class="stat-card">
            <h3>Players</h3>
            <p data-stat="players" style="font-size: 1.5rem; font-weight: bold;">12/32</p>
        </div>
        <div class="stat-card">
            <h3>Uptime</h3>
            <p data-stat="uptime" style="font-weight: bold;">2 hours</p>
        </div>
        <div class="stat-card">
            <h3>Performance</h3>
            <p>CPU: <span data-stat="cpu">45%</span> | RAM: <span data-stat="memory">60%</span></p>
        </div>
    </div>

    <div class="card">
        <h2>Quick Actions</h2>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button class="btn" onclick="restartServer()">üîÑ Restart Server</button>
            <button class="btn" onclick="backupServer()">üíæ Backup</button>
            <button class="btn" onclick="openConsole()">üìü Open Console</button>
        </div>
    </div>

    <div class="card">
        <h2>Recent Activity</h2>
        <ul style="list-style: none; margin-top: 1rem;">
            <li>‚úÖ Server started - 2 hours ago</li>
            <li>üë§ Player connected - 5 minutes ago</li>
            <li>üîß Configuration updated - 1 hour ago</li>
        </ul>
    </div>
</div>

<script>
function restartServer() {
    if (confirm('Are you sure you want to restart the server?')) {
        alert('Server restart command sent!');
    }
}

function backupServer() {
    alert('Backup process started!');
}

function openConsole() {
    window.open('/console', '_blank');
}
</script>
<%- include('footer') %>
EOF

# Create login view
cat > views/login.ejs << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyport - Login</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            max-width: 400px;
            color: white;
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .btn-login {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-login:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .error {
            color: #ff6b6b;
            text-align: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <h1>Skyport</h1>
            <p>FiveM Server Management</p>
        </div>
        
        <% if (error) { %>
            <div class="error"><%= error %></div>
        <% } %>
        
        <form method="POST" action="/login">
            <div class="form-group">
                <label>Username</label>
                <input type="text" name="username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" placeholder="Enter password" required>
            </div>
            <button type="submit" class="btn-login">Login</button>
        </form>
        
        <div style="margin-top: 2rem; text-align: center; font-size: 0.9rem; opacity: 0.8;">
            Default: admin / admin123
        </div>
    </div>
</body>
</html>
EOF

# Create other views
cat > views/servers.ejs << 'EOF'
<%- include('header', {page: 'servers'}) %>
<div class="container">
    <div class="card">
        <h1>Server Management</h1>
        <p>Manage your FiveM servers</p>
    </div>

    <div class="card">
        <h2>Your Servers</h2>
        <div style="display: grid; gap: 1rem; margin-top: 1rem;">
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 5px;">
                <h3>Main FiveM Server</h3>
                <p>Status: <span style="color: #4ade80;">Online</span></p>
                <p>Players: 12/32</p>
                <div style="margin-top: 1rem;">
                    <button class="btn">Restart</button>
                    <button class="btn">Stop</button>
                    <button class="btn">Console</button>
                </div>
            </div>
        </div>
    </div>
</div>
<%- include('footer') %>
EOF

cat > views/players.ejs << 'EOF'
<%- include('header', {page: 'players'}) %>
<div class="container">
    <div class="card">
        <h1>Player Management</h1>
        <p>Manage connected players</p>
    </div>

    <div class="card">
        <h2>Online Players (12)</h2>
        <div style="margin-top: 1rem;">
            <table style="width: 100%; border-collapse: collapse; color: white;">
                <thead>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.3);">
                        <th style="padding: 0.5rem; text-align: left;">Player</th>
                        <th style="padding: 0.5rem; text-align: left;">ID</th>
                        <th style="padding: 0.5rem; text-align: left;">Ping</th>
                        <th style="padding: 0.5rem; text-align: left;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 0.5rem;">John_Doe</td>
                        <td style="padding: 0.5rem;">1</td>
                        <td style="padding: 0.5rem;">45ms</td>
                        <td style="padding: 0.5rem;">
                            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Kick</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<%- include('footer') %>
EOF

cat > views/console.ejs << 'EOF'
<%- include('header', {page: 'console'}) %>
<div class="container">
    <div class="card">
        <h1>Server Console</h1>
        <p>Real-time server console</p>
    </div>

    <div class="card">
        <div style="background: #1a1a1a; color: #00ff00; padding: 1rem; border-radius: 5px; font-family: monospace; height: 400px; overflow-y: auto;">
            <div>[INFO] Server started successfully</div>
            <div>[INFO] FiveM version: 1.0.0</div>
            <div>[INFO] 12 players connected</div>
            <div>[CHAT] John_Doe: Hello everyone!</div>
            <div>> _</div>
        </div>
        
        <div style="margin-top: 1rem; display: flex;">
            <input type="text" style="flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 5px 0 0 5px;">
            <button class="btn" style="border-radius: 0 5px 5px 0;">Send Command</button>
        </div>
    </div>
</div>
<%- include('footer') %>
EOF

# Install dependencies
echo_message "[4/5] Installing panel dependencies..."
npm install

# Create systemd service
echo_message "[5/5] Creating panel service..."
cat > /etc/systemd/system/skyport.service << 'EOF'
[Unit]
Description=Skyport FiveM Management Panel
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/skyport-panel
ExecStart=/usr/bin/node /opt/skyport-panel/app.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF

# Reload and start service
systemctl daemon-reload
systemctl enable skyport.service
systemctl start skyport.service

# Create management scripts
cat > /usr/local/bin/skyport-start << 'EOF'
#!/bin/bash
systemctl start skyport
echo "Skyport Panel started on http://localhost:3001"
EOF

cat > /usr/local/bin/skyport-stop << 'EOF'
#!/bin/bash
systemctl stop skyport
echo "Skyport Panel stopped"
EOF

cat > /usr/local/bin/skyport-restart << 'EOF'
#!/bin/bash
systemctl restart skyport
echo "Skyport Panel restarted"
EOF

cat > /usr/local/bin/skyport-status << 'EOF'
#!/bin/bash
systemctl status skyport --no-pager -l
EOF

cat > /usr/local/bin/skyport-logs << 'EOF'
#!/bin/bash
journalctl -u skyport -f --lines=50
EOF

chmod +x /usr/local/bin/skyport-*

# Wait for service to start
sleep 3

echo ""
echo_message "=== üéâ SKYPORT PANEL CREATED SUCCESSFULLY! ==="
echo ""
echo_info "=== PANEL ACCESS ==="
echo "üåê URL: http://$(curl -s ifconfig.me):3001"
echo "üîë Login: admin"
echo "üîë Password: admin123"
echo ""
echo_info "=== MANAGEMENT COMMANDS ==="
echo "skyport-start    - Start panel"
echo "skyport-stop     - Stop panel" 
echo "skyport-restart  - Restart panel"
echo "skyport-status   - Check status"
echo "skyport-logs     - View logs"
echo ""
echo_message "=== PANEL FEATURES ==="
echo "‚úÖ Dashboard with server stats"
echo "‚úÖ Server management"
echo "‚úÖ Player management" 
echo "‚úÖ Live console"
echo "‚úÖ Beautiful modern UI"
echo "‚úÖ Responsive design"
echo ""
echo_info "Checking panel status..."
systemctl is-active --quiet skyport && echo_message "‚úÖ Panel is RUNNING" || echo_error "‚ùå Panel failed to start"

# Test the panel
echo ""
echo_info "Testing panel access..."
curl -s http://localhost:3001 > /dev/null && echo_message "‚úÖ Panel is accessible" || echo_warning "‚ö†Ô∏è  Panel might be starting..."
