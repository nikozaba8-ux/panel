#!/bin/bash

# =============================================
# ü¶ñ PTERODACTYL-LIKE PANEL - ALL IN ONE
# =============================================

# Konfiguracja
PANEL_DIR="/home/panel"
SERVERS_DIR="$PANEL_DIR/servers"
LOGS_DIR="$PANEL_DIR/logs"
BACKUPS_DIR="$PANEL_DIR/backups"
CONFIG_DIR="$PANEL_DIR/config"
WEB_DIR="$PANEL_DIR/web"
USERS_DIR="$PANEL_DIR/users"
DATABASES_DIR="$PANEL_DIR/databases"
RESOURCES_DIR="$PANEL_DIR/resources"
PANEL_BACKUP_DIR="$PANEL_DIR/panel-backups"
PID_FILE="$PANEL_DIR/panel.pid"
PORT=8080

# Limity systemowe
MAX_SERVERS_PER_USER=10
MAX_MEMORY_PER_USER=16384
MIN_PORT=25500
MAX_PORT=30000
DEFAULT_PORTS=(
    ["minecraft"]=25565
    ["fivem"]=30120
    ["python"]=8000
)

# Kolory
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================
# üõ†Ô∏è FUNKCJE POMOCNICZE
# =============================================

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

error() {
    echo -e "${RED}[B≈ÅƒÑD]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

warning() {
    echo -e "${YELLOW}[OSTRZE≈ªENIE]${NC} $1" | tee -a "$LOGS_DIR/panel.log"
}

check_dependencies() {
    local missing=()
    for cmd in nc jq wget unzip python3 java; do
        if ! command -v $cmd &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        warning "BrakujƒÖce zale≈ºno≈õci: ${missing[*]}"
        echo "Instalowanie..."
        apt update && apt install -y netcat-openbsd jq wget unzip python3 python3-pip default-jre
        pip3 install flask django fastapi uvicorn
    fi
}

setup_directories() {
    mkdir -p "$SERVERS_DIR" "$LOGS_DIR" "$BACKUPS_DIR" "$CONFIG_DIR" "$WEB_DIR" \
             "$USERS_DIR" "$DATABASES_DIR" "$RESOURCES_DIR" "$PANEL_BACKUP_DIR"
}

# =============================================
# üîß ZARZƒÑDZANIE PANELEM
# =============================================

create_panel_backup() {
    local backup_name="panel-backup-$(date '+%Y%m%d-%H%M%S')"
    local backup_path="$PANEL_BACKUP_DIR/$backup_name.tar.gz"
    
    log "Tworzenie backupu panelu..."
    if tar -czf "$backup_path" -C /home panel 2>/dev/null; then
        log "Backup panelu utworzony: $backup_path"
        echo "$backup_path"
    else
        error "B≈ÇƒÖd podczas tworzenia backupu panelu"
        return 1
    fi
}

list_panel_backups() {
    local backups=($(ls -1 "$PANEL_BACKUP_DIR"/*.tar.gz 2>/dev/null))
    
    if [ ${#backups[@]} -eq 0 ]; then
        echo "Brak backup√≥w panelu"
        return 1
    fi
    
    echo -e "${CYAN}=== DOSTƒòPNE BACKUPY PANELU ===${NC}"
    for i in "${!backups[@]}"; do
        local backup=$(basename "${backups[$i]}")
        local size=$(du -h "${backups[$i]}" | cut -f1)
        local date=$(stat -c %y "${backups[$i]}" | cut -d' ' -f1)
        echo -e "$((i+1)). $backup ${YELLOW}($size)${NC} - $date"
    done
}

restore_panel_backup() {
    local backup_file="$1"
    local backup_path="$PANEL_BACKUP_DIR/$backup_file"
    
    if [ ! -f "$backup_path" ]; then
        error "Backup nie istnieje: $backup_file"
        return 1
    fi
    
    log "Przywracanie panelu z backupu: $backup_file"
    stop_web_server
    
    # Backup przed przywr√≥ceniem
    create_panel_backup > /dev/null 2>&1
    
    if tar -xzf "$backup_path" -C /home; then
        log "Panel przywr√≥cony pomy≈õlnie z: $backup_file"
        return 0
    else
        error "B≈ÇƒÖd podczas przywracania panelu"
        return 1
    fi
}

uninstall_panel() {
    echo -e "${RED}=== USUWANIE PANELU ===${NC}"
    echo -e "${YELLOW}To dzia≈Çanie usunie ca≈Çkowicie panel i WSZYSTKIE dane!${NC}"
    read -p "Czy na pewno chcesz kontynuowaƒá? (TAK/NIE): " confirm
    
    if [[ $confirm != "TAK" ]]; then
        echo "Anulowano usuwanie panelu"
        return 1
    fi
    
    stop_web_server
    local final_backup=$(create_panel_backup)
    
    rm -rf "$PANEL_DIR"
    rm -f /usr/local/bin/pterodactyl-panel
    rm -f /etc/systemd/system/pterodactyl-panel.service
    
    systemctl daemon-reload
    
    echo -e "${GREEN}Panel zosta≈Ç ca≈Çkowicie usuniƒôty${NC}"
    echo -e "${YELLOW}Ostatni backup zachowany: $final_backup${NC}"
}

reinstall_panel() {
    echo -e "${CYAN}=== REINSTALACJA PANELU ===${NC}"
    local backup_file=$(create_panel_backup)
    stop_web_server
    
    # Zachowaj dane
    local temp_backup="/tmp/panel-reinstall-$(date '+%Y%m%d-%H%M%S').tar.gz"
    tar -czf "$temp_backup" -C "$PANEL_DIR" users servers backups 2>/dev/null
    
    # Odtw√≥rz panel
    rm -rf "$WEB_DIR" "$CONFIG_DIR" "$LOGS_DIR/panel.log"
    mkdir -p "$WEB_DIR" "$CONFIG_DIR"
    create_web_interface
    
    # Przywr√≥ƒá dane
    if [ -f "$temp_backup" ]; then
        tar -xzf "$temp_backup" -C "$PANEL_DIR" 2>/dev/null
        rm -f "$temp_backup"
    fi
    
    start_web_server
    log "Panel zosta≈Ç reinstalowany pomy≈õlnie"
    echo -e "${GREEN}Reinstalacja zako≈Ñczona! Backup: $backup_file${NC}"
}

# =============================================
# üåê INTERFEJS WEB
# =============================================

create_web_interface() {
    # Strona g≈Ç√≥wna Admin
    cat > "$WEB_DIR/index.html" << 'EOF'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Serwerowy - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333; 
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255, 255, 255, 0.95);
            padding: 40px; 
            border-radius: 15px; 
            text-align: center; 
            margin-bottom: 30px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
        }
        .header h1 { 
            font-size: 3em; 
            margin-bottom: 10px; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
            transition: transform 0.3s ease; 
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin-bottom: 15px; color: #2d3748; }
        .card p { color: #718096; margin-bottom: 20px; }
        .btn { 
            display: inline-block; 
            padding: 12px 30px; 
            background: #4299e1; 
            color: white; 
            text-decoration: none; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
        .btn-danger { background: #e53e3e; }
        .btn-warning { background: #ed8936; }
        .btn-success { background: #48bb78; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .management-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .management-panel h2 {
            color: #2d3748;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .limits-panel { 
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #bae6fd;
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px;
        }
        .text-success { color: #28a745; font-weight: 600; }
        .text-danger { color: #dc3545; font-weight: 600; }
        .text-warning { color: #ffc107; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü¶ñ Panel Admina Pterodactyl</h1>
            <p>ZarzƒÖdzanie u≈ºytkownikami, serwerami i panelem</p>
        </div>

        <div class="management-panel">
            <h2>üîß ZarzƒÖdzanie Panelem</h2>
            <div class="card-grid">
                <div class="card">
                    <h3>üíæ Backup Panelu</h3>
                    <p>Utw√≥rz kopiƒô zapasowƒÖ ca≈Çego panelu i danych</p>
                    <button class="btn btn-success" onclick="createPanelBackup()">Utw√≥rz Backup</button>
                </div>
                <div class="card">
                    <h3>üîÑ Reinstalacja</h3>
                    <p>Przywr√≥ƒá panel do ustawie≈Ñ fabrycznych zachowujƒÖc dane</p>
                    <button class="btn btn-warning" onclick="reinstallPanel()">Reinstaluj Panel</button>
                </div>
                <div class="card">
                    <h3>üóëÔ∏è Usuwanie</h3>
                    <p>Ca≈Çkowite usuniƒôcie panelu i wszystkich danych</p>
                    <button class="btn btn-danger" onclick="uninstallPanel()">Usu≈Ñ Panel</button>
                </div>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>üë• ZarzƒÖdzanie U≈ºytkownikami</h3>
                <p>Dodawaj, edytuj i zarzƒÖdzaj u≈ºytkownikami systemu</p>
                <a href="/admin/users" class="btn">Przejd≈∫ do zarzƒÖdzania</a>
            </div>
            <div class="card">
                <h3>üéÆ Wszystkie Serwery</h3>
                <p>PrzeglƒÖdaj i zarzƒÖdzaj wszystkimi serwerami w systemie</p>
                <a href="/admin/servers" class="btn">PrzeglƒÖdaj serwery</a>
            </div>
            <div class="card">
                <h3>üìä Statystyki Systemu</h3>
                <p>Monitoruj u≈ºycie zasob√≥w i wydajno≈õƒá systemu</p>
                <a href="/admin/stats" class="btn">Zobacz statystyki</a>
            </div>
        </div>
    </div>

    <script>
        async function createPanelBackup() {
            if (!confirm('Czy na pewno chcesz utworzyƒá backup panelu?')) return;
            
            try {
                const response = await fetch('/api/admin/panel/backup', {method: 'POST'});
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Backup panelu utworzony pomy≈õlnie!\nPlik: ' + result.backup_path);
                } else {
                    alert('‚ùå B≈ÇƒÖd podczas tworzenia backupu: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå B≈ÇƒÖd: ' + error);
            }
        }

        async function reinstallPanel() {
            if (!confirm('Czy na pewno chcesz reinstalowaƒá panel?\nDane u≈ºytkownik√≥w i serwer√≥w zostanƒÖ zachowane.')) return;
            
            try {
                const response = await fetch('/api/admin/panel/reinstall', {method: 'POST'});
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Panel zosta≈Ç reinstalowany pomy≈õlnie!\nStrona zostanie prze≈Çadowana.');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('‚ùå B≈ÇƒÖd podczas reinstalacji: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå B≈ÇƒÖd: ' + error);
            }
        }

        async function uninstallPanel() {
            const confirm1 = confirm('üö® UWAGA: To dzia≈Çanie usunie ca≈Çkowicie panel i WSZYSTKIE dane!');
            if (!confirm1) return;
            
            const confirm2 = confirm('üóëÔ∏è Czy NA PEWNO chcesz USUNƒÑƒÜ panel? Ta operacja jest NIEODWRACALNA!');
            if (!confirm2) return;
            
            const confirm3 = prompt('Aby potwierdziƒá usuniƒôcie, wpisz "USU≈É PANEL":');
            if (confirm3 !== 'USU≈É PANEL') {
                alert('Anulowano usuwanie panelu');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/panel/uninstall', {method: 'POST'});
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Panel zosta≈Ç usuniƒôty!\nStrona przestanie dzia≈Çaƒá.');
                } else {
                    alert('‚ùå B≈ÇƒÖd podczas usuwania: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå B≈ÇƒÖd: ' + error);
            }
        }
    </script>
</body>
</html>
EOF

    # Panel klienta
    mkdir -p "$WEB_DIR/client"
    cat > "$WEB_DIR/client/index.html" << 'EOF'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Klienta</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: #333; 
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .user-info h1 { font-size: 1.8em; color: #2d3748; margin-bottom: 5px; }
        .user-info p { color: #718096; }
        .nav-tabs { 
            display: flex; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 10px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); 
            flex-wrap: wrap;
        }
        .nav-tab { 
            padding: 12px 24px; 
            background: none; 
            border: none; 
            font-weight: 600; 
            color: #718096; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border-radius: 8px; 
            margin-right: 5px; 
            margin-bottom: 5px;
        }
        .nav-tab.active { background: #4299e1; color: white; }
        .tab-content { 
            display: none; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
            min-height: 500px; 
        }
        .tab-content.active { display: block; }
        
        .server-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .server-card { 
            background: rgba(255, 255, 255, 0.98); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); 
            border-left: 4px solid #4299e1; 
        }
        .server-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid #e2e8f0; 
        }
        .server-name { font-size: 1.3em; font-weight: 600; color: #2d3748; }
        .server-status { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            font-weight: 600; 
        }
        .status-running { background: #c6f6d5; color: #276749; }
        .status-stopped { background: #fed7d7; color: #c53030; }
        .server-info { margin-bottom: 15px; }
        .info-item { display: flex; justify-content: space-between; margin-bottom: 8px; padding: 3px 0; }
        .info-label { color: #718096; font-weight: 500; }
        .info-value { color: #2d3748; font-weight: 600; }
        .server-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-align: center; 
            font-size: 0.9em; 
        }
        .btn-primary { background: #4299e1; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-info { background: #38b2ac; color: white; }
        
        .limits-panel { 
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #bae6fd;
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748; }
        .form-input, .form-select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 6px; 
            font-size: 1em; 
        }
        .form-select { background: white; }
        .form-hint { font-size: 0.8em; margin-top: 5px; min-height: 1em; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                <h1>üëã Witaj, <span id="username">Klient</span></h1>
                <p>Tw√≥j panel zarzƒÖdzania serwerami</p>
            </div>
            <div>
                <button class="btn btn-info" onclick="logout()">üö™ Wyloguj</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('servers')">üéÆ Serwery</button>
            <button class="nav-tab" onclick="switchTab('console')">üìü Konsola</button>
            <button class="nav-tab" onclick="switchTab('settings')">‚öôÔ∏è Ustawienia</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 20px;">üìä Podsumowanie</h2>
            <div class="server-grid" id="dashboard-servers"></div>
        </div>

        <div id="servers" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üéÆ Twoje Serwery</h2>
                <button class="btn btn-success" onclick="showCreateServerModal()">‚ûï Nowy Serwer</button>
            </div>
            <div class="server-grid" id="servers-list"></div>
        </div>

        <div id="console" class="tab-content">
            <h2 style="margin-bottom: 20px;">üìü Konsola Serwera</h2>
            <div class="form-group">
                <label class="form-label">Wybierz Serwer</label>
                <select class="form-select" id="console-server-select" onchange="loadConsole()">
                    <option value="">Wybierz serwer...</option>
                </select>
            </div>
            <div class="console-output" id="console-output">Wybierz serwer...</div>
            <div class="console-input">
                <input type="text" id="console-command" placeholder="Wpisz komendƒô..." onkeypress="handleConsoleCommand(event)">
                <button class="btn btn-primary" onclick="sendConsoleCommand()">Wy≈õlij</button>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Ustawienia Konta</h2>
            <div style="max-width: 600px;">
                <div class="form-group">
                    <label class="form-label">Nazwa u≈ºytkownika</label>
                    <input type="text" class="form-input" id="settings-username" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="settings-email">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Zapisz Zmiany</button>
            </div>
        </div>
    </div>

    <!-- Modal tworzenia serwera -->
    <div id="createServerModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">üéÆ Utw√≥rz Nowy Serwer</h2>
            
            <div class="limits-panel">
                <h4 style="margin: 0 0 10px 0; color: #0369a1;">üìä Twoje Limity</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                    <div><strong>Serwery:</strong> <span id="limit-servers">≈Åadowanie...</span></div>
                    <div><strong>Pamiƒôƒá RAM:</strong> <span id="limit-memory">≈Åadowanie...</span></div>
                    <div><strong>Wolne porty:</strong> <span id="limit-ports">≈Åadowanie...</span></div>
                    <div><strong>Zakres port√≥w:</strong> <span id="limit-port-range">25500-30000</span></div>
                </div>
            </div>

            <form id="create-server-form">
                <div class="form-group">
                    <label class="form-label">Nazwa Serwera</label>
                    <input type="text" class="form-input" name="name" required placeholder="np. MyMinecraftServer">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Typ Serwera</label>
                    <select class="form-select" name="type" required>
                        <option value="">Wybierz typ...</option>
                        <option value="minecraft">Minecraft</option>
                        <option value="fivem">FiveM</option>
                        <option value="python">Python</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Port Serwera</label>
                    <input type="number" class="form-input" name="port" required value="25565" min="25500" max="30000">
                </div>

                <div class="form-group">
                    <label class="form-label">RAM (MB)</label>
                    <input type="number" class="form-input" name="memory" required value="2048" min="512" max="16384">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üöÄ Utw√≥rz Serwer</button>
                    <button type="button" class="btn" onclick="hideCreateServerModal()">Anuluj</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentServer = null;

        async function loadUserData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const user = urlParams.get('user');
                const response = await fetch(`/api/client/user?user=${user}`);
                currentUser = await response.json();
                
                document.getElementById('username').textContent = currentUser.username;
                document.getElementById('settings-username').value = currentUser.username;
                document.getElementById('settings-email').value = currentUser.email;
                
                loadUserServers();
                loadConsoleServers();
            } catch (error) {
                window.location.href = '/';
            }
        }

        async function loadUserServers() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const user = urlParams.get('user');
                const response = await fetch(`/api/client/servers?user=${user}`);
                const servers = await response.json();
                
                let html = '';
                servers.forEach(server => {
                    html += `
                        <div class="server-card">
                            <div class="server-header">
                                <div class="server-name">${server.name}</div>
                                <div class="server-status ${server.status === 'running' ? 'status-running' : 'status-stopped'}">
                                    ${server.status === 'running' ? 'DZIA≈ÅA' : 'STOP'}
                                </div>
                            </div>
                            <div class="server-info">
                                <div class="info-item"><span class="info-label">Typ:</span><span class="info-value">${server.type}</span></div>
                                <div class="info-item"><span class="info-label">Port:</span><span class="info-value">${server.port}</span></div>
                                <div class="info-item"><span class="info-label">RAM:</span><span class="info-value">${server.memory}MB</span></div>
                            </div>
                            <div class="server-actions">
                                <button class="btn ${server.status === 'running' ? 'btn-danger' : 'btn-success'}" 
                                        onclick="toggleServer('${server.name}')">
                                    ${server.status === 'running' ? '‚èπ Stop' : '‚ñ∂ Start'}
                                </button>
                                <button class="btn btn-warning" onclick="restartServer('${server.name}')">üîÑ Restart</button>
                                <button class="btn btn-info" onclick="showServerConsole('${server.name}')">üìü Konsola</button>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('dashboard-servers').innerHTML = html || '<p>Brak serwer√≥w</p>';
                document.getElementById('servers-list').innerHTML = html || '<p>Brak serwer√≥w</p>';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showCreateServerModal() {
            document.getElementById('createServerModal').style.display = 'block';
            loadUserLimits();
        }

        function hideCreateServerModal() {
            document.getElementById('createServerModal').style.display = 'none';
        }

        async function loadUserLimits() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const user = urlParams.get('user');
                const response = await fetch(`/api/client/limits?user=${user}`);
                const limits = await response.json();
                
                document.getElementById('limit-servers').textContent = 
                    `${limits.server_count}/${limits.max_servers}`;
                document.getElementById('limit-memory').textContent = 
                    `${limits.used_memory}MB/${limits.max_memory}MB`;
                document.getElementById('limit-ports').textContent = 
                    `${limits.used_ports.length} u≈ºywanych`;
            } catch (error) {
                console.error('Error loading limits:', error);
            }
        }

        document.getElementById('create-server-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            const urlParams = new URLSearchParams(window.location.search);
            const user = urlParams.get('user');
            
            try {
                const response = await fetch(`/api/client/server/create?user=${user}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert('Serwer utworzony!');
                    hideCreateServerModal();
                    loadUserServers();
                    switchTab('servers');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error);
            }
        });

        async function toggleServer(serverName) {
            const urlParams = new URLSearchParams(window.location.search);
            const user = urlParams.get('user');
            
            try {
                await fetch(`/api/client/server/${serverName}/toggle?user=${user}`, {method: 'POST'});
                loadUserServers();
                loadConsoleServers();
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        async function loadConsoleServers() {
            const urlParams = new URLSearchParams(window.location.search);
            const user = urlParams.get('user');
            const response = await fetch(`/api/client/servers?user=${user}`);
            const servers = await response.json();
            
            let options = '<option value="">Wybierz serwer...</option>';
            servers.forEach(server => {
                options += `<option value="${server.name}">${server.name}</option>`;
            });
            document.getElementById('console-server-select').innerHTML = options;
        }

        async function loadConsole() {
            const serverName = document.getElementById('console-server-select').value;
            if (!serverName) return;
            
            currentServer = serverName;
            const urlParams = new URLSearchParams(window.location.search);
            const user = urlParams.get('user');
            const response = await fetch(`/api/client/server/${serverName}/console?user=${user}`);
            const data = await response.json();
            document.getElementById('console-output').textContent = data.output;
        }

        function handleConsoleCommand(event) {
            if (event.key === 'Enter') sendConsoleCommand();
        }

        async function sendConsoleCommand() {
            const command = document.getElementById('console-command').value;
            if (!command || !currentServer) return;
            
            const urlParams = new URLSearchParams(window.location.search);
            const user = urlParams.get('user');
            
            await fetch(`/api/client/server/${currentServer}/command?user=${user}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: command })
            });
            
            document.getElementById('console-command').value = '';
            setTimeout(loadConsole, 500);
        }

        function showServerConsole(serverName) {
            document.getElementById('console-server-select').value = serverName;
            loadConsole();
            switchTab('console');
        }

        function logout() {
            window.location.href = '/';
        }

        // Auto-refresh
        setInterval(() => {
            if (currentServer && document.getElementById('console').classList.contains('active')) {
                loadConsole();
            }
        }, 2000);

        loadUserData();
    </script>
</body>
</html>
EOF

    create_api_endpoints
}

create_api_endpoints() {
    cat > "$WEB_DIR/api.sh" << 'EOF'
#!/bin/bash

response() {
    echo "Content-Type: application/json"
    echo ""
    echo "$1"
}

error_response() {
    response "{\"success\": false, \"error\": \"$1\"}"
}

success_response() {
    response "{\"success\": true}"
}

get_query_param() {
    echo "$REQUEST_URI" | grep -o "$1=[^&]*" | cut -d= -f2
}

# API Management Panel
admin_panel_backup() {
    backup_path=$(create_panel_backup)
    if [ $? -eq 0 ]; then
        response "{\"success\": true, \"backup_path\": \"$backup_path\"}"
    else
        error_response "Failed to create backup"
    fi
}

admin_panel_reinstall() {
    reinstall_panel
    if [ $? -eq 0 ]; then
        response "{\"success\": true, \"message\": \"Panel reinstalled successfully\"}"
    else
        error_response "Failed to reinstall panel"
    fi
}

admin_panel_uninstall() {
    uninstall_panel
    if [ $? -eq 0 ]; then
        response "{\"success\": true, \"message\": \"Panel uninstalled successfully\"}"
    else
        error_response "Failed to uninstall panel"
    fi
}

# API Client
client_get_user() {
    username=$(get_query_param "user")
    if [ -f "$USERS_DIR/$username.conf" ]; then
        source "$USERS_DIR/$username.conf"
        response "{
            \"username\": \"$USERNAME\",
            \"email\": \"$USER_EMAIL\",
            \"created\": \"$USER_CREATED\"
        }"
    else
        error_response "User not found"
    fi
}

client_get_servers() {
    username=$(get_query_param "user")
    servers=()
    
    for server_dir in "$SERVERS_DIR"/${username}_*; do
        if [ -d "$server_dir" ]; then
            server_name=$(basename "$server_dir")
            config_file="$CONFIG_DIR/$server_name.conf"
            
            if [ -f "$config_file" ]; then
                source "$config_file"
                status=$(get_server_status "$server_name")
                
                servers+=("{
                    \"name\": \"$server_name\",
                    \"type\": \"$SERVER_TYPE\",
                    \"port\": \"$SERVER_PORT\",
                    \"memory\": \"${SERVER_MEMORY:-1024}\",
                    \"status\": \"$status\"
                }")
            fi
        fi
    done
    
    response "[$(IFS=,; echo "${servers[*]}")]"
}

client_get_limits() {
    username=$(get_query_param "user")
    if [ -f "$USERS_DIR/$username.conf" ]; then
        read -r server_count used_memory free_servers free_memory <<< $(get_user_limits "$username")
        local used_ports=($(get_used_ports))
        
        response "{
            \"server_count\": $server_count,
            \"used_memory\": $used_memory,
            \"free_servers\": $free_servers,
            \"free_memory\": $free_memory,
            \"max_servers\": $MAX_SERVERS_PER_USER,
            \"max_memory\": $MAX_MEMORY_PER_USER,
            \"used_ports\": [$(IFS=,; echo "${used_ports[*]}")],
            \"port_range\": \"$MIN_PORT-$MAX_PORT\"
        }"
    else
        error_response "User not found"
    fi
}

# Routing
case "$REQUEST_URI" in
    /api/admin/panel/backup)
        admin_panel_backup
        ;;
    /api/admin/panel/reinstall)
        admin_panel_reinstall
        ;;
    /api/admin/panel/uninstall)
        admin_panel_uninstall
        ;;
    /api/client/user)
        client_get_user
        ;;
    /api/client/servers)
        client_get_servers
        ;;
    /api/client/limits)
        client_get_limits
        ;;
    /api/client/server/create)
        client_create_server
        ;;
    /api/client/server/*/toggle)
        client_toggle_server
        ;;
    /api/client/server/*/console)
        client_get_console
        ;;
    /api/client/server/*/command)
        client_send_command
        ;;
    /admin/*)
        echo "Content-Type: text/html"
        echo ""
        cat "$WEB_DIR/index.html"
        ;;
    /client/*)
        echo "Content-Type: text/html"
        echo ""
        cat "$WEB_DIR/client/index.html"
        ;;
    *)
        echo "Content-Type: text/html"
        echo ""
        cat "$WEB_DIR/index.html"
        ;;
esac
EOF
    chmod +x "$WEB_DIR/api.sh"
}

# =============================================
# üéÆ FUNKCJE SERWER√ìW
# =============================================

get_user_limits() {
    local username="$1"
    local user_servers=($(ls "$SERVERS_DIR" 2>/dev/null | grep "^${username}_" || true))
    local server_count=${#user_servers[@]}
    local used_memory=0
    
    for server in "${user_servers[@]}"; do
        if [ -f "$CONFIG_DIR/$server.conf" ]; then
            source "$CONFIG_DIR/$server.conf"
            used_memory=$((used_memory + SERVER_MEMORY))
        fi
    done
    
    local free_servers=$((MAX_SERVERS_PER_USER - server_count))
    local free_memory=$((MAX_MEMORY_PER_USER - used_memory))
    
    echo "$server_count $used_memory $free_servers $free_memory"
}

get_used_ports() {
    local used_ports=()
    for config_file in "$CONFIG_DIR"/*.conf; do
        if [ -f "$config_file" ]; then
            source "$config_file"
            used_ports+=("$SERVER_PORT")
        fi
    done
    echo "${used_ports[@]}"
}

get_server_status() {
    local server="$1"
    local pid_file="$SERVERS_DIR/$server/server.pid"
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if ps -p "$pid" > /dev/null 2>&1; then
            echo "running"
        else
            echo "stopped"
        fi
    else
        echo "stopped"
    fi
}

create_minecraft_server() {
    local server_name="$1" port="$2" memory="$3"
    local server_dir="$SERVERS_DIR/$server_name"
    
    mkdir -p "$server_dir"
    
    # Pobierz Minecraft server
    if [ ! -f "$RESOURCES_DIR/minecraft-server.jar" ]; then
        wget -q "https://piston-data.mojang.com/v1/objects/8f3112a1049751cc472ec13e397eade5336ca7ae/server.jar" \
             -O "$RESOURCES_DIR/minecraft-server.jar"
    fi
    
    cp "$RESOURCES_DIR/minecraft-server.jar" "$server_dir/server.jar"
    
    cat > "$server_dir/start.sh" << EOF
#!/bin/bash
cd "$server_dir"
java -Xmx${memory}M -Xms1024M -jar server.jar nogui
EOF
    chmod +x "$server_dir/start.sh"
    
    # Konfiguracja
    cat > "$CONFIG_DIR/$server_name.conf" << EOF
SERVER_TYPE=minecraft
SERVER_PORT=$port
SERVER_MEMORY=$memory
START_SCRIPT=start.sh
EOF
    
    log "Utworzono serwer Minecraft: $server_name"
    return 0
}

create_fivem_server() {
    local server_name="$1" port="$2" memory="$3"
    local server_dir="$SERVERS_DIR/$server_name"
    
    mkdir -p "$server_dir"
    
    cat > "$server_dir/start.sh" << EOF
#!/bin/bash
cd "$server_dir"
echo "FiveM Server $server_name is running on port $port"
while true; do
    echo "[FiveM] Server is active - \$(date)"
    sleep 30
done
EOF
    chmod +x "$server_dir/start.sh"
    
    cat > "$CONFIG_DIR/$server_name.conf" << EOF
SERVER_TYPE=fivem
SERVER_PORT=$port
SERVER_MEMORY=$memory
START_SCRIPT=start.sh
EOF
    
    log "Utworzono serwer FiveM: $server_name"
    return 0
}

create_python_server() {
    local server_name="$1" port="$2" memory="$3"
    local server_dir="$SERVERS_DIR/$server_name"
    
    mkdir -p "$server_dir"
    
    cat > "$server_dir/app.py" << EOF
from http.server import HTTPServer, BaseHTTPRequestHandler

class SimpleHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/html')
        self.end_headers()
        self.wfile.write(b'<h1>Python Server is Running!</h1><p>Server: ' + b'$server_name' + b'</p>')
    
    def log_message(self, format, *args):
        pass

if __name__ == '__main__':
    server = HTTPServer(('0.0.0.0', $port), SimpleHandler)
    server.serve_forever()
EOF

    cat > "$server_dir/start.sh" << EOF
#!/bin/bash
cd "$server_dir"
python3 app.py
EOF
    chmod +x "$server_dir/start.sh"
    
    cat > "$CONFIG_DIR/$server_name.conf" << EOF
SERVER_TYPE=python
SERVER_PORT=$port
SERVER_MEMORY=$memory
START_SCRIPT=start.sh
EOF
    
    log "Utworzono serwer Python: $server_name"
    return 0
}

client_create_server() {
    username=$(get_query_param "user")
    read -r data
    
    name=$(echo "$data" | jq -r '.name')
    type=$(echo "$data" | jq -r '.type')
    port=$(echo "$data" | jq -r '.port')
    memory=$(echo "$data" | jq -r '.memory')
    
    if [ -z "$name" ] || [ -z "$type" ] || [ -z "$port" ] || [ -z "$memory" ]; then
        error_response "Missing required fields"
        return 1
    fi
    
    # Sprawd≈∫ limity
    read -r server_count used_memory free_servers free_memory <<< $(get_user_limits "$username")
    
    if [ $server_count -ge $MAX_SERVERS_PER_USER ]; then
        error_response "Maximum server limit reached"
        return 1
    fi
    
    if [ $memory -gt $free_memory ]; then
        error_response "Not enough memory available"
        return 1
    fi
    
    server_name="${username}_${name}"
    
    if [ -d "$SERVERS_DIR/$server_name" ]; then
        error_response "Server already exists"
        return 1
    fi
    
    case $type in
        minecraft)
            create_minecraft_server "$server_name" "$port" "$memory"
            ;;
        fivem)
            create_fivem_server "$server_name" "$port" "$memory"
            ;;
        python)
            create_python_server "$server_name" "$port" "$memory"
            ;;
        *)
            error_response "Invalid server type"
            return 1
            ;;
    esac
    
    if [ $? -eq 0 ]; then
        success_response
    else
        error_response "Failed to create server"
    fi
}

client_toggle_server() {
    server_name=$(echo "$REQUEST_URI" | cut -d'/' -f5)
    username=$(get_query_param "user")
    
    if [[ "$server_name" != ${username}_* ]]; then
        error_response "Access denied"
        return 1
    fi
    
    status=$(get_server_status "$server_name")
    server_dir="$SERVERS_DIR/$server_name"
    
    if [ "$status" = "running" ]; then
        # Stop server
        pid_file="$server_dir/server.pid"
        if [ -f "$pid_file" ]; then
            pid=$(cat "$pid_file")
            kill "$pid" 2>/dev/null
            rm -f "$pid_file"
        fi
    else
        # Start server
        cd "$server_dir"
        nohup bash "./start.sh" >> "$LOGS_DIR/$server_name.log" 2>&1 &
        echo $! > "$server_dir/server.pid"
    fi
    
    success_response
}

client_get_console() {
    server_name=$(echo "$REQUEST_URI" | cut -d'/' -f5)
    username=$(get_query_param "user")
    
    if [[ "$server_name" != ${username}_* ]]; then
        error_response "Access denied"
        return 1
    fi
    
    log_file="$LOGS_DIR/$server_name.log"
    if [ -f "$log_file" ]; then
        output=$(tail -50 "$log_file" 2>/dev/null | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
    else
        output="Brak log√≥w"
    fi
    
    response "{\"output\": \"$output\"}"
}

client_send_command() {
    server_name=$(echo "$REQUEST_URI" | cut -d'/' -f5)
    username=$(get_query_param "user")
    
    if [[ "$server_name" != ${username}_* ]]; then
        error_response "Access denied"
        return 1
    fi
    
    read -r data
    command=$(echo "$data" | jq -r '.command')
    
    # Zapisz komendƒô do log√≥w
    echo "[COMMAND] $command" >> "$LOGS_DIR/$server_name.log"
    
    success_response
}

# =============================================
# üåê SERWER WEB
# =============================================

start_web_server() {
    log "Uruchamianie serwera web na porcie $PORT..."
    
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            warning "Serwer web ju≈º dzia≈Ça (PID: $pid)"
            return 0
        fi
    fi
    
    {
        while true; do
            nc -l -p "$PORT" -c "
                read -r request
                export REQUEST_URI=\$(echo \"\$request\" | awk '{print \$2}')
                export REQUEST_METHOD=\$(echo \"\$request\" | awk '{print \$1}')
                . '$WEB_DIR/api.sh'
            "
        done
    } > /dev/null 2>&1 &
    
    echo $! > "$PID_FILE"
    log "Serwer web uruchomiony: http://localhost:$PORT"
}

stop_web_server() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        kill "$pid" 2>/dev/null
        rm -f "$PID_FILE"
        log "Serwer web zatrzymany"
    fi
}

# =============================================
# üìã MENU G≈Å√ìWNE
# =============================================

show_management_menu() {
    while true; do
        clear
        echo -e "${BLUE}=== ZARZƒÑDZANIE PANELEM ===${NC}"
        echo -e "${GREEN}1.${NC} üöÄ Uruchom panel web"
        echo -e "${GREEN}2.${NC} ‚èπÔ∏è  Zatrzymaj panel web"
        echo -e "${GREEN}3.${NC} üîÑ Restartuj panel web"
        echo -e "${GREEN}4.${NC} üìä Status panelu"
        echo ""
        echo -e "${YELLOW}5.${NC} üíæ Utw√≥rz backup panelu"
        echo -e "${YELLOW}6.${NC} üì¶ Lista backup√≥w panelu"
        echo -e "${YELLOW}7.${NC} üîÑ Przywr√≥ƒá panel z backupu"
        echo ""
        echo -e "${BLUE}8.${NC} üõ†Ô∏è  Reinstalacja panelu"
        echo -e "${RED}9.${NC} üóëÔ∏è  Usu≈Ñ panel"
        echo ""
        echo -e "${CYAN}0.${NC} üìã Informacje o panelu"
        echo -e "${RED}q.${NC} ‚ùå Wyj≈õcie"
        echo ""
        echo -n "Wybierz opcjƒô: "
        read choice

        case $choice in
            1)
                start_web_server
                echo -e "${GREEN}‚úÖ Panel web uruchomiony${NC}"
                ;;
            2)
                stop_web_server
                echo -e "${YELLOW}‚èπÔ∏è Panel web zatrzymany${NC}"
                ;;
            3)
                stop_web_server
                sleep 2
                start_web_server
                echo -e "${GREEN}üîÑ Panel web zrestartowany${NC}"
                ;;
            4)
                if [ -f "$PID_FILE" ]; then
                    local pid=$(cat "$PID_FILE")
                    if ps -p "$pid" > /dev/null 2>&1; then
                        echo -e "Status: ${GREEN}DZIA≈ÅA${NC} (PID: $pid)"
                        echo "URL: http://localhost:$PORT"
                    else
                        echo -e "Status: ${RED}ZATRZYMANY${NC}"
                    fi
                else
                    echo -e "Status: ${RED}ZATRZYMANY${NC}"
                fi
                ;;
            5)
                create_panel_backup
                ;;
            6)
                list_panel_backups
                ;;
            7)
                list_panel_backups
                if [ $? -eq 0 ]; then
                    echo -n "Wybierz numer backupu do przywr√≥cenia: "
                    read backup_num
                    local backups=($(ls -1 "$PANEL_BACKUP_DIR"/*.tar.gz 2>/dev/null))
                    if [[ $backup_num =~ ^[0-9]+$ ]] && [ $backup_num -ge 1 ] && [ $backup_num -le ${#backups[@]} ]; then
                        local backup_file=$(basename "${backups[$((backup_num-1))]}")
                        restore_panel_backup "$backup_file"
                    else
                        error "Nieprawid≈Çowy numer backupu"
                    fi
                fi
                ;;
            8)
                reinstall_panel
                ;;
            9)
                uninstall_panel
                exit 0
                ;;
            0)
                echo -e "${CYAN}=== INFORMACJE O PANELU ===${NC}"
                echo "Katalog panelu: $PANEL_DIR"
                echo "Port: $PORT"
                echo "URL Panelu: http://localhost:$PORT"
                echo "URL Client: http://localhost:$PORT/client/?user=testuser"
                echo ""
                echo -e "${GREEN}Przyk≈Çadowe konto:${NC}"
                echo "U≈ºytkownik: testuser"
                echo "Has≈Ço: test123"
                ;;
            q|Q)
                echo "Do widzenia!"
                exit 0
                ;;
            *)
                warning "Nieprawid≈Çowy wyb√≥r"
                ;;
        esac
        
        echo ""
        echo -n "Naci≈õnij Enter aby kontynuowaƒá..."
        read
    done
}

# =============================================
# üöÄ INICJALIZACJA
# =============================================

initialize_panel() {
    # Sprawd≈∫ uprawnienia
    if [ "$EUID" -ne 0 ]; then
        echo "Uruchom jako root: sudo $0"
        exit 1
    fi
    
    # Sprawd≈∫ zale≈ºno≈õci
    check_dependencies
    
    # Utw√≥rz katalogi
    setup_directories
    
    # Utw√≥rz przyk≈Çadowego u≈ºytkownika
    if [ ! -f "$USERS_DIR/testuser.conf" ]; then
        cat > "$USERS_DIR/testuser.conf" << EOF
USERNAME="testuser"
USER_EMAIL="test@example.com"
USER_PASSWORD="test123"
USER_CREATED="$(date '+%Y-%m-%d %H:%M:%S')"
EOF
        log "Utworzono przyk≈Çadowego u≈ºytkownika: testuser/test123"
    fi
    
    # Utw√≥rz interfejs web
    create_web_interface
    
    log "Panel Pterodactyl zainicjalizowany"
}

# =============================================
# üìú MAIN SCRIPT
# =============================================

case "${1:-}" in
    "install")
        echo -e "${GREEN}Instalacja Panelu Pterodactyl...${NC}"
        initialize_panel
        
        # Skopiuj siebie do /usr/local/bin
        cp "$0" /usr/local/bin/pterodactyl-panel
        chmod +x /usr/local/bin/pterodactyl-panel
        
        # Utw√≥rz us≈Çugƒô systemd
        cat > /etc/systemd/system/pterodactyl-panel.service << EOF
[Unit]
Description=Pterodactyl-like Panel
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/home/panel
ExecStart=/usr/local/bin/pterodactyl-panel daemon
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
        
        systemctl daemon-reload
        systemctl enable pterodactyl-panel
        
        echo -e "${GREEN}‚úÖ Panel zainstalowany!${NC}"
        echo -e "Uruchom: ${CYAN}sudo systemctl start pterodactyl-panel${NC}"
        echo -e "Lub: ${CYAN}sudo pterodactyl-panel${NC}"
        ;;
        
    "daemon")
        initialize_panel
        start_web_server
        
        echo -e "${GREEN}ü¶ñ Panel Pterodactyl uruchomiony!${NC}"
        echo -e "${CYAN}Panel Admin:${NC} http://localhost:$PORT"
        echo -e "${CYAN}Client Area:${NC} http://localhost:$PORT/client/?user=testuser"
        echo ""
        echo -e "${YELLOW}Naci≈õnij Ctrl+C aby zatrzymaƒá panel${NC}"
        
        # Czekaj na Ctrl+C
        while true; do
            sleep 1
        done
        ;;
        
    "uninstall")
        uninstall_panel
        ;;
        
    "backup")
        create_panel_backup
        ;;
        
    "restore")
        if [ -n "$2" ]; then
            restore_panel_backup "$2"
        else
            list_panel_backups
            echo ""
            echo "U≈ºycie: $0 restore <nazwa-backupu>"
        fi
        ;;
        
    "status")
        if [ -f "$PID_FILE" ]; then
            pid=$(cat "$PID_FILE")
            if ps -p "$pid" > /dev/null 2>&1; then
                echo -e "Status: ${GREEN}DZIA≈ÅA${NC} (PID: $pid)"
                echo "URL: http://localhost:$PORT"
            else
                echo -e "Status: ${RED}ZATRZYMANY${NC}"
            fi
        else
            echo -e "Status: ${RED}ZATRZYMANY${NC}"
        fi
        ;;
        
    *)
        initialize_panel
        show_management_menu
        ;;
esac

# Przechwyƒá Ctrl+C
trap 'stop_web_server; echo -e "\n${YELLOW}Panel zatrzymany${NC}"; exit 0' INT TERM
