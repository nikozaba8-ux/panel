#!/bin/bash

# =============================================
# üü£ PURPLEHOST - PRAWDZIWE SERWERY MINECRAFT
# =============================================

# Automatyczne wykrywanie ≈õcie≈ºki
PANEL_DIR="/home/purplehost"
mkdir -p "$PANEL_DIR"

# Konfiguracja
WEB_DIR="$PANEL_DIR/web"
SERVER_DIR="$PANEL_DIR/serwery"
DB_DIR="$PANEL_DIR/bazy"
BACKUP_DIR="$PANEL_DIR/backupy"
LOG_DIR="$PANEL_DIR/logs"
PORT=8080

# Kolory
PURPLE='\033[0;35m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================
# üõ†Ô∏è FUNKCJE
# =============================================

log() {
    echo -e "${PURPLE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
    mkdir -p "$LOG_DIR"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_DIR/panel.log"
}

create_structure() {
    echo -e "${PURPLE}üìÅ Tworzenie struktury...${NC}"
    mkdir -p "$PANEL_DIR" "$WEB_DIR" "$SERVER_DIR" "$DB_DIR" "$BACKUP_DIR" "$LOG_DIR"
    mkdir -p "$SERVER_DIR/minecraft" "$SERVER_DIR/backups"
    
    cat > "$DB_DIR/serwery.json" << 'EOF'
[]
EOF
    echo -e "${GREEN}‚úÖ Struktura utworzona${NC}"
}

check_dependencies() {
    echo -e "${PURPLE}üîç Sprawdzanie zale≈ºno≈õci...${NC}"
    
    if ! command -v python3 &> /dev/null; then
        echo "Instalowanie Python 3..."
        apt update && apt install -y python3 python3-pip
    fi
    
    if ! command -v java &> /dev/null; then
        echo "Instalowanie Java..."
        apt install -y openjdk-17-jre-headless
    fi
    
    if ! command -v wget &> /dev/null; then
        apt install -y wget
    fi
    
    echo -e "${GREEN}‚úÖ Zale≈ºno≈õci sprawdzone${NC}"
}

# =============================================
# üêç BACKEND - NATYCHMIASTOWE WGRYWANIE PLIK√ìW
# =============================================

create_backend() {
    echo -e "${PURPLE}üîß Tworzenie backend API z natychmiastowym wgrywaniem...${NC}"
    
    cat > "$WEB_DIR/api.py" << 'PYTHON'
#!/usr/bin/env python3
import json
import os
import subprocess
import shutil
import threading
import time
import select
from datetime import datetime
import urllib.request
import base64

# Linki do oficjalnych serwer√≥w Minecraft
MINECRAFT_VERSIONS = {
    "1.20.1": "https://piston-data.mojang.com/v1/objects/84194a2f286ef7c14ed7ce0090dba59902951553/server.jar",
    "1.19.4": "https://piston-data.mojang.com/v1/objects/8b9111e882ad64c66cd1639b3e04d6c7cbb6b13a/server.jar", 
    "1.18.2": "https://piston-data.mojang.com/v1/objects/c8f83c5655308435b3dcf03c06d9fe8740a77469/server.jar"
}

class RealMinecraftServer:
    def __init__(self, server_id, name, version, ram, port, path):
        self.server_id = server_id
        self.name = name
        self.version = version
        self.ram = ram
        self.port = port
        self.path = path
        self.process = None
        self.status = "stopped"
        self.console_buffer = []
        self.console_callbacks = []
        self.players = []
        self.start_time = None
        self.files_created = False
        
    def create_essential_files_instant(self):
        """Natychmiast tworzy WSZYSTKIE potrzebne pliki"""
        try:
            # server.properties - natychmiast
            server_props = f"""# Minecraft Server Properties
max-players=20
server-port={self.port}
motd={self.name}
level-type=default
online-mode=false
spawn-protection=0
view-distance=10
enable-command-block=false
"""
            with open(os.path.join(self.path, "server.properties"), "w") as f:
                f.write(server_props)
            
            # eula.txt - natychmiast
            with open(os.path.join(self.path, "eula.txt"), "w") as f:
                f.write("eula=true\\n")
            
            # start.sh - natychmiast
            start_script = f"""#!/bin/bash
cd "{self.path}"
java -Xmx{self.ram} -Xms1G -jar server.jar nogui
"""
            with open(os.path.join(self.path, "start.sh"), "w") as f:
                f.write(start_script)
            os.chmod(os.path.join(self.path, "start.sh"), 0o755)
            
            # Pozosta≈Çe pliki - natychmiast
            for filename, content in [
                ("ops.json", "[]"),
                ("whitelist.json", "[]"),
                ("banned-ips.json", "[]"),
                ("banned-players.json", "[]"),
                ("usercache.json", "[]")
            ]:
                with open(os.path.join(self.path, filename), "w") as f:
                    f.write(content + "\\n")
            
            self.files_created = True
            return True
            
        except Exception as e:
            print(f"B≈ÇƒÖd tworzenia plik√≥w: {e}")
            return False
        
    def download_server_jar_fast(self):
        """Szybkie pobieranie server.jar"""
        jar_path = os.path.join(self.path, "server.jar")
        if os.path.exists(jar_path):
            return True
            
        if self.version not in MINECRAFT_VERSIONS:
            return False
            
        try:
            url = MINECRAFT_VERSIONS[self.version]
            urllib.request.urlretrieve(url, jar_path)
            return os.path.exists(jar_path)
                
        except Exception as e:
            print(f"B≈ÇƒÖd pobierania: {e}")
            return False
    
    def setup_server_files_instant(self):
        """Natychmiastowa konfiguracja wszystkich plik√≥w"""
        try:
            # 1. Tworzenie folderu
            if not os.path.exists(self.path):
                os.makedirs(self.path, exist_ok=True)
            
            # 2. Natychmiastowe tworzenie plik√≥w
            if not self.create_essential_files_instant():
                return False
                
            # 3. Szybkie pobieranie server.jar
            if not self.download_server_jar_fast():
                return False
                
            return True
            
        except Exception as e:
            print(f"B≈ÇƒÖd konfiguracji: {e}")
            return False
    
    def start(self):
        """Natychmiastowe uruchomienie z auto-plikami"""
        if self.status != "stopped":
            return False
            
        try:
            # NATYCHMIASTOWE WGRANIE PLIK√ìW
            self.add_console("‚ö° NATYCHMIASTOWE TWORZENIE PLIK√ìW...")
            
            if not self.setup_server_files_instant():
                self.add_console("‚ùå B≈ÇƒÖd tworzenia plik√≥w")
                return False
            
            self.add_console("‚úÖ WSZYSTKIE PLIKI UTWORZONE!")
            self.add_console("üî• URUCHAMIANIE SERWERA...")
            
            # Uruchom proces Java
            cmd = f"cd {self.path} && java -Xmx{self.ram} -Xms1G -jar server.jar nogui"
            self.process = subprocess.Popen(
                cmd,
                shell=True,
                stdin=subprocess.PIPE,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                universal_newlines=True,
                bufsize=1
            )
            
            self.status = "starting"
            self.start_time = datetime.now()
            
            # WƒÖtek do odczytu konsoli
            threading.Thread(target=self._read_console, daemon=True).start()
            
            return True
            
        except Exception as e:
            self.add_console(f"‚ùå B≈ÅƒÑD: {e}")
            return False
    
    def stop(self):
        """Zatrzymuje serwer"""
        if self.status != "running" or not self.process:
            return False
            
        try:
            self.add_console("üõë Zatrzymywanie serwera...")
            self.send_command("stop")
            
            for i in range(10):
                if self.process.poll() is not None:
                    break
                time.sleep(1)
            
            if self.process.poll() is None:
                self.process.terminate()
                time.sleep(2)
                if self.process.poll() is None:
                    self.process.kill()
            
            self.status = "stopped"
            self.players = []
            self.add_console("‚úÖ Serwer zatrzymany")
            return True
            
        except Exception as e:
            self.add_console(f"‚ùå B≈ÇƒÖd zatrzymywania: {e}")
            return False
    
    def send_command(self, command):
        """Wysy≈Ça komendƒô do konsoli serwera"""
        if self.process and self.process.poll() is None:
            try:
                self.process.stdin.write(command + "\\n")
                self.process.stdin.flush()
                self.add_console(f"> {command}")
                return True
            except:
                return False
        return False
    
    def _read_console(self):
        """Czyta output z konsoli serwera"""
        while self.process and self.process.poll() is None:
            try:
                line = self.process.stdout.readline()
                if line:
                    line = line.strip()
                    if line:
                        self._process_console_output(line)
            except:
                break
        
        if self.status == "running":
            self.status = "stopped"
            self.add_console("üí• Serwer zosta≈Ç zamkniƒôty")
    
    def _process_console_output(self, line):
        """Przetwarza output z konsoli"""
        self.add_console(line)
        
        if "Done" in line and "For help, type \"help\"" in line:
            self.status = "running"
            self.add_console("üéâ SERWER GOTOWY!")
            self.add_console(f"üåê localhost:{self.port}")
            
        elif "joined the game" in line:
            player = line.split("]")[1].split(" joined the game")[0].strip()
            if player not in self.players:
                self.players.append(player)
                self.add_console(f"üë§ {player} do≈ÇƒÖczy≈Ç")
                
        elif "left the game" in line:
            player = line.split("]")[1].split(" left the game")[0].strip()
            if player in self.players:
                self.players.remove(player)
                self.add_console(f"üë§ {player} opu≈õci≈Ç")
    
    def add_console(self, message):
        """Dodaje wiadomo≈õƒá do konsoli"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        full_message = f"[{timestamp}] {message}"
        self.console_buffer.append(full_message)
        
        if len(self.console_buffer) > 500:
            self.console_buffer = self.console_buffer[-500:]
        
        for callback in self.console_callbacks:
            callback(full_message)
    
    def get_console(self, lines=100):
        """Pobiera ostatnie linie konsoli"""
        return "\\n".join(self.console_buffer[-lines:])
    
    def get_players(self):
        """Zwraca listƒô graczy"""
        return self.players
    
    def get_uptime(self):
        """Zwraca czas dzia≈Çania"""
        if self.start_time and self.status == "running":
            uptime = datetime.now() - self.start_time
            hours = int(uptime.total_seconds() // 3600)
            minutes = int((uptime.total_seconds() % 3600) // 60)
            seconds = int(uptime.total_seconds() % 60)
            return f"{hours:02d}:{minutes:02d}:{seconds:02d}"
        return "00:00:00"

class ServerManager:
    def __init__(self):
        self.servers_data = []
        self.real_servers = {}
        self.load_servers()
    
    def load_servers(self):
        try:
            with open("/home/purplehost/bazy/serwery.json", "r") as f:
                self.servers_data = json.load(f)
        except:
            self.servers_data = []
    
    def save_servers(self):
        with open("/home/purplehost/bazy/serwery.json", "w") as f:
            json.dump(self.servers_data, f, indent=2)
    
    def get_next_port(self):
        base_port = 25565
        used_ports = [s.get('port', 0) for s in self.servers_data]
        while base_port in used_ports:
            base_port += 1
        return base_port
    
    def create_server(self, name, version, ram="2G"):
        server_id = len(self.servers_data) + 1
        port = self.get_next_port()
        
        folder_name = name.replace(" ", "_").lower()
        server_path = f"/home/purplehost/serwery/minecraft/{folder_name}"
        os.makedirs(server_path, exist_ok=True)
        
        server_data = {
            "id": server_id,
            "name": name,
            "version": version,
            "ram": ram,
            "port": port,
            "status": "stopped",
            "players": "0/20",
            "created": datetime.now().isoformat(),
            "uptime": "00:00:00",
            "path": server_path,
            "folder": folder_name
        }
        
        real_server = RealMinecraftServer(server_id, name, version, ram, port, server_path)
        self.real_servers[server_id] = real_server
        
        self.servers_data.append(server_data)
        self.save_servers()
        
        return server_data
    
    def start_server(self, server_id):
        if server_id in self.real_servers:
            server = self.real_servers[server_id]
            if server.start():
                self._update_server_data(server_id)
                return True
        return False
    
    def stop_server(self, server_id):
        if server_id in self.real_servers:
            server = self.real_servers[server_id]
            if server.stop():
                self._update_server_data(server_id)
                return True
        return False
    
    def send_command(self, server_id, command):
        if server_id in self.real_servers:
            return self.real_servers[server_id].send_command(command)
        return False
    
    def get_console(self, server_id, lines=100):
        if server_id in self.real_servers:
            return self.real_servers[server_id].get_console(lines)
        return "Serwer nieaktywny"
    
    def get_server_files(self, server_id, path=""):
        server = self.get_server(server_id)
        if not server:
            return []
        
        base_path = server["path"]
        if path:
            target_path = os.path.join(base_path, path)
        else:
            target_path = base_path
        
        if not os.path.exists(target_path):
            return []
        
        files = []
        for item in os.listdir(target_path):
            item_path = os.path.join(target_path, item)
            rel_path = os.path.join(path, item) if path else item
            
            files.append({
                "name": item,
                "path": rel_path,
                "is_directory": os.path.isdir(item_path),
                "size": os.path.getsize(item_path) if os.path.isfile(item_path) else 0,
                "modified": os.path.getmtime(item_path)
            })
        
        return sorted(files, key=lambda x: (not x["is_directory"], x["name"]))
    
    def _update_server_data(self, server_id):
        if server_id in self.real_servers:
            real_server = self.real_servers[server_id]
            
            for server_data in self.servers_data:
                if server_data["id"] == server_id:
                    server_data["status"] = real_server.status
                    server_data["players"] = f"{len(real_server.players)}/20"
                    server_data["uptime"] = real_server.get_uptime()
                    break
            
            self.save_servers()
    
    def get_server(self, server_id):
        for server in self.servers_data:
            if server["id"] == server_id:
                return server
        return None
    
    def get_all_servers(self):
        for server_id in self.real_servers:
            self._update_server_data(server_id)
        
        return self.servers_data

# Globalna instancja
server_manager = ServerManager()
PYTHON
    echo -e "${GREEN}‚úÖ Backend utworzony${NC}"
}

# =============================================
# üåê PANEL WEB - NATYCHMIASTOWE DZIA≈ÅANIE
# =============================================

create_web_panel() {
    echo -e "${PURPLE}üåê Tworzenie panelu web z natychmiastowym dzia≈Çaniem...${NC}"
    
    cat > "$WEB_DIR/index.html" << 'HTML'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ PurpleHost - Natychmiastowe Serwery</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --secondary: #06D6A0;
            --accent: #FF6B6B;
            --dark: #1E1B2E;
            --darker: #151321;
            --light: #F8FAFC;
            --gray: #64748B;
        }
        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        .logo {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.3s;
            font-size: 0.9rem;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--secondary), #05C189);
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--accent), #FF5252);
        }
        .servers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .server-card {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1.5rem;
            transition: transform 0.3s;
        }
        .server-card:hover {
            transform: translateY(-5px);
        }
        .server-status {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-online {
            background: rgba(6, 214, 160, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(6, 214, 160, 0.3);
        }
        .status-offline {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
        }
        .modal-content {
            background: var(--dark);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            margin: 1% auto;
            padding: 0;
            width: 98%;
            height: 98vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
        }
        .modal-body {
            padding: 1.5rem;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .console-container {
            background: #000;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            flex: 1;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .console-output {
            color: #00ff00;
            white-space: pre-wrap;
            line-height: 1.4;
            min-height: 100%;
        }
        .console-input {
            display: flex;
            gap: 0.5rem;
        }
        .console-input input {
            flex: 1;
            padding: 0.75rem;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .management-panel {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.5rem;
            height: 100%;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .info-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1.5rem;
        }
        .info-box h4 {
            margin-bottom: 1rem;
            color: var(--secondary);
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .quick-actions {
            display: grid;
            gap: 0.5rem;
        }
        .file-manager {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .file-item:hover {
            background: rgba(255,255,255,0.1);
        }
        .connection-info {
            background: rgba(6, 214, 160, 0.1);
            border: 1px solid rgba(6, 214, 160, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-bolt"></i>
                PurpleHost
            </div>
            <h1>‚ö° Natychmiastowe Serwery Minecraft</h1>
            <p>Kliknij "Start" - pliki tworzƒÖ siƒô NATYCHMIAST!</p>
        </div>

        <div style="text-align: center; margin-bottom: 2rem;">
            <button class="btn" onclick="showCreateServer()">
                <i class="fas fa-plus"></i> Nowy Serwer
            </button>
        </div>

        <div class="servers-grid" id="serversContainer">
            <!-- Serwery bƒôdƒÖ ≈Çadowane tutaj -->
        </div>
    </div>

    <!-- Modal tworzenia serwera -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üéÆ Utw√≥rz Nowy Serwer</h3>
                <span onclick="closeModal('createModal')" style="cursor:pointer;font-size:1.5rem;">&times;</span>
            </div>
            <div class="modal-body">
                <div style="max-width: 500px; margin: 0 auto;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem;">Nazwa serwera:</label>
                        <input type="text" id="serverName" placeholder="np. M√≥j Serwer" style="width:100%; padding:0.75rem; border-radius:6px; border:1px solid #333; background:#1a1a1a; color:white;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem;">Wersja Minecraft:</label>
                        <select id="serverVersion" style="width:100%; padding:0.75rem; border-radius:6px; border:1px solid #333; background:#1a1a1a; color:white;">
                            <option value="1.20.1">1.20.1</option>
                            <option value="1.19.4">1.19.4</option>
                            <option value="1.18.2">1.18.2</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem;">RAM:</label>
                        <select id="serverRAM" style="width:100%; padding:0.75rem; border-radius:6px; border:1px solid #333; background:#1a1a1a; color:white;">
                            <option value="2G">2 GB</option>
                            <option value="4G">4 GB</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:1rem; justify-content:flex-end;">
                        <button class="btn" onclick="closeModal('createModal')">Anuluj</button>
                        <button class="btn btn-success" onclick="createServer()">
                            <i class="fas fa-plus"></i> Utw√≥rz
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üéÆ PANEL Z KONSOLƒÑ -->
    <div id="manageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-terminal"></i>
                    Panel: <span id="serverNameTitle">Serwer</span>
                    <span id="serverStatusBadge" class="server-status status-offline" style="margin-left: 1rem; font-size: 0.8rem;">OFFLINE</span>
                </h3>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn btn-success" id="startBtn" onclick="startServerInstant()">
                        <i class="fas fa-play"></i> Start
                    </button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopServer()" style="display:none;">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button class="btn" onclick="refreshManager()">
                        <i class="fas fa-sync"></i>
                    </button>
                    <span onclick="closeModal('manageModal')" style="cursor:pointer;font-size:1.5rem; margin-left: 1rem;">&times;</span>
                </div>
            </div>
            
            <div class="modal-body">
                <div class="management-panel">
                    <!-- KONSOLA -->
                    <div class="main-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4><i class="fas fa-terminal"></i> Konsola - Live</h4>
                            <small style="color: var(--secondary);">‚ö° Natychmiastowe dzia≈Çanie</small>
                        </div>
                        <div class="console-container">
                            <div class="console-output" id="consoleOutput">
üöÄ PurpleHost - Natychmiastowe Uruchamianie
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Gotowy do dzia≈Çania! Kliknij "Start" aby:
‚Ä¢ Natychmiast utworzyƒá pliki
‚Ä¢ Pobraƒá server.jar  
‚Ä¢ Uruchomiƒá serwer

Dzia≈Çanie w czasie rzeczywistym - bez oczekiwania!
                            </div>
                        </div>
                        <div class="console-input">
                            <input type="text" id="consoleInput" placeholder="Wpisz komendƒô i naci≈õnij Enter">
                            <button class="btn" onclick="sendCommand()">
                                <i class="fas fa-paper-plane"></i> Wy≈õlij
                            </button>
                        </div>
                    </div>

                    <!-- PANEL BOCZNY -->
                    <div class="sidebar">
                        <!-- STATUS -->
                        <div class="info-box">
                            <h4>üìä Status</h4>
                            <div class="info-item">
                                <span>Status:</span>
                                <span id="statusText" style="color: var(--accent);">OFFLINE</span>
                            </div>
                            <div class="info-item">
                                <span>Gracze:</span>
                                <span id="playersText">0/20</span>
                            </div>
                            <div class="info-item">
                                <span>Uptime:</span>
                                <span id="uptimeText">00:00:00</span>
                            </div>
                            <div class="info-item">
                                <span>Port:</span>
                                <span id="portText">25565</span>
                            </div>
                        </div>

                        <!-- AKCJE -->
                        <div class="info-box">
                            <h4>‚ö° Akcje</h4>
                            <div class="quick-actions">
                                <button class="btn" onclick="sendQuickCommand('say Witaj!')">
                                    <i class="fas fa-bullhorn"></i> Powitanie
                                </button>
                                <button class="btn" onclick="sendQuickCommand('list')">
                                    <i class="fas fa-list"></i> Gracze
                                </button>
                                <button class="btn" onclick="sendQuickCommand('time set day')">
                                    <i class="fas fa-sun"></i> Dzie≈Ñ
                                </button>
                            </div>
                        </div>

                        <!-- PLIKI -->
                        <div class="info-box">
                            <h4>üìÅ Pliki</h4>
                            <div class="file-manager" id="fileManager">
                                <div style="text-align: center; color: var(--gray); padding: 1rem;">
                                    <i class="fas fa-folder-plus"></i><br>
                                    Kliknij Start
                                </div>
                            </div>
                        </div>

                        <!-- INFO -->
                        <div class="connection-info">
                            <h4>üåê Jak graƒá?</h4>
                            <p>1. Kliknij "Start"</p>
                            <p>2. Poczekaj na "Done" w konsoli</p>
                            <p>3. Minecraft ‚Üí Multiplayer</p>
                            <p>4. Adres: <strong id="serverAddress">localhost:25565</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentServerId = null;
        let consoleInterval = null;
        let statusInterval = null;

        // API
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch('/api' + endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                return await response.json();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                return null;
            }
        }

        // ≈Åadowanie serwer√≥w
        async function loadServers() {
            const servers = await apiRequest('/servers');
            if (!servers) return;

            const container = document.getElementById('serversContainer');
            
            if (servers.length === 0) {
                container.innerHTML = `
                    <div class="server-card" style="text-align: center; grid-column: 1 / -1;">
                        <h3>üéÆ Brak serwer√≥w</h3>
                        <p>Utw√≥rz pierwszy serwer!</p>
                        <button class="btn" onclick="showCreateServer()" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Utw√≥rz Serwer
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = servers.map(server => `
                <div class="server-card">
                    <h3>${server.name}</h3>
                    <p>üéÆ ${server.version} ‚Ä¢ üíæ ${server.ram}</p>
                    <p>üåê Port: ${server.port} ‚Ä¢ üë• ${server.players}</p>
                    <p>‚è±Ô∏è ${server.uptime}</p>
                    <span class="server-status ${server.status === 'running' ? 'status-online' : 'status-offline'}">
                        ${server.status === 'running' ? 'üü¢ ONLINE' : 'üî¥ OFFLINE'}
                    </span>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn ${server.status === 'running' ? 'btn-danger' : 'btn-success'}" 
                                onclick="${server.status === 'running' ? `stopServerFromList(${server.id})` : `startServerFromList(${server.id})`}">
                            <i class="fas fa-${server.status === 'running' ? 'stop' : 'play'}"></i>
                            ${server.status === 'running' ? 'Stop' : 'Start'}
                        </button>
                        <button class="btn" onclick="manageServer(${server.id})">
                            <i class="fas fa-cog"></i> ZarzƒÖdzaj
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function createServer() {
            const name = document.getElementById('serverName').value;
            const version = document.getElementById('serverVersion').value;
            const ram = document.getElementById('serverRAM').value;

            if (!name) {
                alert('Podaj nazwƒô serwera');
                return;
            }

            const server = await apiRequest('/servers', {
                method: 'POST',
                body: JSON.stringify({ name, version, ram })
            });

            if (server) {
                alert('üéâ Serwer utworzony!');
                closeModal('createModal');
                loadServers();
            }
        }

        function showCreateServer() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'manageModal') {
                clearInterval(consoleInterval);
                clearInterval(statusInterval);
                currentServerId = null;
            }
        }

        function startServerFromList(serverId) {
            apiRequest('/servers/' + serverId + '/start');
            setTimeout(loadServers, 2000);
        }

        function stopServerFromList(serverId) {
            apiRequest('/servers/' + serverId + '/stop');
            setTimeout(loadServers, 2000);
        }

        // üöÄ NATYCHMIASTOWE URUCHOMIENIE
        async function manageServer(serverId) {
            currentServerId = serverId;
            const servers = await apiRequest('/servers');
            const server = servers.find(s => s.id === serverId);
            
            if (!server) return;

            document.getElementById('serverNameTitle').textContent = server.name;
            document.getElementById('serverAddress').textContent = `localhost:${server.port}`;
            
            updateServerStatus(server);
            updateConsole();
            loadFiles();

            clearInterval(consoleInterval);
            clearInterval(statusInterval);
            consoleInterval = setInterval(updateConsole, 1000);
            statusInterval = setInterval(updateServerInfo, 2000);

            document.getElementById('manageModal').style.display = 'block';
        }

        async function updateServerInfo() {
            if (!currentServerId) return;
            const servers = await apiRequest('/servers');
            const server = servers.find(s => s.id === currentServerId);
            if (server) {
                updateServerStatus(server);
            }
        }

        function updateServerStatus(server) {
            document.getElementById('statusText').textContent = server.status === 'running' ? 'ONLINE' : 'OFFLINE';
            document.getElementById('statusText').style.color = server.status === 'running' ? 'var(--secondary)' : 'var(--accent)';
            document.getElementById('playersText').textContent = server.players;
            document.getElementById('uptimeText').textContent = server.uptime;
            document.getElementById('portText').textContent = server.port;
            
            document.getElementById('startBtn').style.display = server.status === 'running' ? 'none' : 'flex';
            document.getElementById('stopBtn').style.display = server.status === 'running' ? 'flex' : 'none';
            
            const badge = document.getElementById('serverStatusBadge');
            badge.textContent = server.status === 'running' ? 'üü¢ ONLINE' : 'üî¥ OFFLINE';
            badge.className = server.status === 'running' ? 'server-status status-online' : 'server-status status-offline';
        }

        async function updateConsole() {
            if (!currentServerId) return;
            const output = await apiRequest('/servers/' + currentServerId + '/console');
            const consoleOutput = document.getElementById('consoleOutput');
            if (output && output !== consoleOutput.textContent) {
                consoleOutput.textContent = output;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }

        async function sendCommand() {
            if (!currentServerId) return;
            const input = document.getElementById('consoleInput');
            const command = input.value.trim();
            
            if (command) {
                await apiRequest('/servers/' + currentServerId + '/command', {
                    method: 'POST',
                    body: JSON.stringify({ command })
                });
                input.value = '';
                setTimeout(updateConsole, 500);
            }
        }

        function sendQuickCommand(command) {
            if (!currentServerId) return;
            document.getElementById('consoleInput').value = command;
            sendCommand();
        }

        async function loadFiles() {
            if (!currentServerId) return;
            const files = await apiRequest('/servers/' + currentServerId + '/files');
            
            const fileManager = document.getElementById('fileManager');
            if (!files || files.length === 0) {
                fileManager.innerHTML = `
                    <div style="text-align: center; color: var(--gray); padding: 1rem;">
                        <i class="fas fa-folder-plus"></i><br>
                        Brak plik√≥w
                    </div>
                `;
                return;
            }

            fileManager.innerHTML = files.map(file => `
                <div class="file-item">
                    <i class="fas fa-${file.is_directory ? 'folder' : 'file'}"></i>
                    <span>${file.name}</span>
                </div>
            `).join('');
        }

        // ‚ö° NATYCHMIASTOWE URUCHOMIENIE SERWERA
        async function startServerInstant() {
            if (!currentServerId) return;
            
            // Natychmiastowa informacja w konsoli
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.textContent = `‚ö° ROZPOCZƒòCIE NATYCHMIASTOWEJ KONFIGURACJI...
            
üìõ Serwer: ${document.getElementById('serverNameTitle').textContent}
üåê Port: ${document.getElementById('portText').textContent}
üíæ RAM: ${document.getElementById('ramText').textContent}

üîÑ TWORZENIE PLIK√ìW...`;

            // Natychmiastowe wywo≈Çanie API
            await apiRequest('/servers/' + currentServerId + '/start');
            
            // Natychmiastowe od≈õwie≈ºenie
            setTimeout(updateServerInfo, 1000);
            setTimeout(loadServers, 2000);
            setTimeout(loadFiles, 1500);
        }

        async function stopServer() {
            if (!currentServerId) return;
            await apiRequest('/servers/' + currentServerId + '/stop');
            setTimeout(updateServerInfo, 1000);
            setTimeout(loadServers, 2000);
        }

        function refreshManager() {
            updateConsole();
            loadFiles();
            updateServerInfo();
        }

        // Auto-od≈õwie≈ºanie
        loadServers();
        setInterval(loadServers, 5000);

        // Enter w konsoli
        document.getElementById('consoleInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendCommand();
        });

        // ESC zamyka modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal('manageModal');
                closeModal('createModal');
            }
        });
    </script>
</body>
</html>
HTML
    echo -e "${GREEN}‚úÖ Panel web utworzony${NC}"
}

# =============================================
# üîÑ SERWER WEB
# =============================================

create_web_server() {
    echo -e "${PURPLE}üöÄ Tworzenie serwera web...${NC}"
    
    cat > "$WEB_DIR/server.py" << 'PYTHON'
#!/usr/bin/env python3
import http.server
import socketserver
import os
import json
import urllib.parse
from api import server_manager

PORT = 8080
WEB_DIR = "/home/purplehost/web"

class Handler(http.server.SimpleHTTPRequestHandler):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, directory=WEB_DIR, **kwargs)
    
    def do_GET(self):
        if self.path.startswith('/api/'):
            self.handle_api()
        else:
            if self.path == '/':
                self.path = '/index.html'
            super().do_GET()
    
    def do_POST(self):
        if self.path.startswith('/api/'):
            self.handle_api()
        else:
            self.send_error(404)
    
    def handle_api(self):
        try:
            path_parts = self.path.split('/')
            
            if len(path_parts) >= 3 and path_parts[2] == 'servers':
                if len(path_parts) == 3:
                    if self.command == 'GET':
                        self.send_json(server_manager.get_all_servers())
                    elif self.command == 'POST':
                        content_length = int(self.headers['Content-Length'])
                        body = self.rfile.read(content_length).decode()
                        data = json.loads(body)
                        server = server_manager.create_server(**data)
                        self.send_json(server, 201)
                
                elif len(path_parts) >= 4:
                    server_id = int(path_parts[3])
                    
                    if len(path_parts) == 4:
                        if self.command == 'GET':
                            server = server_manager.get_server(server_id)
                            if server:
                                self.send_json(server)
                            else:
                                self.send_error(404)
                    
                    elif len(path_parts) == 5:
                        action = path_parts[4]
                        
                        if action == 'start':
                            if self.command == 'POST':
                                if server_manager.start_server(server_id):
                                    self.send_json({'success': True})
                                else:
                                    self.send_json({'error': 'Server not found'}, 404)
                        
                        elif action == 'stop':
                            if self.command == 'POST':
                                if server_manager.stop_server(server_id):
                                    self.send_json({'success': True})
                                else:
                                    self.send_json({'error': 'Server not found'}, 404)
                        
                        elif action == 'console':
                            if self.command == 'GET':
                                console_output = server_manager.get_console(server_id)
                                self.send_json(console_output)
                        
                        elif action == 'files':
                            if self.command == 'GET':
                                query = urllib.parse.urlparse(self.path).query
                                params = urllib.parse.parse_qs(query)
                                path = params.get('path', [''])[0]
                                files = server_manager.get_server_files(server_id, path)
                                self.send_json(files)
                    
                    elif len(path_parts) == 6 and path_parts[4] == 'command':
                        if self.command == 'POST':
                            content_length = int(self.headers['Content-Length'])
                            body = self.rfile.read(content_length).decode()
                            data = json.loads(body)
                            command = data.get('command', '')
                            if command:
                                success = server_manager.send_command(server_id, command)
                                self.send_json({'success': success})
                            else:
                                self.send_json({'error': 'No command'}, 400)
                
                else:
                    self.send_error(404)
            else:
                self.send_error(404)
                
        except Exception as e:
            self.send_json({'error': str(e)}, 500)
    
    def send_json(self, data, status=200):
        self.send_response(status)
        self.send_header('Content-type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data).encode())
    
    def log_message(self, format, *args):
        print(f"üåê {self.address_string()} - {format % args}")

print(f"üöÄ PurpleHost starting on http://localhost:{PORT}")
print("‚ö° NATYCHMIASTOWE SERWERY MINECRAFT")
print("üìÅ Serving from:", WEB_DIR)

os.chdir(WEB_DIR)

try:
    with socketserver.TCPServer(("", PORT), Handler) as httpd:
        print("‚úÖ Server ready!")
        print("‚èπÔ∏è  Press Ctrl+C to stop")
        httpd.serve_forever()
except OSError as e:
    print(f"‚ùå Error: {e}")
    if "Address already in use" in str(e):
        print("üí° Port 8080 zajƒôty. Zmie≈Ñ PORT w skrypcie.")
PYTHON

    chmod +x "$WEB_DIR/server.py"
    chmod +x "$WEB_DIR/api.py"
    echo -e "${GREEN}‚úÖ Serwer web utworzony${NC}"
}

# =============================================
# üöÄ URUCHOMIENIE SYSTEMU
# =============================================

start_system() {
    echo -e "${PURPLE}üöÄ Uruchamianie PurpleHost...${NC}"
    
    # Zatrzymaj istniejƒÖce serwery
    pkill -f "server.py" 2>/dev/null
    sleep 2
    
    # Uruchom
    cd "$WEB_DIR"
    nohup python3 server.py > "$LOG_DIR/web_server.log" 2>&1 &
    
    sleep 3
    
    if ps -p $! >/dev/null 2>&1; then
        echo -e "${GREEN}üéâ PURPLEHOST DZIA≈ÅA!${NC}"
        echo ""
        echo -e "${CYAN}üåê Adres panelu: http://localhost:8080${NC}"
        echo -e "${CYAN}‚ö° NATYCHMIASTOWE WGRYWANIE PLIK√ìW${NC}"
        echo ""
        echo -e "${YELLOW}üìù Jak u≈ºywaƒá:${NC}"
        echo "1. Wejd≈∫ na http://localhost:8080"
        echo "2. Utw√≥rz serwer Minecraft"
        echo "3. Kliknij 'ZarzƒÖdzaj' ‚Üí 'Start'"
        echo "4. Pliki tworzƒÖ siƒô NATYCHMIAST!"
        echo "5. Serwer uruchamia siƒô od razu"
        
        if [ -n "$DISPLAY" ]; then
            xdg-open "http://localhost:8080" 2>/dev/null &
        fi
        
        # Pokazuj logi
        tail -f "$LOG_DIR/web_server.log"
    else
        echo -e "${RED}‚ùå B≈ÇƒÖd uruchamiania${NC}"
        cat "$LOG_DIR/web_server.log"
    fi
}

# =============================================
# üìú MAIN
# =============================================

clear
echo -e "${PURPLE}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë          üöÄ PURPLEHOST PRO           ‚ïë"
echo "‚ïë      Natychmiastowe Serwery MC       ‚ïë"
echo "‚ïë         ‚ö° BEZ Oczekiwania!          ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"

create_structure
check_dependencies
create_backend
create_web_panel
create_web_server
start_system
