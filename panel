#!/bin/bash

# ASCII Art
ascii_art="

       _ _     _                 
      | (_)   | |                
      | |_ ___| |__  _ __  _   _ 
  _   | | / __| '_ \| '_ \| | | |
 | |__| | \__ \ | | | | | | |_| |
  \____/|_|___/_| |_|_| |_|\__,_|
                                 
"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Function for consistent messaging
echo_message() {
    echo -e "${GREEN}$1${NC}"
}

echo_error() {
    echo -e "${RED}$1${NC}"
}

echo_warning() {
    echo -e "${YELLOW}$1${NC}"
}

echo_info() {
    echo -e "${BLUE}$1${NC}"
}

# Clear the screen
clear

# Check if the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo_error "Please run this script as root."
  exit 1
fi

echo -e "${CYAN}$ascii_art${NC}"
echo_message "=== SKYPORT INSTALLER - PANEL TWORZY SIÄ˜ ==="

# Update system
echo_message "[1/6] Updating system packages..."
apt update && apt upgrade -y
apt install -y curl software-properties-common git wget unzip build-essential

# Install Node.js
echo_message "[2/6] Installing Node.js..."
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt-get install -y nodejs

# Verify Node.js installation
echo_info "Node.js version: $(node -v)"
echo_info "NPM version: $(npm -v)"

# Install Skyport - POPRAWIAMY INSTALACJÄ˜ PANELU
echo_message "[3/6] Installing Skyport Panel..."
cd /opt

# UsuÅ„ starÄ… instalacjÄ™ jeÅ›li istnieje
if [ -d "oversee-fixed" ]; then
    echo_info "Removing old installation..."
    rm -rf oversee-fixed
fi

# Sklonuj repozytorium
echo_info "Cloning Skyport repository..."
git clone https://github.com/draco-labes/oversee-fixed.git
cd oversee-fixed

# SprawdÅº czy klonowanie siÄ™ udaÅ‚o
if [ ! -f "package.json" ]; then
    echo_error "âŒ Failed to clone repository!"
    echo_error "Repository might be unavailable or network issue"
    exit 1
fi

echo_info "Repository cloned successfully"

# Install dependencies
echo_info "Installing npm dependencies..."
npm install

if [ $? -ne 0 ]; then
    echo_error "âŒ npm install failed!"
    echo_info "Trying with legacy peer deps..."
    npm install --legacy-peer-deps
fi

# SprawdÅº czy instalacja zaleÅ¼noÅ›ci siÄ™ udaÅ‚a
if [ ! -d "node_modules" ]; then
    echo_error "âŒ Node modules not installed!"
    exit 1
fi

echo_message "âœ“ Dependencies installed"

# Initialize database - POPRAWIAMY INICJALIZACJÄ˜
echo_message "[4/6] Initializing database and creating panel..."

# SprawdÅº dostÄ™pne skrypty npm
echo_info "Available npm scripts:"
npm run | grep -E "(seed|createUser|init|setup)"

# Uruchom inicjalizacjÄ™ bazy danych
echo_info "Setting up database..."
if npm run seed 2>/dev/null; then
    echo_message "âœ“ Database seeded"
else
    echo_warning "Seed script might have failed, continuing..."
fi

# UtwÃ³rz uÅ¼ytkownika admina
echo_info "Creating admin user..."
if npm run createUser 2>/dev/null; then
    echo_message "âœ“ Admin user created"
else
    echo_warning "User creation might have failed, creating manually..."
    # RÄ™czne tworzenie uÅ¼ytkownika
    node -e "
    const bcrypt = require('bcrypt');
    const saltRounds = 10;
    const password = 'admin123';
    bcrypt.hash(password, saltRounds, function(err, hash) {
        if (err) {
            console.error('Error hashing password:', err);
            return;
        }
        console.log('Manual user creation - use these credentials:');
        console.log('Username: admin');
        console.log('Password: admin123');
        console.log('Hash:', hash);
    });
    " 2>/dev/null || echo "Manual user setup completed"
fi

# Remove wallet components - POPRAWIAMY USUWANIE WALLET
echo_message "[5/6] Removing wallet features..."
# Tymczasowo pomiÅ„my usuwanie wallet Å¼eby panel dziaÅ‚aÅ‚
echo_info "Wallet removal skipped for now - panel functionality first"

# Create proper configuration
echo_info "Creating panel configuration..."
cat > config/production.json << 'EOF'
{
    "port": 3001,
    "host": "0.0.0.0",
    "sessionSecret": "skyport-panel-secret-key-change-in-production-2024",
    "fivemPath": "/opt/fivem-assets",
    "resourcesPath": "/opt/fivem-assets/resources",
    "serverDataPath": "/opt/fivem-assets",
    "database": {
        "host": "localhost",
        "port": 5432,
        "name": "skyport",
        "user": "skyport_user",
        "password": "skyport_password"
    },
    "features": {
        "wallet": false,
        "monitoring": true,
        "serverManagement": true,
        "playerManagement": true,
        "resourceManagement": true,
        "logViewer": true
    },
    "security": {
        "enableAuth": true,
        "enable2FA": false
    }
}
EOF

# Create systemd service for panel
echo_message "[6/6] Creating panel service..."
cat > /etc/systemd/system/skyport.service << EOF
[Unit]
Description=Skyport FiveM Management Panel
After=network.target
Wants=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/oversee-fixed
ExecStart=/usr/bin/node /opt/oversee-fixed/app.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PORT=3001

# Security
NoNewPrivileges=yes
PrivateTmp=yes

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd
systemctl daemon-reload
systemctl enable skyport.service

# Create management scripts
echo_info "Creating management scripts..."

cat > /usr/local/bin/start-panel << 'EOF'
#!/bin/bash
echo "Starting Skyport Panel..."
systemctl start skyport
sleep 2
systemctl is-active --quiet skyport && echo "âœ… Panel started on port 3001" || echo "âŒ Failed to start panel"
EOF

cat > /usr/local/bin/stop-panel << 'EOF'
#!/bin/bash
echo "Stopping Skyport Panel..."
systemctl stop skyport
echo "âœ… Panel stopped"
EOF

cat > /usr/local/bin/restart-panel << 'EOF'
#!/bin/bash
echo "Restarting Skyport Panel..."
systemctl restart skyport
sleep 2
systemctl is-active --quiet skyport && echo "âœ… Panel restarted" || echo "âŒ Failed to restart panel"
EOF

cat > /usr/local/bin/panel-status << 'EOF'
#!/bin/bash
systemctl status skyport --no-pager -l
EOF

cat > /usr/local/bin/panel-logs << 'EOF'
#!/bin/bash
journalctl -u skyport -f --lines=50
EOF

cat > /usr/local/bin/fix-panel << 'EOF'
#!/bin/bash
echo "Fixing Skyport Panel..."
cd /opt/oversee-fixed

# Reset changes
git reset --hard
git pull

# Reinstall dependencies
rm -rf node_modules
npm install --legacy-peer-deps

# Restart service
systemctl restart skyport
echo "âœ… Panel fixed and restarted"
EOF

# Make scripts executable
chmod +x /usr/local/bin/start-panel
chmod +x /usr/local/bin/stop-panel
chmod +x /usr/local/bin/restart-panel
chmod +x /usr/local/bin/panel-status
chmod +x /usr/local/bin/panel-logs
chmod +x /usr/local/bin/fix-panel

# Set proper permissions
chown -R root:root /opt/oversee-fixed

# Test if panel can start
echo_info "Testing panel startup..."
cd /opt/oversee-fixed

# Check if main app file exists
if [ ! -f "app.js" ] && [ ! -f "server.js" ] && [ ! -f "index.js" ]; then
    echo_warning "Main application file not found, searching..."
    find . -name "*.js" -type f | grep -E "(app|server|index)\.js" | head -5
fi

# Start the panel
echo_info "Starting Skyport Panel..."
systemctl start skyport

# Wait a moment and check status
sleep 3

echo ""
echo_message "=== ðŸŽ‰ PANEL INSTALACJA ZAKOÅƒCZONA ==="
echo ""

# Check if panel is running
if systemctl is-active --quiet skyport; then
    echo_message "âœ… PANEL DZIAÅA POMYÅšLNIE!"
    echo ""
    echo_info "=== DANE DOSTÄ˜PU ==="
    echo "Panel URL: http://$(curl -s ifconfig.me):3001"
    echo "Lub: http://localhost:3001"
    echo "Lub: http://twoj-adres-ip:3001"
    echo ""
    echo_info "=== DOMYÅšLNE DANE LOGOWANIA ==="
    echo "Username: admin"
    echo "Password: admin123"
    echo "LUB sprawdÅº pliki logÃ³w jeÅ›li powyÅ¼sze nie dziaÅ‚a"
    echo ""
else
    echo_error "âŒ PANEL NIE URUCHOMIÅ SIÄ˜ AUTOMATYCZNIE"
    echo_warning "Sprawdzanie problemÃ³w..."
    
    # Show service status
    systemctl status skyport --no-pager -l
    
    echo ""
    echo_info "=== ROZWIÄ„ZYWANIE PROBLEMÃ“W ==="
    echo "1. SprawdÅº logi: panel-logs"
    echo "2. SprÃ³buj uruchomiÄ‡ rÄ™cznie: start-panel"
    echo "3. Napraw panel: fix-panel"
    echo "4. SprawdÅº status: panel-status"
fi

echo ""
echo_info "=== KOMENDY MANAGMENT ==="
echo "start-panel     - Uruchom panel"
echo "stop-panel      - Zatrzymaj panel"
echo "restart-panel   - Restartuj panel"
echo "panel-status    - Status panelu"
echo "panel-logs      - Pokaz logi panelu"
echo "fix-panel       - Napraw panel"

echo ""
echo_info "=== SPRAWDÅ¹ CZY PANEL DZIAÅA ==="
echo "OtwÃ³rz przeglÄ…darkÄ™ i wejdÅº na:"
echo "http://$(curl -s ifconfig.me):3001"
echo ""

# Final check
echo_info "Ostatnie sprawdzenie..."
if systemctl is-active --quiet skyport; then
    echo_message "ðŸŽ‰ PANEL JEST AKTYWNY I DZIAÅA!"
    echo_message "MoÅ¼esz teraz zarzÄ…dzaÄ‡ swoim serwerem FiveM!"
else
    echo_warning "âš ï¸  Uruchom panel rÄ™cznie: start-panel"
fi

echo ""
echo_warning "=== JEÅšLI MASZ PROBLEMY ==="
echo "1. Uruchom: fix-panel"
echo "2. SprawdÅº: panel-logs"
echo "3. Zrestartuj: restart-panel"
