#!/bin/bash

# =============================================
# üü£ PURPLEHOST - PE≈ÅNY PANEL WEB
# =============================================

# Konfiguracja
PANEL_DIR="/home/purplehost"
WEB_DIR="$PANEL_DIR/web"
SERVER_DIR="$PANEL_DIR/serwery"
DB_DIR="$PANEL_DIR/bazy"
BACKUP_DIR="$PANEL_DIR/backupy"
LOG_DIR="$PANEL_DIR/logs"
PORT=8080

# Kolory
PURPLE='\033[0;35m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================
# üõ†Ô∏è FUNKCJE POMOCNICZE
# =============================================

log() {
    echo -e "${PURPLE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_DIR/panel.log"
}

error() {
    echo -e "${RED}‚ùå $1${NC}"
    log "B≈ÅƒÑD: $1"
}

setup_directories() {
    echo -e "${PURPLE}üìÅ Tworzenie struktur katalog√≥w...${NC}"
    mkdir -p "$PANEL_DIR" "$WEB_DIR" "$SERVER_DIR" "$DB_DIR" "$BACKUP_DIR" "$LOG_DIR"
    mkdir -p "$SERVER_DIR/minecraft" "$SERVER_DIR/backups"
    
    # Tworzenie bazy danych
    cat > "$DB_DIR/serwery.json" << 'EOF'
[]
EOF
    
    log "Struktura katalog√≥w PurpleHost utworzona"
}

check_dependencies() {
    echo -e "${PURPLE}üîç Sprawdzanie zale≈ºno≈õci...${NC}"
    
    if ! command -v python3 &> /dev/null; then
        echo -e "${YELLOW}üì¶ Instalowanie Pythona 3...${NC}"
        apt update > /dev/null 2>&1
        apt install -y python3 python3-pip > /dev/null 2>&1
    fi
    
    echo -e "${GREEN}‚úÖ Wszystkie zale≈ºno≈õci sƒÖ dostƒôpne${NC}"
}

# =============================================
# üêç BACKEND API Z KONSOLƒÑ I PLIKAMI
# =============================================

create_backend_api() {
    echo -e "${PURPLE}üîß Tworzenie backend API z konsolƒÖ...${NC}"
    
    cat > "$WEB_DIR/api.py" << 'PYTHON'
#!/usr/bin/env python3
import json
import os
import subprocess
import shutil
from datetime import datetime
import threading
import time
import glob

# Konfiguracja
PANEL_DIR = "/home/purplehost"
SERVER_DIR = f"{PANEL_DIR}/serwery"
DB_FILE = f"{PANEL_DIR}/bazy/serwery.json"
BACKUP_DIR = f"{PANEL_DIR}/backupy"
LOG_DIR = f"{PANEL_DIR}/logs"

class ServerManager:
    def __init__(self):
        self.ensure_directories()
        self.load_servers()
        self.console_buffers = {}  # Bufor konsoli dla ka≈ºdego serwera
        self.command_history = {}  # Historia komend
    
    def ensure_directories(self):
        os.makedirs(SERVER_DIR, exist_ok=True)
        os.makedirs(BACKUP_DIR, exist_ok=True)
        os.makedirs(LOG_DIR, exist_ok=True)
    
    def load_servers(self):
        try:
            with open(DB_FILE, 'r') as f:
                self.servers = json.load(f)
        except:
            self.servers = []
    
    def save_servers(self):
        with open(DB_FILE, 'w') as f:
            json.dump(self.servers, f, indent=2)
    
    def get_next_port(self):
        base_port = 25565
        used_ports = [s.get('port', 0) for s in self.servers]
        while base_port in used_ports:
            base_port += 1
        return base_port
    
    def create_server(self, name, type, version, ram="2GB"):
        server_id = len(self.servers) + 1
        port = self.get_next_port()
        
        server_data = {
            "id": server_id,
            "name": name,
            "type": type,
            "version": version,
            "ram": ram,
            "port": port,
            "status": "stopped",
            "players": "0/20",
            "created": datetime.now().isoformat(),
            "last_start": None,
            "uptime": "0s",
            "path": f"{SERVER_DIR}/minecraft/{name.replace(' ', '_')}",
            "log_file": f"{LOG_DIR}/server_{server_id}.log",
            "console_buffer": []
        }
        
        # Inicjalizacja bufora konsoli
        self.console_buffers[server_id] = []
        self.command_history[server_id] = []
        
        # Tworzenie katalogu serwera
        server_path = server_data["path"]
        os.makedirs(server_path, exist_ok=True)
        
        # Tworzenie plik√≥w serwera Minecraft
        self.create_minecraft_files(server_path, version, port, name, ram)
        
        # Tworzenie pliku log
        with open(server_data["log_file"], "w") as f:
            f.write(f"=== PurpleHost Server Log ===\\n")
            f.write(f"Server: {name}\\n")
            f.write(f"Created: {datetime.now()}\\n")
            f.write(f"Type: {type} {version}\\n")
            f.write(f"Port: {port}\\n")
            f.write(f"RAM: {ram}\\n\\n")
        
        self.servers.append(server_data)
        self.save_servers()
        
        return server_data
    
    def create_minecraft_files(self, server_path, version, port, name, ram):
        # server.properties
        with open(f"{server_path}/server.properties", "w") as f:
            f.write(f"""# Minecraft Server Properties
# Generated by PurpleHost
max-players=20
online-mode=false
level-type=default
server-port={port}
enable-command-block=true
motd=PurpleHost - {name}
view-distance=10
spawn-protection=0
level-name=world
""")
        
        # eula.txt
        with open(f"{server_path}/eula.txt", "w") as f:
            f.write("#By changing the setting below to TRUE you are indicating your agreement to our EULA (https://aka.ms/MinecraftEULA).\\n")
            f.write("eula=true\\n")
        
        # start.sh
        with open(f"{server_path}/start.sh", "w") as f:
            f.write(f"""#!/bin/bash
echo "Starting Minecraft Server {name}"
echo "Version: {version}"
echo "Port: {port}"
echo "RAM: {ram}"
echo "Started at: $(date)"
java -Xmx{ram} -jar server.jar nogui
""")
        os.chmod(f"{server_path}/start.sh", 0o755)
        
        # server info
        with open(f"{server_path}/server_info.txt", "w") as f:
            f.write(f"PurpleHost Server Information\\n")
            f.write(f"Name: {name}\\n")
            f.write(f"Version: {version}\\n")
            f.write(f"Port: {port}\\n")
            f.write(f"RAM: {ram}\\n")
            f.write(f"Created: {datetime.now()}\\n")
            f.write(f"Path: {server_path}\\n")
        
        # Przyk≈Çadowe pliki
        with open(f"{server_path}/ops.json", "w") as f:
            f.write("[]\\n")
        
        with open(f"{server_path}/whitelist.json", "w") as f:
            f.write("[]\\n")
        
        # Tworzenie przyk≈Çadowego ≈õwiata
        world_dir = f"{server_path}/world"
        os.makedirs(world_dir, exist_ok=True)
        with open(f"{world_dir}/level.dat", "w") as f:
            f.write("Minecraft world data - PurpleHost\\n")
    
    def start_server(self, server_id):
        server = self.get_server(server_id)
        if server and server["status"] == "stopped":
            server["status"] = "starting"
            server["last_start"] = datetime.now().isoformat()
            self.save_servers()
            
            # Dodaj do konsoli
            self.add_console_output(server_id, "[SYSTEM] Uruchamianie serwera...")
            
            # Symulacja uruchamiania serwera
            def simulate_start():
                time.sleep(2)
                self.add_console_output(server_id, "[SYSTEM] Serwer uruchomiony pomy≈õlnie!")
                self.add_console_output(server_id, "[SYSTEM] Gotowy na po≈ÇƒÖczenia graczy")
                server["status"] = "online"
                server["players"] = "0/20"
                self.save_servers()
                
                # Symulacja aktywno≈õci
                def simulate_activity():
                    messages = [
                        "Gracz Steve do≈ÇƒÖczy≈Ç do gry",
                        "Gracz Alex do≈ÇƒÖczy≈Ç do gry", 
                        "Steve znalaz≈Ç diament!",
                        "Alex zbudowa≈Ç dom",
                        "Noc zapada w ≈õwiecie...",
                        "Steve opu≈õci≈Ç grƒô",
                        "Alex opu≈õci≈Ç grƒô"
                    ]
                    message_index = 0
                    
                    while server["status"] == "online":
                        time.sleep(15)
                        if message_index < len(messages):
                            self.add_console_output(server_id, f"[GAME] {messages[message_index]}")
                            message_index += 1
                            
                            # Aktualizuj graczy
                            if "do≈ÇƒÖczy≈Ç" in messages[message_index-1]:
                                current = int(server["players"].split('/')[0])
                                server["players"] = f"{min(current + 1, 20)}/20"
                            elif "opu≈õci≈Ç" in messages[message_index-1]:
                                current = int(server["players"].split('/')[0])
                                server["players"] = f"{max(current - 1, 0)}/20"
                            self.save_servers()
                
                activity_thread = threading.Thread(target=simulate_activity)
                activity_thread.daemon = True
                activity_thread.start()
            
            thread = threading.Thread(target=simulate_start)
            thread.daemon = True
            thread.start()
            
            self.log_event(server_id, "SERVER_STARTED", "Server starting up...")
            return True
        return False
    
    def stop_server(self, server_id):
        server = self.get_server(server_id)
        if server and server["status"] == "online":
            server["status"] = "stopping"
            self.save_servers()
            
            self.add_console_output(server_id, "[SYSTEM] Zatrzymywanie serwera...")
            
            # Symulacja zatrzymywania
            def simulate_stop():
                time.sleep(2)
                self.add_console_output(server_id, "[SYSTEM] Serwer zatrzymany")
                server["status"] = "stopped"
                server["players"] = "0/20"
                self.save_servers()
                self.log_event(server_id, "SERVER_STOPPED", "Server stopped gracefully")
            
            thread = threading.Thread(target=simulate_stop)
            thread.daemon = True
            thread.start()
            return True
        return False
    
    def execute_command(self, server_id, command):
        server = self.get_server(server_id)
        if server:
            # Zapisz komendƒô w historii
            if server_id not in self.command_history:
                self.command_history[server_id] = []
            self.command_history[server_id].append(command)
            
            # Symuluj wykonanie komendy
            self.add_console_output(server_id, f"> {command}")
            
            # Odpowiedzi na komendy
            responses = {
                "help": "Dostƒôpne komendy: help, list, time, say <message>, tp <player>",
                "list": "Gracze online (0/20): ",
                "time": "Czas gry: 1200 (Day)",
                "version": "PurpleHost Minecraft Server 1.20.1",
                "stop": "U≈ºyj przycisku Stop w panelu",
                "reload": "Prze≈Çadowanie konfiguracji..."
            }
            
            if command in responses:
                self.add_console_output(server_id, f"[SERVER] {responses[command]}")
            elif command.startswith("say "):
                message = command[4:]
                self.add_console_output(server_id, f"[SERVER] {message}")
            elif command.startswith("tp "):
                self.add_console_output(server_id, f"[SERVER] Teleportowanie...")
            else:
                self.add_console_output(server_id, f"[SERVER] Nieznana komenda: {command}")
            
            return True
        return False
    
    def add_console_output(self, server_id, message):
        if server_id not in self.console_buffers:
            self.console_buffers[server_id] = []
        
        timestamp = datetime.now().strftime("%H:%M:%S")
        full_message = f"[{timestamp}] {message}"
        self.console_buffers[server_id].append(full_message)
        
        # Ogranicz bufor do 1000 wiadomo≈õci
        if len(self.console_buffers[server_id]) > 1000:
            self.console_buffers[server_id] = self.console_buffers[server_id][-1000:]
    
    def get_console_output(self, server_id, lines=50):
        if server_id in self.console_buffers:
            return "\\n".join(self.console_buffers[server_id][-lines:])
        return "Brak danych konsoli"
    
    def get_command_history(self, server_id):
        return self.command_history.get(server_id, [])
    
    def get_server_files(self, server_id, path=""):
        server = self.get_server(server_id)
        if not server:
            return []
        
        base_path = server["path"]
        if path:
            target_path = os.path.join(base_path, path)
        else:
            target_path = base_path
        
        if not os.path.exists(target_path):
            return []
        
        files = []
        try:
            for item in os.listdir(target_path):
                item_path = os.path.join(target_path, item)
                rel_path = os.path.join(path, item) if path else item
                
                files.append({
                    "name": item,
                    "path": rel_path,
                    "is_directory": os.path.isdir(item_path),
                    "size": os.path.getsize(item_path) if os.path.isfile(item_path) else 0,
                    "modified": os.path.getmtime(item_path)
                })
        except:
            pass
        
        return sorted(files, key=lambda x: (not x["is_directory"], x["name"]))
    
    def get_file_content(self, server_id, file_path):
        server = self.get_server(server_id)
        if not server:
            return None
        
        full_path = os.path.join(server["path"], file_path)
        if not os.path.exists(full_path) or not os.path.isfile(full_path):
            return None
        
        try:
            with open(full_path, 'r', encoding='utf-8', errors='ignore') as f:
                return f.read()
        except:
            return None
    
    def save_file_content(self, server_id, file_path, content):
        server = self.get_server(server_id)
        if not server:
            return False
        
        full_path = os.path.join(server["path"], file_path)
        try:
            os.makedirs(os.path.dirname(full_path), exist_ok=True)
            with open(full_path, 'w', encoding='utf-8') as f:
                f.write(content)
            return True
        except:
            return False
    
    def delete_server(self, server_id):
        server = self.get_server(server_id)
        if server:
            # Tworzenie backupu
            backup_info = self.create_backup(server_id)
            
            # Usuwanie katalogu serwera
            server_path = server["path"]
            if os.path.exists(server_path):
                shutil.rmtree(server_path)
            
            # Usuwanie logu
            if os.path.exists(server["log_file"]):
                os.remove(server["log_file"])
            
            # Czyszczenie bufor√≥w
            if server_id in self.console_buffers:
                del self.console_buffers[server_id]
            if server_id in self.command_history:
                del self.command_history[server_id]
            
            self.servers = [s for s in self.servers if s["id"] != server_id]
            self.save_servers()
            
            self.log_event(server_id, "SERVER_DELETED", f"Server deleted. Backup: {backup_info['backup_name']}")
            return True
        return False
    
    def create_backup(self, server_id):
        server = self.get_server(server_id)
        if server:
            backup_time = datetime.now().strftime("%Y%m%d_%H%M%S")
            backup_name = f"{server['name'].replace(' ', '_')}_{backup_time}"
            backup_path = f"{BACKUP_DIR}/{backup_name}"
            
            os.makedirs(backup_path, exist_ok=True)
            
            # Symulacja backupu
            with open(f"{backup_path}/backup.info", "w") as f:
                f.write(f"PurpleHost Backup\\n")
                f.write(f"Server: {server['name']}\\n")
                f.write(f"Backup Time: {datetime.now()}\\n")
                f.write(f"Size: Simulated backup\\n")
            
            backup_info = {
                "server_id": server_id,
                "server_name": server["name"],
                "backup_name": backup_name,
                "backup_time": datetime.now().isoformat(),
                "backup_path": backup_path
            }
            
            with open(f"{backup_path}/backup_info.json", "w") as f:
                json.dump(backup_info, f, indent=2)
            
            self.log_event(server_id, "BACKUP_CREATED", f"Backup created: {backup_name}")
            return backup_info
        return None
    
    def get_server_logs(self, server_id, lines=50):
        server = self.get_server(server_id)
        if server and os.path.exists(server["log_file"]):
            with open(server["log_file"], "r") as f:
                all_lines = f.readlines()
                return "".join(all_lines[-lines:])
        return "Brak log√≥w"
    
    def log_event(self, server_id, event_type, message):
        server = self.get_server(server_id)
        if server:
            log_entry = f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] {event_type}: {message}\\n"
            with open(server["log_file"], "a") as f:
                f.write(log_entry)
    
    def get_server(self, server_id):
        for server in self.servers:
            if server["id"] == server_id:
                return server
        return None
    
    def get_all_servers(self):
        # Aktualizuj uptime dla dzia≈ÇajƒÖcych serwer√≥w
        for server in self.servers:
            if server["status"] == "online" and server["last_start"]:
                start_time = datetime.fromisoformat(server["last_start"])
                uptime = datetime.now() - start_time
                hours = int(uptime.total_seconds() // 3600)
                minutes = int((uptime.total_seconds() % 3600) // 60)
                server["uptime"] = f"{hours}h {minutes}m"
        
        return self.servers

# Globalna instancja managera
server_manager = ServerManager()
PYTHON

    echo -e "${GREEN}‚úÖ Backend API z konsolƒÖ utworzony${NC}"
}

# =============================================
# üåê PANEL WEB Z KONSOLƒÑ I PLIKAMI
# =============================================

create_web_panel() {
    echo -e "${PURPLE}üåê Tworzenie panelu web z konsolƒÖ...${NC}"
    
    # G≈Ç√≥wna strona
    cat > "$WEB_DIR/index.html" << 'HTML'
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ PurpleHost ‚Ä¢ Panel z KonsolƒÖ i Plikami</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --primary-light: #A78BFA;
            --secondary: #06D6A0;
            --accent: #FF6B6B;
            --dark: #1E1B2E;
            --darker: #151321;
            --light: #F8FAFC;
            --gray: #64748B;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .tagline {
            color: var(--gray);
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--light);
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-tab:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--primary);
            box-shadow: var(--shadow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pozosta≈Çe style (dashboard, stats, cards) pozostajƒÖ takie same */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--light) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #05C189 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent) 0%, #FF5252 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%);
            color: white;
        }

        .servers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .server-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .server-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .server-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .server-info h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--light);
        }

        .server-type {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .server-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-online {
            background: rgba(6, 214, 160, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(6, 214, 160, 0.3);
        }

        .status-offline {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .status-starting {
            background: rgba(255, 171, 64, 0.2);
            color: #FFAB40;
            border: 1px solid rgba(255, 171, 64, 0.3);
        }

        .server-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-label {
            color: var(--gray);
            font-size: 0.8rem;
        }

        .detail-value {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .server-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .server-actions .btn {
            flex: 1;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            min-width: 80px;
        }

        /* Style dla zarzƒÖdzania serwerem */
        .server-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 1024px) {
            .server-management {
                grid-template-columns: 1fr;
            }
        }

        .console-container {
            background: var(--darker);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .console-output {
            color: var(--light);
            line-height: 1.4;
        }

        .console-input {
            display: flex;
            gap: 0.5rem;
        }

        .console-input input {
            flex: 1;
            padding: 0.75rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--light);
            font-family: 'Courier New', monospace;
        }

        .console-input input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .file-manager {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
        }

        .file-list {
            list-style: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .file-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .file-icon {
            width: 20px;
            text-align: center;
            color: var(--primary-light);
        }

        .file-name {
            flex: 1;
            color: var(--light);
        }

        .file-size {
            color: var(--gray);
            font-size: 0.8rem;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .file-content {
            background: var(--darker);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 1rem;
        }

        .file-editor-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            color: var(--gray);
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            color: var(--light);
        }

        .breadcrumb-separator {
            color: var(--gray);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--light);
        }

        .empty-state p {
            color: var(--gray);
            margin-bottom: 2rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            backdrop-filter: blur(20px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--light);
        }

        .close {
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--light);
        }

        .modal-body {
            padding: 2rem;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--light);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
        }

        .notification.success {
            background: var(--secondary);
        }

        .notification.error {
            background: var(--accent);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .logo {
                font-size: 2rem;
            }

            .servers-grid {
                grid-template-columns: 1fr;
            }

            .server-actions {
                flex-direction: column;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .modal-content {
                margin: 5% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-rocket"></i>
                PurpleHost
            </div>
            <div class="tagline">Panel z konsolƒÖ i mened≈ºerem plik√≥w</div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showTab('dashboard')">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div class="nav-tab" onclick="showTab('servers')">
                    <i class="fas fa-server"></i> Moje Serwery
                </div>
                <div class="nav-tab" onclick="showTab('create')">
                    <i class="fas fa-plus"></i> Nowy Serwer
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 1.5rem;">üìä Podsumowanie Systemu</h2>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-server"></i>
                    </div>
                    <div class="stat-value" id="totalServers">0</div>
                    <div class="stat-label">Wszystkie Serwery</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="stat-value" id="onlineServers">0</div>
                    <div class="stat-label">Serwery Online</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="totalPlayers">0</div>
                    <div class="stat-label">Gracze Online</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-memory"></i>
                    </div>
                    <div class="stat-value" id="totalRAM">0GB</div>
                    <div class="stat-label">Zu≈ºycie RAM</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="showTab('create')">
                    <i class="fas fa-plus"></i> Utw√≥rz Nowy Serwer
                </button>
            </div>
        </div>

        <!-- Serwery Tab -->
        <div id="servers" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>üéÆ Moje Serwery</h2>
                <button class="btn btn-primary" onclick="showTab('create')">
                    <i class="fas fa-plus"></i> Nowy Serwer
                </button>
            </div>

            <div id="serversContainer">
                <!-- Serwery bƒôdƒÖ ≈Çadowane dynamicznie -->
            </div>
        </div>

        <!-- Tworzenie serwera Tab -->
        <div id="create" class="tab-content">
            <h2 style="margin-bottom: 1.5rem;">üõ†Ô∏è Tworzenie Nowego Serwera</h2>
            
            <div style="max-width: 500px; margin: 0 auto;">
                <form id="createServerForm">
                    <div class="form-group">
                        <label for="serverName">
                            <i class="fas fa-font"></i> Nazwa serwera:
                        </label>
                        <input type="text" id="serverName" placeholder="np. M√≥j Super Serwer" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="serverType">
                            <i class="fas fa-cube"></i> Typ serwera:
                        </label>
                        <select id="serverType" required>
                            <option value="Minecraft">Minecraft Java Edition</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="serverVersion">
                            <i class="fas fa-code-branch"></i> Wersja:
                        </label>
                        <select id="serverVersion" required>
                            <option value="1.20.1">1.20.1 (Latest)</option>
                            <option value="1.19.4">1.19.4</option>
                            <option value="1.18.2">1.18.2</option>
                            <option value="1.17.1">1.17.1</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="serverRAM">
                            <i class="fas fa-memory"></i> Pamiƒôƒá RAM:
                        </label>
                        <select id="serverRAM">
                            <option value="1GB">1 GB</option>
                            <option value="2GB" selected>2 GB</option>
                            <option value="4GB">4 GB</option>
                            <option value="8GB">8 GB</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="showTab('servers')" style="background: var(--glass);">
                            <i class="fas fa-arrow-left"></i> Wr√≥ƒá
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Utw√≥rz Serwer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal zarzƒÖdzania serwerem -->
    <div id="manageServerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manageServerTitle">üéÆ ZarzƒÖdzanie Serwerem</h3>
                <span class="close" onclick="closeModal('manageServerModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="server-management">
                    <!-- Konsola -->
                    <div>
                        <h4 style="margin-bottom: 1rem;">üñ•Ô∏è Konsola Serwera</h4>
                        <div class="console-container">
                            <div class="console-output" id="consoleOutput">
                                ≈Åadowanie konsoli...
                            </div>
                        </div>
                        <div class="console-input">
                            <input type="text" id="consoleInput" placeholder="Wpisz komendƒô (np. help, list)...">
                            <button class="btn btn-primary" onclick="sendConsoleCommand()">
                                <i class="fas fa-paper-plane"></i> Wy≈õlij
                            </button>
                        </div>
                    </div>

                    <!-- Pliki -->
                    <div>
                        <h4 style="margin-bottom: 1rem;">üìÅ Mened≈ºer Plik√≥w</h4>
                        <div class="file-manager">
                            <div class="breadcrumb" id="fileBreadcrumb">
                                <div class="breadcrumb-item" onclick="navigateToFolder('')">/</div>
                            </div>
                            <div id="fileListContainer">
                                ≈Åadowanie plik√≥w...
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-success" id="startServerBtn" onclick="startCurrentServer()">
                        <i class="fas fa-play"></i> Start Serwer
                    </button>
                    <button class="btn btn-danger" id="stopServerBtn" onclick="stopCurrentServer()">
                        <i class="fas fa-stop"></i> Stop Serwer
                    </button>
                    <button class="btn btn-warning" onclick="refreshServerManager()">
                        <i class="fas fa-sync"></i> Od≈õwie≈º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal edytora plik√≥w -->
    <div id="fileEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="fileEditorTitle">üìù Edytor Plik√≥w</h3>
                <span class="close" onclick="closeModal('fileEditorModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="fileNameLabel">Plik:</label>
                    <div class="file-content" id="fileEditorContent" contenteditable="true"></div>
                </div>
                <div class="file-editor-actions">
                    <button class="btn" onclick="closeModal('fileEditorModal')">Anuluj</button>
                    <button class="btn btn-primary" onclick="saveFileContent()">Zapisz</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Zmienne globalne
        let allServers = [];
        let currentServerId = null;
        let currentFolder = '';
        let consoleInterval = null;
        let currentEditingFile = '';

        // API functions
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`/api${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                return await response.json();
            } catch (error) {
                showNotification('B≈ÇƒÖd po≈ÇƒÖczenia z serwerem', 'error');
                console.error('API Error:', error);
                return null;
            }
        }

        // Server management
        async function loadServers() {
            const servers = await apiRequest('/servers');
            if (servers) {
                allServers = servers;
                renderServers();
                updateStats();
            }
        }

        async function createServer(serverData) {
            const result = await apiRequest('/servers', {
                method: 'POST',
                body: JSON.stringify(serverData)
            });
            
            if (result) {
                showNotification('üéâ Serwer utworzony pomy≈õlnie!', 'success');
                showTab('servers');
                loadServers();
            }
        }

        async function startServer(serverId) {
            const result = await apiRequest(`/servers/${serverId}/start`, {
                method: 'POST'
            });
            
            if (result) {
                showNotification('üöÄ Uruchamianie serwera...', 'success');
                setTimeout(loadServers, 3000);
            }
        }

        async function stopServer(serverId) {
            const result = await apiRequest(`/servers/${serverId}/stop`, {
                method: 'POST'
            });
            
            if (result) {
                showNotification('üõë Zatrzymywanie serwera...', 'success');
                setTimeout(loadServers, 3000);
            }
        }

        async function deleteServer(serverId) {
            if (confirm('‚ö†Ô∏è Czy na pewno chcesz usunƒÖƒá ten serwer? Zostanie utworzony backup.')) {
                const result = await apiRequest(`/servers/${serverId}`, {
                    method: 'DELETE'
                });
                
                if (result) {
                    showNotification('üóëÔ∏è Serwer usuniƒôty', 'success');
                    loadServers();
                }
            }
        }

        // Console functions
        async function getConsoleOutput(serverId) {
            const result = await apiRequest(`/servers/${serverId}/console`);
            if (result) {
                return result;
            }
            return "Brak danych konsoli";
        }

        async function sendConsoleCommand() {
            const input = document.getElementById('consoleInput');
            const command = input.value.trim();
            
            if (command && currentServerId) {
                const result = await apiRequest(`/servers/${currentServerId}/command`, {
                    method: 'POST',
                    body: JSON.stringify({ command: command })
                });
                
                if (result) {
                    input.value = '';
                    // Od≈õwie≈º konsolƒô po wys≈Çaniu komendy
                    setTimeout(updateConsole, 500);
                }
            }
        }

        async function updateConsole() {
            if (!currentServerId) return;
            
            const output = await getConsoleOutput(currentServerId);
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML = output.replace(/\n/g, '<br>');
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // File manager functions
        async function getServerFiles(serverId, path = '') {
            const result = await apiRequest(`/servers/${serverId}/files?path=${encodeURIComponent(path)}`);
            if (result) {
                return result;
            }
            return [];
        }

        async function loadFileManager(serverId, path = '') {
            currentFolder = path;
            const files = await getServerFiles(serverId, path);
            renderFileList(files);
            updateBreadcrumb(path);
        }

        function renderFileList(files) {
            const container = document.getElementById('fileListContainer');
            
            if (files.length === 0) {
                container.innerHTML = '<div class="empty-state">Brak plik√≥w</div>';
                return;
            }

            container.innerHTML = `
                <ul class="file-list">
                    ${files.map(file => `
                        <li class="file-item" onclick="${file.is_directory ? `navigateToFolder('${file.path}')` : `openFileEditor('${file.path}')`}">
                            <div class="file-icon">
                                <i class="fas fa-${file.is_directory ? 'folder' : 'file'}"></i>
                            </div>
                            <div class="file-name">${file.name}</div>
                            ${!file.is_directory ? `<div class="file-size">${formatFileSize(file.size)}</div>` : ''}
                            <div class="file-actions">
                                ${!file.is_directory ? `<button class="btn" onclick="event.stopPropagation(); openFileEditor('${file.path}')"><i class="fas fa-edit"></i></button>` : ''}
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('fileBreadcrumb');
            const parts = path.split('/').filter(p => p);
            
            let html = '<div class="breadcrumb-item" onclick="navigateToFolder(\'\')">/</div>';
            
            let currentPath = '';
            parts.forEach(part => {
                currentPath += (currentPath ? '/' : '') + part;
                html += `
                    <div class="breadcrumb-separator">/</div>
                    <div class="breadcrumb-item" onclick="navigateToFolder('${currentPath}')">${part}</div>
                `;
            });
            
            breadcrumb.innerHTML = html;
        }

        function navigateToFolder(path) {
            loadFileManager(currentServerId, path);
        }

        async function openFileEditor(filePath) {
            currentEditingFile = filePath;
            const result = await apiRequest(`/servers/${currentServerId}/file?path=${encodeURIComponent(filePath)}`);
            
            if (result) {
                document.getElementById('fileEditorTitle').textContent = `Edytor: ${filePath}`;
                document.getElementById('fileNameLabel').textContent = `Plik: ${filePath}`;
                document.getElementById('fileEditorContent').textContent = result;
                showModal('fileEditorModal');
            }
        }

        async function saveFileContent() {
            const content = document.getElementById('fileEditorContent').textContent;
            const result = await apiRequest(`/servers/${currentServerId}/file`, {
                method: 'POST',
                body: JSON.stringify({
                    path: currentEditingFile,
                    content: content
                })
            });
            
            if (result && result.success) {
                showNotification('‚úÖ Plik zapisany pomy≈õlnie!', 'success');
                closeModal('fileEditorModal');
            } else {
                showNotification('‚ùå B≈ÇƒÖd zapisywania pliku', 'error');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Server manager modal
        function openServerManager(serverId) {
            currentServerId = serverId;
            const server = allServers.find(s => s.id === serverId);
            
            if (server) {
                document.getElementById('manageServerTitle').textContent = `üéÆ ZarzƒÖdzanie: ${server.name}`;
                updateConsole();
                loadFileManager(serverId);
                updateServerButtons(server);
                
                // Uruchom auto-od≈õwie≈ºanie konsoli
                if (consoleInterval) {
                    clearInterval(consoleInterval);
                }
                consoleInterval = setInterval(updateConsole, 2000);
                
                showModal('manageServerModal');
            }
        }

        function updateServerButtons(server) {
            const startBtn = document.getElementById('startServerBtn');
            const stopBtn = document.getElementById('stopServerBtn');
            
            if (server.status === 'online') {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
            } else {
                startBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
            }
        }

        function startCurrentServer() {
            if (currentServerId) {
                startServer(currentServerId);
                setTimeout(() => {
                    const server = allServers.find(s => s.id === currentServerId);
                    if (server) updateServerButtons(server);
                }, 1000);
            }
        }

        function stopCurrentServer() {
            if (currentServerId) {
                stopServer(currentServerId);
                setTimeout(() => {
                    const server = allServers.find(s => s.id === currentServerId);
                    if (server) updateServerButtons(server);
                }, 1000);
            }
        }

        function refreshServerManager() {
            if (currentServerId) {
                updateConsole();
                loadFileManager(currentServerId, currentFolder);
                loadServers();
            }
        }

        // UI functions
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'servers' || tabName === 'dashboard') {
                loadServers();
            }
        }

        function renderServers() {
            const container = document.getElementById('serversContainer');
            
            if (allServers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-server"></i>
                        <h3>Brak serwer√≥w</h3>
                        <p>Utw√≥rz sw√≥j pierwszy serwer Minecraft</p>
                        <button class="btn btn-primary" onclick="showTab('create')">
                            <i class="fas fa-plus"></i> Utw√≥rz Pierwszy Serwer
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="servers-grid">
                    ${allServers.map(server => `
                        <div class="server-card">
                            <div class="server-header">
                                <div class="server-info">
                                    <h3>${server.name}</h3>
                                    <div class="server-type">${server.type} ${server.version} ‚Ä¢ ${server.ram}</div>
                                </div>
                                <div class="server-status ${server.status === 'online' ? 'status-online' : server.status === 'starting' ? 'status-starting' : 'status-offline'}">
                                    ${server.status === 'online' ? 'Online' : server.status === 'starting' ? 'Uruchamianie...' : 'Offline'}
                                </div>
                            </div>
                            
                            <div class="server-details">
                                <div class="detail-item">
                                    <div class="detail-label">Port</div>
                                    <div class="detail-value">${server.port}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Gracze</div>
                                    <div class="detail-value">${server.players}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Czas dzia≈Çania</div>
                                    <div class="detail-value">${server.uptime}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Utworzono</div>
                                    <div class="detail-value">${new Date(server.created).toLocaleDateString('pl-PL')}</div>
                                </div>
                            </div>
                            
                            <div class="server-actions">
                                ${server.status === 'online' ? 
                                    `<button class="btn btn-danger" onclick="stopServer(${server.id})"><i class="fas fa-stop"></i> Stop</button>` : 
                                    `<button class="btn btn-success" onclick="startServer(${server.id})"><i class="fas fa-play"></i> Start</button>`
                                }
                                <button class="btn btn-primary" onclick="openServerManager(${server.id})">
                                    <i class="fas fa-cog"></i> ZarzƒÖdzaj
                                </button>
                                <button class="btn btn-danger" onclick="deleteServer(${server.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateStats() {
            document.getElementById('totalServers').textContent = allServers.length;
            
            const onlineServers = allServers.filter(s => s.status === 'online').length;
            document.getElementById('onlineServers').textContent = onlineServers;
            
            const totalPlayers = allServers.reduce((sum, server) => {
                return sum + parseInt(server.players.split('/')[0]);
            }, 0);
            document.getElementById('totalPlayers').textContent = totalPlayers;
            
            const totalRAM = allServers.reduce((sum, server) => {
                return sum + parseInt(server.ram);
            }, 0);
            document.getElementById('totalRAM').textContent = totalRAM + 'GB';
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'manageServerModal') {
                if (consoleInterval) {
                    clearInterval(consoleInterval);
                    consoleInterval = null;
                }
                currentServerId = null;
                currentFolder = '';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Event listeners
        document.getElementById('createServerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('serverName').value,
                type: document.getElementById('serverType').value,
                version: document.getElementById('serverVersion').value,
                ram: document.getElementById('serverRAM').value
            };
            
            createServer(formData);
            document.getElementById('serverName').value = '';
        });

        document.getElementById('consoleInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendConsoleCommand();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadServers();
            setInterval(loadServers, 10000);
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                if (event.target.id === 'manageServerModal' && consoleInterval) {
                    clearInterval(consoleInterval);
                    consoleInterval = null;
                }
            }
        }
    </script>
</body>
</html>
HTML

    # Rozszerzony serwer Python z konsolƒÖ i plikami
    cat > "$WEB_DIR/server.py" << 'PYTHON'
#!/usr/bin/env python3
import http.server
import socketserver
import os
import json
import urllib.parse
from api import server_manager

PORT = 8080
WEB_DIR = "/home/purplehost/web"

class APIHandler:
    @staticmethod
    def handle_servers(method, path, body):
        if method == 'GET':
            return {
                'status': 200,
                'data': server_manager.get_all_servers()
            }
        
        elif method == 'POST':
            try:
                data = json.loads(body)
                if not data.get('name') or not data.get('type') or not data.get('version'):
                    return {
                        'status': 400,
                        'data': {'error': 'Missing required fields'}
                    }
                
                server = server_manager.create_server(
                    name=data['name'],
                    type=data['type'],
                    version=data['version'],
                    ram=data.get('ram', '2GB')
                )
                return {
                    'status': 201,
                    'data': server
                }
            except Exception as e:
                return {
                    'status': 500,
                    'data': {'error': str(e)}
                }
        
        return {'status': 405, 'data': {'error': 'Method not allowed'}}
    
    @staticmethod
    def handle_server_actions(method, path, body, server_id, action):
        if method == 'POST':
            if action == 'start':
                success = server_manager.start_server(server_id)
                return {
                    'status': 200 if success else 404,
                    'data': {'success': success}
                }
            elif action == 'stop':
                success = server_manager.stop_server(server_id)
                return {
                    'status': 200 if success else 404,
                    'data': {'success': success}
                }
        
        return {'status': 405, 'data': {'error': 'Method not allowed'}}
    
    @staticmethod
    def handle_server_console(method, path, body, server_id):
        if method == 'GET':
            output = server_manager.get_console_output(server_id)
            return {
                'status': 200,
                'data': output
            }
        
        return {'status': 405, 'data': {'error': 'Method not allowed'}}
    
    @staticmethod
    def handle_server_command(method, path, body, server_id):
        if method == 'POST':
            try:
                data = json.loads(body)
                command = data.get('command', '')
                if command:
                    success = server_manager.execute_command(server_id, command)
                    return {
                        'status': 200,
                        'data': {'success': success}
                    }
                return {
                    'status': 400,
                    'data': {'error': 'No command provided'}
                }
            except Exception as e:
                return {
                    'status': 500,
                    'data': {'error': str(e)}
                }
        
        return {'status': 405, 'data': {'error': 'Method not allowed'}}
    
    @staticmethod
    def handle_server_files(method, path, body, server_id):
        from urllib.parse import parse_qs, urlparse
        
        if method == 'GET':
            query = parse_qs(urlparse(path).query)
            file_path = query.get('path', [''])[0]
            files = server_manager.get_server_files(server_id, file_path)
            return {
                'status': 200,
                'data': files
            }
        
        return {'status': 405, 'data': {'error': 'Method not allowed'}}
    
    @staticmethod
    def handle_server_file(method, path, body, server_id):
        from urllib.parse import parse_qs, urlparse
        
        if method == 'GET':
            query = parse_qs(urlparse(path).query)
            file_path = query.get('path', [''])[0]
            content = server_manager.get_file_content(server_id, file_path)
            if content is not None:
                return {
                    'status': 200,
                    'data': content
                }
            return {
                'status': 404,
                'data': {'error': 'File not found'}
            }
        
        elif method == 'POST':
            try:
                data = json.loads(body)
                file_path = data.get('path', '')
                content = data.get('content', '')
                if file_path and content is not None:
                    success = server_manager.save_file_content(server_id, file_path, content)
                    return {
                        'status': 200 if success else 500,
                        'data': {'success': success}
                    }
                return {
                    'status': 400,
                    'data': {'error': 'Missing path or content'}
                }
            except Exception as e:
                return {
                    'status': 500,
                    'data': {'error': str(e)}
                }
        
        return {'status': 405, 'data': {'error': 'Method not allowed'}}
    
    @staticmethod
    def handle_specific_server(method, path, body, server_id):
        if method == 'DELETE':
            success = server_manager.delete_server(server_id)
            return {
                'status': 200 if success else 404,
                'data': {'success': success}
            }
        elif method == 'GET':
            server = server_manager.get_server(server_id)
            if server:
                return {
                    'status': 200,
                    'data': server
                }
            return {
                'status': 404,
                'data': {'error': 'Server not found'}
            }
        
        return {'status': 405, 'data': {'error': 'Method not allowed'}}
    
    @staticmethod
    def handle_server_logs(method, path, body, server_id):
        if method == 'GET':
            logs = server_manager.get_server_logs(server_id)
            return {
                'status': 200,
                'data': logs
            }
        
        return {'status': 405, 'data': {'error': 'Method not allowed'}}

class Handler(http.server.SimpleHTTPRequestHandler):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, directory=WEB_DIR, **kwargs)
    
    def do_GET(self):
        if self.path.startswith('/api/'):
            self.handle_api_request()
        else:
            if self.path == '/':
                self.path = '/index.html'
            super().do_GET()
    
    def do_POST(self):
        if self.path.startswith('/api/'):
            self.handle_api_request()
        else:
            self.send_error(404)
    
    def do_DELETE(self):
        if self.path.startswith('/api/'):
            self.handle_api_request()
        else:
            self.send_error(404)
    
    def handle_api_request(self):
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8') if content_length > 0 else ''
            
            path_parts = self.path.split('/')
            
            # Routing API
            if len(path_parts) >= 3 and path_parts[2] == 'servers':
                if len(path_parts) == 3:
                    # /api/servers
                    response = APIHandler.handle_servers(self.command, self.path, body)
                elif len(path_parts) == 5 and path_parts[4] in ['start', 'stop']:
                    # /api/servers/{id}/start or /api/servers/{id}/stop
                    try:
                        server_id = int(path_parts[3])
                        action = path_parts[4]
                        response = APIHandler.handle_server_actions(self.command, self.path, body, server_id, action)
                    except ValueError:
                        response = {'status': 400, 'data': {'error': 'Invalid server ID'}}
                elif len(path_parts) == 5 and path_parts[4] == 'console':
                    # /api/servers/{id}/console
                    try:
                        server_id = int(path_parts[3])
                        response = APIHandler.handle_server_console(self.command, self.path, body, server_id)
                    except ValueError:
                        response = {'status': 400, 'data': {'error': 'Invalid server ID'}}
                elif len(path_parts) == 5 and path_parts[4] == 'command':
                    # /api/servers/{id}/command
                    try:
                        server_id = int(path_parts[3])
                        response = APIHandler.handle_server_command(self.command, self.path, body, server_id)
                    except ValueError:
                        response = {'status': 400, 'data': {'error': 'Invalid server ID'}}
                elif len(path_parts) == 5 and path_parts[4] == 'files':
                    # /api/servers/{id}/files
                    try:
                        server_id = int(path_parts[3])
                        response = APIHandler.handle_server_files(self.command, self.path, body, server_id)
                    except ValueError:
                        response = {'status': 400, 'data': {'error': 'Invalid server ID'}}
                elif len(path_parts) == 5 and path_parts[4] == 'file':
                    # /api/servers/{id}/file
                    try:
                        server_id = int(path_parts[3])
                        response = APIHandler.handle_server_file(self.command, self.path, body, server_id)
                    except ValueError:
                        response = {'status': 400, 'data': {'error': 'Invalid server ID'}}
                elif len(path_parts) == 5 and path_parts[4] == 'logs':
                    # /api/servers/{id}/logs
                    try:
                        server_id = int(path_parts[3])
                        response = APIHandler.handle_server_logs(self.command, self.path, body, server_id)
                    except ValueError:
                        response = {'status': 400, 'data': {'error': 'Invalid server ID'}}
                elif len(path_parts) == 4:
                    # /api/servers/{id}
                    try:
                        server_id = int(path_parts[3])
                        response = APIHandler.handle_specific_server(self.command, self.path, body, server_id)
                    except ValueError:
                        response = {'status': 400, 'data': {'error': 'Invalid server ID'}}
                else:
                    response = {'status': 404, 'data': {'error': 'Endpoint not found'}}
            else:
                response = {'status': 404, 'data': {'error': 'API endpoint not found'}}
            
            self.send_response(response['status'])
            self.send_header('Content-type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.send_header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
            self.send_header('Access-Control-Allow-Headers', 'Content-Type')
            self.end_headers()
            
            self.wfile.write(json.dumps(response['data']).encode('utf-8'))
            
        except Exception as e:
            self.send_response(500)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({'error': str(e)}).encode('utf-8'))
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def log_message(self, format, *args):
        pass

def start_server():
    os.chdir(WEB_DIR)
    
    try:
        with socketserver.TCPServer(("", PORT), Handler) as httpd:
            print(f"üöÄ PurpleHost Web Panel z konsolƒÖ dzia≈Ça na http://0.0.0.0:{PORT}")
            print(f"üì± Otw√≥rz przeglƒÖdarkƒô: http://localhost:{PORT}")
            print("‚èπÔ∏è  Aby zatrzymaƒá, naci≈õnij Ctrl+C")
            print("\n" + "="*60)
            print("üéØ NOWE FUNKCJE:")
            print("‚Ä¢ üñ•Ô∏è  Konsola serwera w czasie rzeczywistym")
            print("‚Ä¢ üìÅ Mened≈ºer plik√≥w z edytorem")
            print("‚Ä¢ ‚ö° Wysy≈Çanie komend Minecraft")
            print("‚Ä¢ üìä Auto-od≈õwie≈ºanie statystyk")
            print("‚Ä¢ üéÆ Pe≈Çne zarzƒÖdzanie przez przeglƒÖdarkƒô")
            print("="*60 + "\n")
            httpd.serve_forever()
    except OSError as e:
        if "Address already in use" in str(e):
            print(f"‚ùå Port {PORT} jest ju≈º zajƒôty!")
            print("üí° Zatrzymaj inne serwery na tym porcie")
        else:
            raise

if __name__ == "__main__":
    start_server()
PYTHON

    chmod +x "$WEB_DIR/server.py"
    chmod +x "$WEB_DIR/api.py"

    echo -e "${GREEN}‚úÖ Panel web z konsolƒÖ i plikami utworzony!${NC}"
}

start_web_server() {
    echo -e "${PURPLE}üåê Uruchamianie panelu web z konsolƒÖ...${NC}"
    
    pkill -f "server.py"
    sleep 2
    
    cd "$WEB_DIR"
    nohup python3 server.py > "$LOG_DIR/web_server.log" 2>&1 &
    local server_pid=$!
    
    sleep 3
    
    if ps -p $server_pid > /dev/null 2>&1; then
        local ip=$(hostname -I | awk '{print $1}')
        
        echo -e "${GREEN}‚úÖ Panel web z konsolƒÖ uruchomiony!${NC}"
        echo -e "${PURPLE}"
        echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo -e "‚ïë                üöÄ PURPLEHOST PRO                         ‚ïë"
        echo -e "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
        echo -e "‚ïë                                                            ‚ïë"
        echo -e "‚ïë  üåê Adres panelu: http://localhost:$PORT                  ‚ïë"
        echo -e "‚ïë     üåç Lub:       http://$ip:$PORT                        ‚ïë"
        echo -e "‚ïë                                                            ‚ïë"
        echo -e "‚ïë  üéØ TERAZ MASZ KONSOLƒò I PLIKI:                           ‚ïë"
        echo -e "‚ïë     ‚Ä¢ üñ•Ô∏è  Konsola serwera w czasie rzeczywistym          ‚ïë"
        echo -e "‚ïë     ‚Ä¢ ‚ö° Wysy≈Çaj komendy Minecraft (help, list, say)      ‚ïë"
        echo -e "‚ïë     ‚Ä¢ üìÅ PrzeglƒÖdaj pliki serwera                        ‚ïë"
        echo -e "‚ïë     ‚Ä¢ üìù Edytuj pliki konfiguracyjne                     ‚ïë"
        echo -e "‚ïë     ‚Ä¢ üéÆ Pe≈Çna kontrola przez przeglƒÖdarkƒô               ‚ïë"
        echo -e "‚ïë                                                            ‚ïë"
        echo -e "‚ïë  ‚ö° Kliknij 'ZarzƒÖdzaj' przy serwerze!                    ‚ïë"
        echo -e "‚ïë                                                            ‚ïë"
        echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo -e "${NC}"
        
        if [ -n "$DISPLAY" ]; then
            echo -e "${YELLOW}üñ•Ô∏è  Otwieranie przeglƒÖdarki...${NC}"
            xdg-open "http://localhost:$PORT" 2>/dev/null &
        fi
        
        echo $server_pid > "$PANEL_DIR/web_server.pid"
        log "Panel web z konsolƒÖ uruchomiony na porcie $PORT"
        
    else
        error "‚ùå Nie uda≈Ço siƒô uruchomiƒá panelu!"
        echo -e "${YELLOW}üîç Sprawdzanie log√≥w: $LOG_DIR/web_server.log${NC}"
    fi
}

# =============================================
# üìú MAIN SCRIPT
# =============================================

clear

echo -e "${PURPLE}"
echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo -e "‚ïë          üöÄ PURPLEHOST PRO           ‚ïë"
echo -e "‚ïë       Panel z KonsolƒÖ i Plikami      ‚ïë"
echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"
echo -e "${CYAN}Tworzenie zaawansowanego panelu web...${NC}"
echo ""

setup_directories
check_dependencies
create_backend_api
create_web_panel
start_web_server

echo -e "${GREEN}"
echo -e "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo -e "‚ïë                    üéâ SYSTEM GOTOWY!                      ‚ïë"
echo -e "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
echo -e "‚ïë                                                            ‚ïë"
echo -e "‚ïë  Zaawansowany panel PurpleHost jest uruchomiony!          ‚ïë"
echo -e "‚ïë                                                            ‚ïë"
echo -e "‚ïë  üåê Otw√≥rz przeglƒÖdarkƒô: http://localhost:8080            ‚ïë"
echo -e "‚ïë                                                            ‚ïë"
echo -e "‚ïë  üöÄ JAK U≈ªYWAƒÜ KONSOLI I PLIK√ìW:                         ‚ïë"
echo -e "‚ïë     1. Utw√≥rz serwer Minecraft                            ‚ïë"
echo -e "‚ïë     2. Kliknij 'ZarzƒÖdzaj' przy serwerze                  ‚ïë"
echo -e "‚ïë     3. Lewa strona: üñ•Ô∏è  Konsola - pisz komendy!          ‚ïë"
echo -e "‚ïë     4. Prawa strona: üìÅ Pliki - przeglƒÖdaj i edytuj!     ‚ïë"
echo -e "‚ïë     5. U≈ºywaj komend: help, list, say, time              ‚ïë"
echo -e "‚ïë     6. Edytuj server.properties, ops.json                ‚ïë"
echo -e "‚ïë                                                            ‚ïë"
echo -e "‚ïë  üí° Wszystko dzia≈Ça w przeglƒÖdarce - zero instalacji!    ‚ïë"
echo -e "‚ïë                                                            ‚ïë"
echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"

echo -e "${YELLOW}üìù Konsola auto-od≈õwie≈ºa siƒô co 2 sekundy${NC}"
echo -e "${YELLOW}‚èπÔ∏è  Aby zatrzymaƒá panel, naci≈õnij Ctrl+C${NC}"

while true; do
    sleep 10
done
